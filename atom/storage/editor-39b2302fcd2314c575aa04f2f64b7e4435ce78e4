{"mode":"editor","version":1,"windowDimensions":{"x":0,"y":121,"width":1050,"height":1559,"maximized":false},"grammars":{"grammarOverridesByPath":{}},"project":{"deserializer":"Project","paths":["/home/bellahora-04/Bellahora/booking-widget"],"buffers":[{"id":"7903af00fc1c1c2b58562770cbae9a8e","text":"define([\n\t'config',\n\t'plug/css!css/main.css',\n\t'jade!templates/multi',\n\t'jade!templates/list',\n\t'jade!templates/main',\n\t'i19n!locales/main',\n\n\t'core/object',\n\t'core/pubsub',\n\n\t'libs/select',\n\t'libs/icheck',\n\n\t//Mixins added\n\t'mixins/errorHandling',\n\t'mixins/userAuthMixin',\n\n\t//UI Elements\n\t'ui/select-employee',\n\t'ui/resumee-list',\n\t'ui/calendar',\n\t'ui/hour-list',\n\t'ui/wizard'\n], function( Config, CSS, multiTemplate, listTemplate , mainTemplate, i18n, Obj, Pubsub, SelectUI, iCheck, errorHandling, userAuthMixin ) {\n\n\tvar uielements = {};\n\t_.each( Array.prototype.slice.call(arguments, 11) , function( uielement ) {\n\t\tuielements[ uielement.prototype.bhtype ] = uielement;\n\t});\n\n\tfunction formatPrice(price) {\n\t\treturn (parseFloat(price).toFixed(2) + \"€\").replace('.', ',');\n\t}\n\n\tfunction priceTax( price , tax ) {\n\t\treturn formatPrice(Math.round((price || 0) * (1 + ( (tax || 0 )/ 100 ) ) * 100, 2) / 100);\n\t}\n\n\treturn Obj.extend(function( _proto_ ) {\n\n\t\treturn {\n\n\t\t\t$L: i18n,\n\n\t\t\t$load: '/api/portal/'+Config.api+'/place/<%= idaccount %>',\n\t\t\t$groupLoad:'/api/portal/'+Config.api+'/places',\n\n\t\t\t$loadParameters: null,\n\n\t\t\tclassName: 'reserva-ficha',\n\n\t\t\tevents: {\n\t\t\t\t'click .go-to-treats' : 'backToTreats',\n\t\t\t\t'click .go-to-centers' : 'backToCenters',\n\t\t\t\t'click .list-item-treatment' : 'choosenTreatment',\n\t\t\t\t'click .list-item-center' : 'choosenCenter',\n\t\t\t\t'click .submit' : 'submit',\n\t\t\t\t'submit .apply-promo-code': 'applyPromocode',\n\t\t\t\t'click .promo-remove': 'removePromocode',\n\t\t\t\t'ifClicked input[name=wayToPay]': 'choosenWayToPay'\n\t\t\t},\n\n\t\t\tsubscribe: {\n\t\t\t\t'selected-day' \t: 'selectedDay',\n\t\t\t\t'selected-hour' : 'selectedHour',\n\t\t\t\t'selected-employee' : 'selectedEmployee',\n\t\t\t\t'wizard-events' : 'wizardEvents',\n\t\t\t\t'step-ready' \t: 'stepReady'\n\t\t\t},\n\n\t\t\tinitialize: function( config ) {\n\t\t\t\tvar that = this;\n\n\t\t\t\tif( config.target && config.target === 'own' ) {\n\t\t\t\t\tthat.target = config.target;\n\t\t\t\t\tthat.$loadParameters = { treatmentVisibility : 'own' };\n\t\t\t\t}\n\n\t\t\t\tif(config.referer)\n\t\t\t\t\tthat.referer = config.referer;\n\n\t\t\t\tif(config.promocode)\n\t\t\t\t\tthat.promocode = config.promocode;\n\n\t\t\t\tthat.accountGroup = config.accountGroup || \"\";\n\t\t\t\tthat.idtreatment = config.idtreatment  || \"\";\n\t\t\t\tif(config.accountGroup) {\n\t\t\t\t\tthat.selected = {accountGroup: config.accountGroup};\n\t\t\t\t\tthat.template = multiTemplate;\n\t\t\t\t\tthat.$loadParameters = {accountGroup:config.accountGroup};\n\t\t\t\t} else {\n\t\t\t\t\tthat.selected = {\n\t\t\t\t\t\tidcenter: config.idaccount,\n\t\t\t\t\t\ttreatment: config.idtreatment ? [config.idtreatment] : []\n\t\t\t\t\t};\n\t\t\t\t\tthat.template = that.selected.treatment.length > 0 ? mainTemplate : listTemplate;\n\t\t\t\t}\n\n\t\t\t\t_proto_.initialize.apply( this , arguments );\n\n\t\t\t\tthat.UIElements = {};\n\t\t\t},\n\n\t\t\tapplyPromocode: function(e){\n\t\t\t\te.preventDefault();\n\t\t\t\tvar that = this;\n\t\t\t\tvar code = that.$el.find('.input-code').val();\n\t\t\t\tif(!code.trim()) return;\n\t\t\t\t$.ajax( '/api/portal/'+Config.api+'/check-promocode' , {\n\t\t\t\t\tdata \t: {\n\t\t\t\t\t\tcode: code,\n\t\t\t\t\t\tdev:true,\n\t\t\t\t\t\ttreatment:that.selected.treatment[0]\n\t\t\t\t\t},\n\t\t\t\t\tmethod  : 'POST',\n\t\t\t\t\tsuccess : function( data ) {\n\t\t\t\t\t\tif(!data.valid || !data.exist) {\n\t\t\t\t\t\t\tif(window.mixpanel) window.mixpanel.track(\"booking-promocode-novalid\", {\n\t\t\t\t\t\t\t\tpromocode:code,\n\t\t\t\t\t\t\t\ttreatment:that.selected.treatment[0]\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\treturn that.$el.find('.error-code').text(data.error).show();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif(data.exist && data.valid) {\n\n\t\t\t\t\t\t\tif(window.mixpanel) window.mixpanel.track(\"booking-promocode-success\", {\n\t\t\t\t\t\t\t\tpromocode:code,\n\t\t\t\t\t\t\t\ttreatment:that.selected.treatment[0]\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tthat.selected.code = code;\n\t\t\t\t\t\t\tvar form = that.$el.find('.apply-promo-code, .promo-code').hide();\n\t\t\t\t\t\t\tvar newValue = that.getTreatment().pvpDiscount || that.getTreatment().pvp;\n\n\t\t\t\t\t\t\tform.after('<span class=\"success-code\">' + code + ' <i class=\"promo-remove icon-bellahora-web2_cerrar2\"></i></span>');\n\n\t\t\t\t\t\t\tif(data.promocode.type == \"€\") newValue -= data.promocode.value;\n\t\t\t\t\t\t\telse if (data.promocode.type == '%') newValue -= (newValue/100)*data.promocode.value;\n\t\t\t\t\t\t\tif(newValue < 0) newValue = 0;\n\n\t\t\t\t\t\t\tthat.totalPrice = that.getTreatment().pvp;\n\t\t\t\t\t\t\tthat.totalDiscount = newValue ;\n\n\t\t\t\t\t\t\tthat.$el.find('.price').text(that.formatPrice(that.totalDiscount));\n\t\t\t\t\t\t\tthat.$el.find('.overline').text(that.formatPrice(that.totalPrice))\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\terror: function() {\n\t\t\t\t\t\tif(window.mixpanel) window.mixpanel.track(\"booking-promocode-error\", {\n\t\t\t\t\t\t\tpromocode:code,\n\t\t\t\t\t\t\ttreatment:that.selected.treatment[0]\n\t\t\t\t\t\t});\n\t\t\t\t\t\tif( that.UIElements[\"wizard\"] ) that.UIElements[\"wizard\"].step(\"error\");\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tremovePromocode: function(e){\n\t\t\t\te.preventDefault();\n\t\t\t\tvar that = this;\n\t\t\t\tvar treatment = that.getTreatment();\n\t\t\t\tvar newValue = treatment.pvpDiscount || treatment.pvp;\n\t\t\t\tthat.$el.find('.apply-promo-code, .promo-code').show();\n\t\t\t\tthat.$el.find('.success-code').remove();\n\t\t\t\tthat.$el.find('.price').text(that.formatPrice(newValue));\n\n\t\t\t\tthat.totalPrice = newValue;\n\n\t\t\t\tvar oldPrice = \"\";\n\t\t\t\tthat.totalDiscount = 0;\n\t\t\t\tif(treatment.priceDiscount) {\n\t\t\t\t\toldPrice = that.formatPrice(treatment.pvp);\n\t\t\t\t\tthat.totalDiscount = treatment.pvp;\n\t\t\t\t}\n\t\t\t\tthat.$el.find('.overline').text(oldPrice);\n\n\t\t\t\tthat.selected.code = null;\n\t\t\t\treturn false;\n\t\t\t},\n\n\t\t\tchoosenTreatment: function(e) {\n\t\t\t\tvar id = $(e.currentTarget).attr('data-id');\n\t\t\t\tthis.selected.treatment = [id];\n\t\t\t\tthis.template = mainTemplate;\n\t\t\t\tthis.render();\n\t\t\t},\n\n\t\t\tchoosenCenter: function(e) {\n\t\t\t\tthis.selected.idcenter = $(e.currentTarget).attr('data-id');\n\t\t\t\tthis.selected.treatment = [];\n\t\t\t\tthis.template = listTemplate;\n\t\t\t\tthis.$loadParameters = { treatmentVisibility : 'own' };\n\t\t\t\t_proto_.initialize.apply( this , [{\n\t\t\t\t\tidaccount:this.selected.idcenter,\n\t\t\t\t\t$el:this.$el\n\t\t\t\t}] );\n\t\t\t},\n\n\t\t\tchoosenWayToPay: function(e){\n\t\t\t\tvar that = this;\n\t\t\t\tthat.wayToPay = e.target.value;\n\t\t\t\tif(that.wayToPay == 'card') {\n\t\t\t\t\tthat.$el.find('.additional-section').slideUp('fast');\n\t\t\t\t} else  {\n\t\t\t\t\tthat.$el.find('.additional-section').slideDown('fast');\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tbackToTreats: function(e) {\n\t\t\t\tthis.template = listTemplate;\n\t\t\t\tthis.selected.treatment = [];\n\t\t\t\tthis.render();\n\t\t\t},\n\n\t\t\tbackToCenters: function(e) {\n\t\t\t\tthis.selected = {accountGroup: this.accountGroup};\n\t\t\t\tthis.template = multiTemplate;\n\t\t\t\tthis.$loadParameters = {accountGroup:this.accountGroup};\n\t\t\t\t_proto_.initialize.apply( this , [{\n\t\t\t\t\t$el:this.$el\n\t\t\t\t}] );\n\t\t\t},\n\n\t\t\tselectedDay: function( day ) {\n\t\t\t\tthis.selected.day = day.getFullYear()  + \"-\" + (parseInt(day.getMonth())+1) + \"-\" + day.getDate();\n\t\t\t},\n\n\t\t\tselectedHour: function( hour ) {\n\t\t\t\tthis.selected.hour = hour;\n\t\t\t},\n\n\t\t\tselectedEmployee: function( id ) {\n\t\t\t\tthis.selected.hints = id;\n\t\t\t},\n\n\t\t\twizardEvents: function( bool ) {\n\t\t\t\tthis.eventsDisabled = !bool;\n\t\t\t},\n\n\t\t\tstepReady: function() {\n\t\t\t\tthis.trigger( 'wizard-events' , true );\n\t\t\t\tthis.trackAnalytics();\n\t\t\t},\n\n\t\t\ttrackAnalytics: function(){\n\t\t\t\tif(window.ga) {\n\t\t\t\t\tvar page = [\n\t\t\t\t\t\t'', \n\t\t\t\t\t\t'booking', \n\t\t\t\t\t\t$('.booking-wizard-layout .booking-wizard-step:visible').data('step'),\n\t\t\t\t\t\tthis.model.centre['path']\n\t\t\t\t\t].join('/');\n\t\t\t\t\tvar title = $('.booking-wizard-layout .booking-wizard-step:visible h4').text();\n\t\t\t\t\tga('send','pageview', { page: page, title: title});\n\t\t\t\t}\n\t\t\t},\n\n\t\t\trender: function() {\n\t\t\t\tvar that = this;\n\n\t\t\t\tif( that.model ) {\n\t\t\t\t\t_.CURRENCY = that.model && that.model.country ? that.model.country.ckey : 'EUR';\n\t\t\t\t}\n\n\t\t\t\tif( that.model && that.selected.treatment && that.selected.treatment.length > 0 ) {\n\t\t\t\t\tthat.treatment = that.getTreatment();\n\t\t\t\t}\n\n\t\t\t\t_proto_.render.apply( that , arguments );\n\n\t\t\t\tif( that.model ) {\n\n\t\t\t\t\t//Scanning\n\t\t\t\t\tthat.$el.find(\"[data-bhbooking]\").each( function(){\n\n\t\t\t\t\t\tvar type = $(this).attr(\"data-bhbooking\");\n\n\t\t\t\t\t\tif( uielements[type] ) {\n\t\t\t\t\t\t\tthat.UIElements[type] = new uielements[type]({ \n\t\t\t\t\t\t\t\tparent \t\t: that, \n\t\t\t\t\t\t\t\t$el \t\t: $(this), \n\t\t\t\t\t\t\t\tidaccount \t: that.selected.idcenter, \n\t\t\t\t\t\t\t\tidtreatment : that.selected.treatment[0],\n\t\t\t\t\t\t\t\ttreatment \t: that.getTreatment()\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\t//Rendering custom form elements\n\t\t\t\t\tSelectUI.init({\n\t  \t\t\t\t\tclassName: 'select-theme-default'\n\t\t\t\t\t});\n\n\t\t            that.$el.find('input[type=\"radio\"], input[type=\"checkbox\"]').iCheck({\n\t\t                checkboxClass: 'icheckbox_square-bellahora',\n\t\t                radioClass: 'iradio_square-bellahora',\n\t\t                increaseArea: '20%',\n\t\t                aria:true,\n\t\t                cursor:true\n\t\t            });\n\n\t\t            //Right height equal to Left height\n\t\t\t\t\t// when the image is loaded ofc\n\t\t\t\t\tthat.$el.find('.treat-image').on('load', function(){\n\t\t\t\t\t\tvar heightFromLeft = that.$el.find('.wrapper-left').height();\n\t\t\t\t\t\tthat.$el.find('.booking-wizard-step').height( heightFromLeft );\n\t\t\t\t\t\tthat.$el.find('.booking-wizard-layout').height( heightFromLeft );\n\t\t\t\t\t});\n\n\n\t\t\t\t\tthat.trackAnalytics();\n\n\t\t\t\t\tvar treat = that.getTreatment();\n\t\t\t\t\tif(treat) {\n\t\t\t\t\t\tthat.totalDiscount = treat.pvpDiscount || 0;\n\t\t\t\t\t\tthat.totalPrice = treat.pvp;\n\t\t\t\t\t}\n\n\n\t\t\t\t\tif(window.mixpanel) {\n\t\t\t\t\t\tvar price = (treat.pvpDiscount || treat.pvp);\n\t\t\t\t\t\twindow.mixpanel.track(\"booking-open\", {\n\t\t\t\t\t\t\treferer:that.referer,\n\t\t\t\t\t\t\tcategory:treat.effectiveCategory,\n\t\t\t\t\t\t\ttreatmentName:treat.name,\n\t\t\t\t\t\t\ttreatmentPrice:price\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\taddRandomToUrl: function( url ) {\n\t\t\t\tvar randomstring = Math.random().toString(36).slice(-8),\n\t\t\t\t\tsymbol = url.indexOf('?') === -1 ? '?' : '&';\n\n\t\t\t\treturn url + symbol + 'r=' + randomstring;\n\t\t\t},\n\n\t\t\t_actionBtn: function( e , json ) {\n\t\t\t\tthis.trigger( 'wizard-events' , false );\n\n\t\t\t\tvar that = this,\n\t\t\t\t\turl = json.url,\n\t\t\t\t\tmethod = json.method || 'GET',\n\t\t\t\t\terror = json[\"error\"] || function(data){\n\t\t\t\t\t\tif( that.UIElements[\"wizard\"] ) that.UIElements[\"wizard\"].step(\"error\", data);\n\t\t\t\t\t},\n\t\t\t\t\tsuccess = json.success || function(){},\n\t\t\t\t\tbtn = $(e.currentTarget),\n\t\t\t\t\tcallback = function() {\n\t\t\t\t\t\t//btn.find('.icon-cw').remove();\n\t\t\t\t\t};\n\n\t\t\t\t//btn.append('<div class=\"icon-cw\"/>');\n\n\t\t\t\tthat.hideErrors();\n\n\t\t\t\turl = that.addRandomToUrl(url);\n\n\t\t\t\t$.ajax( url , {\n\t\t\t\t\tdata \t: json.data,\n\t\t\t\t\tmethod  : method,\n\t\t\t\t\tsuccess : function( data ) { callback(); success( data ) },\n\t\t\t\t\terror: function(data) { callback(); error(data) }\n\t\t\t\t});\n\t\t\t},\n\n\t\t\tgoToGateway: function(e){\n\t\t\t\tvar that = this;\n\t\t\t\tthis.selected.from = that.referer;\n\t\t\t\tthis.selected.widget = true;\n\t\t\t\tthis.selected.comment = that.$el.find('.work-comment').val();\n\t\t\t\tthis._actionBtn( e, {\n\t\t\t\t\turl: '/api/portal/' + Config.api + '/payment',\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\tdata: that.selected,\n\t\t\t\t\tsuccess: function( data ) {\n\t\t\t\t\t\tif(window.google_trackConversion && typeof(window.google_trackConversion) == 'function') {\n\t\t\t\t\t\t\twindow.google_trackConversion({\n\t\t\t\t\t\t\t\tgoogle_conversion_id : 986322506,\n\t\t\t\t\t\t\t\tgoogle_conversion_format : \"3\",\n\t\t\t\t\t\t\t\tgoogle_conversion_label :  \"l-3gCJ_v1FwQyqyo1gM\",\n\t\t\t\t\t\t\t\tgoogle_remarketing_only : false,\n\t\t\t\t\t\t\t\tgoogle_conversion_value: (that.treatment.pvpDiscount || that.treatment.pvp)\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(window.ga && typeof(window.ga) == 'function') {\n\t\t\t\t\t\t\twindow.ga('send', 'event', 'widget', 'reserva', 'reserva desde widget');\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif(window.mixpanel) window.mixpanel.track(\"booking-success\", {\n\t\t\t\t\t\t\tday:that.selected.day,\n\t\t\t\t\t\t\tfrom:that.selected.from,\n\t\t\t\t\t\t\thour:that.selected.hour,\n\t\t\t\t\t\t\tcategory:that.treatment.effectiveCategory,\n\t\t\t\t\t\t\ttreatmentName:that.treatment.name,\n\t\t\t\t\t\t\ttreatmentPrice:(that.treatment.pvpDiscount || that.treatment.pvp)\n\t\t\t\t\t\t});\n\n\n\t\t\t\t\t\tif(that.referer == \"p_web\") {\n\n\t\t\t\t\t\t\tif(window.twttr) {\n\t\t\t\t\t\t\t\twindow.twttr.conversion.trackPid('ntvr0', { tw_sale_amount: 0, tw_order_quantity: 0 });\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t(function() {\n\t\t\t\t\t\t\t\tvar _fbq = window._fbq || (window._fbq = []);\n\t\t\t\t\t\t\t\tif (!_fbq.loaded) {\n\t\t\t\t\t\t\t\t\tvar fbds = document.createElement('script');\n\t\t\t\t\t\t\t\t\tfbds.async = true;\n\t\t\t\t\t\t\t\t\tfbds.src = '//connect.facebook.net/en_US/fbds.js';\n\t\t\t\t\t\t\t\t\tvar s = document.getElementsByTagName('script')[0];\n\t\t\t\t\t\t\t\t\ts.parentNode.insertBefore(fbds, s);\n\t\t\t\t\t\t\t\t\t_fbq.loaded = true;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})();\n\t\t\t\t\t\t\tvar value = (that.treatment.pvpDiscount || that.treatment.pvp);\n\t\t\t\t\t\t\twindow._fbq = window._fbq || [];\n\t\t\t\t\t\t\twindow._fbq.push(['track', '6028357907023', {'value':value.toString(),'currency':'EUR'}]);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\twindow.top.location.href = \"https://bellahora.com/payment-gateway/\" + data;\n\t\t\t\t\t},\n\t\t\t\t\terror: function(data){\n\t\t\t\t\t\tdata.responseText = \"{}\";\n\t\t\t\t\t\tif( that.UIElements[\"wizard\"] ) that.UIElements[\"wizard\"].step(\"error\", data);\n\t\t\t\t\t\tif(window.mixpanel) window.mixpanel.track(\"booking-error\", {error:data});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\n\t\t\tsubmit: function(e) {\n\t\t\t\tvar that = this;\n\t\t\t\tthat.selected.from = that.referer;\n\t\t\t\tthat.selected.widget = true;\n\t\t\t\tthat.selected.comment = that.$el.find('.work-comment').val();\n\n                if(!that.wayToPay) {\n\t\t\t\t\tvar wayToPay = that.model.centre.waysToPay;\n                    if(wayToPay && wayToPay.indexOf('creditcard') > 0) that.wayToPay = 'card';\n                    else if (wayToPay && wayToPay.indexOf('creditcard') == -1) that.wayToPay = 'cash';\n                    else if (!wayToPay || wayToPay.length == 0) that.wayToPay = 'card';\n                }\n\n\t\t\t\tif(that.wayToPay == 'cash') {\n\t\t\t\t\tthat._actionBtn( e , {\n\t\t\t\t\t\turl: '/api/portal/'+Config.api+'/booking',\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\tdata: that.selected,\n\t\t\t\t\t\tsuccess: function( data ) {\n\t\t\t\t\t\t\tif(window.google_trackConversion && typeof(window.google_trackConversion) == 'function') {\n\t\t\t\t\t\t\t\twindow.google_trackConversion({\n\t\t\t\t\t\t\t\t\tgoogle_conversion_id : 986322506,\n\t\t\t\t\t\t\t\t\tgoogle_conversion_format : \"3\",\n\t\t\t\t\t\t\t\t\tgoogle_conversion_label :  \"l-3gCJ_v1FwQyqyo1gM\",\n\t\t\t\t\t\t\t\t\tgoogle_remarketing_only : false,\n\t\t\t\t\t\t\t\t\tgoogle_conversion_value: (that.treatment.pvpDiscount || that.treatment.pvp)\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif(window.ga && typeof(window.ga) == 'function') {\n\t\t\t\t\t\t\t\twindow.ga('send', 'event', 'widget', 'reserva', 'reserva desde widget');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif(window.mixpanel) window.mixpanel.track(\"booking-success\", {\n\t\t\t\t\t\t\t\tday:that.selected.day,\n\t\t\t\t\t\t\t\tfrom:that.selected.from,\n\t\t\t\t\t\t\t\thour:that.selected.hour,\n\t\t\t\t\t\t\t\tcategory:that.treatment.effectiveCategory,\n\t\t\t\t\t\t\t\ttreatmentName:that.treatment.name,\n\t\t\t\t\t\t\t\ttreatmentPrice:(that.treatment.pvpDiscount || that.treatment.pvp)\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tif( that.UIElements[\"wizard\"] ){\n\t\t\t\t\t\t\t\tif( data.state === \"RES_CONFIRMATION\" ) {\n\t\t\t\t\t\t\t\t\tthat.UIElements[\"wizard\"].step(\"success-confirm\");\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tthat.UIElements[\"wizard\"].step(\"success\");\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif(that.referer == \"p_web\") {\n\t\t\t\t\t\t\t\t(function() {\n\t\t\t\t\t\t\t\t\tvar _fbq = window._fbq || (window._fbq = []);\n\t\t\t\t\t\t\t\t\tif (!_fbq.loaded) {\n\t\t\t\t\t\t\t\t\t\tvar fbds = document.createElement('script');\n\t\t\t\t\t\t\t\t\t\tfbds.async = true;\n\t\t\t\t\t\t\t\t\t\tfbds.src = '//connect.facebook.net/en_US/fbds.js';\n\t\t\t\t\t\t\t\t\t\tvar s = document.getElementsByTagName('script')[0];\n\t\t\t\t\t\t\t\t\t\ts.parentNode.insertBefore(fbds, s);\n\t\t\t\t\t\t\t\t\t\t_fbq.loaded = true;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t})();\n\t\t\t\t\t\t\t\tvar value = (that.treatment.pvpDiscount || that.treatment.pvp);\n\t\t\t\t\t\t\t\twindow._fbq = window._fbq || [];\n\t\t\t\t\t\t\t\twindow._fbq.push(['track', '6028357907023', {'value':value.toString(),'currency':'EUR'}]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\terror: function(data){\n\t\t\t\t\t\t\tif( that.UIElements[\"wizard\"] ) that.UIElements[\"wizard\"].step(\"error\", data);\n\t\t\t\t\t\t\tif(window.mixpanel) window.mixpanel.track(\"booking-error\", {error:data});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tthat.goToGateway(e);\n\t\t\t\t}\n\n\t\t\t},\n\n\t\t\tcanUseLoyalityCredit: function(){\n\t\t\t\tvar that = this;\n\n\t\t\t\tif( !that.model || !that.model.centre || !that.model.centre.loyalityPrograms || that.model.centre.loyalityPrograms.indexOf('bookingReward') < 0 )\n\t\t\t\t\treturn false;\n\n\t\t\t\tif( that.target === 'own' )\n\t\t\t\t\treturn false;\n\n\t\t\t\tvar treatmentPrice = that.treatment.pvp || 0;\n\t\t\t\tvar credit = that.user.loyalityCredit || 0;\n\n\t\t\t\treturn credit && credit >= treatmentPrice;\n\t\t\t},\n\n\t\t\tgetTreatment: function() {\n\t\t\t\tvar that = this;\n\t\t\t\tvar idTreatment = that.selected.treatment[0];\n\t\t\t\tvar treatments = [];\n\t\t\t\t_.each( that.model.treatments , function( arr ) { treatments = treatments.concat( arr ); });\n\t\t\t\treturn _.where( treatments , { _id: idTreatment })[0];\n\t\t\t},\n\n\t\t\tformatPrice: formatPrice,\n\n\t\t\ttemplateHelpers: {\n\t\t\t\tcanUsePromo: function() {\n\t\t\t\t\treturn this._View.promocode || false;\n\t\t\t\t},\n\n\t\t\t\tisProfessionalWidget: function() {\n\t\t\t\t\treturn this._View.referer != 'p_web'\n\t\t\t\t},\n\n\t\t\t\tgetTreatment: function() {\n\t\t\t\t\treturn this._View.treatment;\n\t\t\t\t},\n\n\t\t\t\tpriceTax: priceTax,\n\n\t\t\t\tshouldSelectEmployee: function() {\n\t\t\t\t\treturn this._View.treatment && this._View.treatment.treatmentBooking && this._View.treatment.treatmentBooking.selectableEmployee === true;\n\t\t\t\t},\n\n\t\t\t\thasOnlinePayWay: function(){\n\n\t\t\t\t\tvar waysToPay = this._View.model.centre.waysToPay;\n\t\t\t\t\treturn $.inArray('creditcard', waysToPay || []) >= 0;\n\t\t\t\t},\n\n\t\t\t\thasDirectPayWay: function(){\n\t\t\t\t\tvar waysToPay = this._View.model.centre.waysToPay;\n\t\t\t\t\treturn $.inArray('direct', waysToPay || []) >= 0;\n\t\t\t\t},\n\n\n\t\t\t\tgetTreatmentList: function() {\n\t\t\t\t\tvar that = this._View;\n\t\t\t\t\treturn that.model.treatments;\n\t\t\t\t},\n\n\t\t\t\tgetCenterList: function() {\n\t\t\t\t\tvar that = this._View;\n\t\t\t\t\tvar centers = [];\n\t\t\t\t\t_.each( that.model.centres , function( arr ) { centers = centers.concat( arr ); });\n\t\t\t\t\treturn centers;\n\t\t\t\t},\n\n\t\t\t\tisDialog: function() {\n\t\t\t\t\treturn this._View._openedAsDialog;\n\t\t\t\t},\n\n\t\t\t\tgetAddress: function(bhAccount){\n\t\t\t\t\tif(!bhAccount.location)\n\t\t\t\t\t\treturn bhAccount.address || '';\n\t\t\t\t\tvar firstComponent = [];\n\t\t\t\t\tvar secondComponent = [];\n\t\t\t\t\tif(bhAccount.location.stName)\n\t\t\t\t\t\tfirstComponent.push(bhAccount.location.stName);\n\t\t\t\t\tif(bhAccount.location.stNumber)\n\t\t\t\t\t\tfirstComponent.push(bhAccount.location.stNumber);\n\t\t\t\t\tif(bhAccount.location.postcode)\n\t\t\t\t\t\tsecondComponent.push(bhAccount.location.postcode);\n\t\t\t\t\tif(bhAccount.location.city)\n\t\t\t\t\t\tsecondComponent.push(bhAccount.location.city);\n\t\t\t\t\treturn [firstComponent.join(' '), secondComponent.join(' ')].join(', ');\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tclose: function() {\n\t\t\t\tvar that = this;\n\n\t\t\t\tfor( var ui in that.UIElements) {\n\t\t\t\t\tif( that.UIElements[ui] && that.UIElements[ui].close ) {\n\t\t\t\t\t\tthat.UIElements[ui].close();\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tObj.prototype.close.apply( that , arguments );\n\t\t\t}\t\t\t\n\t\t};\n\t}).extend( errorHandling ).extend( userAuthMixin );\n});","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"5":{"id":"5","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":6,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/booking-widget/js/booking-widget.js","digestWhenLastPersisted":"8aa006aa54109e63559e0a1b78bde6e00bed573a","preferredLineEnding":null,"nextMarkerId":2,"deserializer":"TextBuffer","version":5},{"id":"7ae9c41eed8bbc6e60fb6f5a4b4e29f4","text":"define([\n\n\t'config',\n\t'core/object',\n\t'core/pubsub'\n\n], function( Config, Obj, Pubsub ) {\n\n\treturn Obj.extend({\n\n\t\tbhtype : \"select-employee\",\n\n\t\t$load: '/api/portal/'+Config.api+'/resources/<%= idaccount %>/<%= idTreatmentBooking %>',\n\n\t\t$loadfilter: function( item ) {\n\t\t\treturn !!item.idEmployee;\n\t\t},\n\n\t\tshownEmployees: false,\n\n\t\tinitialize: function( config ) {\n\t\t\tvar that = this;\n\t\t\t_.extend( that , config );\n\n\t\t\tconfig.idTreatmentBooking = config.treatment ? config.treatment.idTreatmentBooking : null;\n\n\t\t\tObj.prototype.initialize.apply( this , arguments );\n\n\t\t\tthat.listenEvents();\n\t\t},\n\n\t\tlistenEvents: function() {\n\t\t\tvar that = this;\n\n\t\t\tPubsub.publish( 'selected-employee' , that.$el.val() );\n\t\t\tthat.$el.on( \"change\" , function() {\n\t\t\t\tPubsub.publish( 'selected-employee' , $(this).val() );\n\t\t\t});\n\t\t},\n\n\t\tleaveEvents: function() {\n\t\t\tthis.$el.off( \"click\" , \".combo\" );\n\t\t\tthis.$el.off( \"click\" , \"ul.select-employee li\" );\n\t\t},\n\n\t\trender: function() {\n\t\t\tvar $el = this.$el;\n\t\t\tvar employees = this.model;\n\t\t\tif(employees && employees.length > 0) {\n\t\t\t\t$.each(employees, function(index, employee){\n\t\t\t\t\t$el.append(\n\t\t\t\t\t\t$('<option></option>').val(employee._id).html(employee.employee.name)\n\t\t\t\t\t);\n\t\t\t\t})\n\t\t\t}\n\t\t},\n\n\t\tclose: function() {\n\t\t\tthis.leaveEvents();\n\t\t}\n\t});\n});","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"2":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"3":{"range":{"start":{"row":53,"column":6},"end":{"row":53,"column":6}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"5":{"id":"5","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":6,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/booking-widget/js/ui/select-employee.js","digestWhenLastPersisted":"49ce40049d0a3f46029e9b864986c99a61915e4c","preferredLineEnding":null,"nextMarkerId":4,"deserializer":"TextBuffer","version":5}]},"workspace":{"deserializer":"Workspace","paneContainer":{"deserializer":"PaneContainer","version":1,"root":{"deserializer":"Pane","id":3,"items":[{"deserializer":"TextEditor","id":4,"softTabs":false,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":5,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/booking-widget/js/booking-widget.js","bufferId":"7903af00fc1c1c2b58562770cbae9a8e","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":52,"softTabs":false,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":53,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/booking-widget/js/ui/select-employee.js","bufferId":"7ae9c41eed8bbc6e60fb6f5a4b4e29f4","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"}],"activeItemURI":"/home/bellahora-04/Bellahora/booking-widget/js/ui/select-employee.js","focused":true,"flexScale":1},"activePaneId":3},"packagesWithActiveGrammars":["language-javascript-better","language-hyperlink","language-todo"],"destroyedItemURIs":[]},"packageStates":{"fuzzy-finder":{"/home/bellahora-04/Bellahora/booking-widget/js/booking-widget.js":1447338190033,"/home/bellahora-04/Bellahora/booking-widget/js/ui/select-employee.js":1456988509053},"metrics":{"sessionLength":13691319},"tabs":[{"previewTabURI":"/home/bellahora-04/Bellahora/booking-widget/js/ui/select-employee.js"}],"tree-view":{"directoryExpansionStates":{"/home/bellahora-04/Bellahora/booking-widget":{"isExpanded":true,"entries":{".git":{"isExpanded":false,"entries":{}},".idea":{"isExpanded":false,"entries":{}},"css":{"isExpanded":false,"entries":{}},"js":{"isExpanded":true,"entries":{"core":{"isExpanded":true,"entries":{"ui":{"isExpanded":true,"entries":{}}}},"libs":{"isExpanded":false,"entries":{}},"locales":{"isExpanded":false,"entries":{}},"mixins":{"isExpanded":false,"entries":{}},"plug":{"isExpanded":true,"entries":{}},"ui":{"isExpanded":true,"entries":{}}}},"node_modules":{"isExpanded":false,"entries":{}},"templates":{"isExpanded":true,"entries":{}}}}},"selectedPath":"/home/bellahora-04/Bellahora/booking-widget/js/ui/select-employee.js","hasFocus":false,"attached":true,"scrollLeft":0,"scrollTop":0,"width":200},"linter":{"scope":"File"},"pigments":{"project":{"deserializer":"ColorProject","timestamp":"2016-03-03T10:50:00.484Z","version":"1.0.1","markersVersion":"1.0.5","globalSourceNames":["**/*.styl","**/*.stylus","**/*.less","**/*.sass","**/*.scss"],"globalIgnoredNames":["vendor/*","node_modules/*","spec/*","test/*"],"buffers":{"4":{"id":4,"path":"/home/bellahora-04/Bellahora/booking-widget/js/booking-widget.js","colorMarkers":[]},"52":{"id":52,"path":"/home/bellahora-04/Bellahora/booking-widget/js/ui/select-employee.js","colorMarkers":[]}},"paths":["/home/bellahora-04/Bellahora/booking-widget/css/basics.less","/home/bellahora-04/Bellahora/booking-widget/css/main.less","/home/bellahora-04/Bellahora/booking-widget/css/variables.less","/home/bellahora-04/Bellahora/booking-widget/css/icheck.less"],"variables":{"deserializer":"VariablesCollection","content":[{"name":"@host","value":"\"s3\"","path":"/home/bellahora-04/Bellahora/booking-widget/css/basics.less","range":[21,33],"line":1},{"name":"@color-strong","value":"#8062A4","path":"/home/bellahora-04/Bellahora/booking-widget/css/basics.less","range":[45,67],"line":4,"isColor":true,"color":[128,98,164,1],"variables":[]},{"name":"@color-light","value":"mix( @color-strong , #fff , 20% )","path":"/home/bellahora-04/Bellahora/booking-widget/css/basics.less","range":[69,116],"line":5,"isColor":true,"color":[229,223,236,1],"variables":[]},{"name":"@font-primary","value":"sans-serif","path":"/home/bellahora-04/Bellahora/booking-widget/css/basics.less","range":[127,152],"line":8},{"name":"@params","value":"all ease 0.3s","path":"/home/bellahora-04/Bellahora/booking-widget/css/basics.less","range":[4971,4993],"line":207},{"name":"@color-primary","value":"#FF2F7E","path":"/home/bellahora-04/Bellahora/booking-widget/css/variables.less","range":[0,23],"line":0,"isColor":true,"color":[255,47,126,1],"variables":[]},{"name":"@text-color","value":"#757575","path":"/home/bellahora-04/Bellahora/booking-widget/css/variables.less","range":[26,46],"line":2,"isColor":true,"color":[117,117,117,1],"variables":[]},{"name":"@soft-text-color","value":"#747474","path":"/home/bellahora-04/Bellahora/booking-widget/css/variables.less","range":[49,73],"line":4,"isColor":true,"color":[116,116,116,1],"variables":[]},{"name":"@font-gray","value":"#7B7B7B","path":"/home/bellahora-04/Bellahora/booking-widget/css/variables.less","range":[76,95],"line":6,"isColor":true,"color":[123,123,123,1],"variables":[]}]}}}},"fullScreen":false}