{"mode":"editor","version":1,"windowDimensions":{"x":0,"y":21,"width":1050,"height":1659,"maximized":false},"grammars":{"grammarOverridesByPath":{}},"project":{"deserializer":"Project","paths":["/home/bellahora-04/Bellahora/puller"],"buffers":[{"id":"ebd84f7ff6c9a777e44810b6c96db7a3","text":"var _ = require('underscore'),\n\tBaseHandler = require('./base.js'),\n\tpathProject = '..',\n\twhen = require('promised-io/promise'),\n\tEmployee = require( pathProject + '/common/model/Employee.js').model(),\n\temailExistence = require('email-existence'),\n\tLinkM = require( pathProject + '/common/model/Link.js').model();\n\nvar EmployeePasswordCreate = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend(EmployeePasswordCreate.prototype, BaseHandler.prototype , {\n\n\trenderTag : 'emp_password_create',\n\n\temail : null,\n\n\temployee: null,\n\n\tpremiumAccount: true, //Because password create and password recovery have to be sent always.\n\n\tgetEmployee : function( idEmployee , callback ) {\n\t\tvar that = this;\n\t\tvar prom = new when.Deferred();\n\t\tEmployee.findFullById( idEmployee , function( employee ){\n\t\t\tif (callback) {\n\t\t\t\tcallback( employee );\n\t\t\t}\n\t\t\tprom.resolve(employee);\n\n\t\t});\n\t\treturn prom;\n\t},\n\n\tgenerateLink: function(a_controller, a_method, a_values, a_ttl, a_callback) {\n\t\tvar that = this,\n\t\tdata = {\n\t\t\tcontroller: {\n\t\t\t\tname: a_controller,\n\t\t\t\tmethod: a_method\n\t\t\t},\n\t\t\tdata: a_values\n\t\t};\n\n\t\tif(typeof a_ttl == \"function\") {\n\t\t\ta_callback = a_ttl; //Callback is in a_ttl\n\t\t} else {\n\t\t\tdata.ttl = a_ttl;\n\t\t}\n\n\t\tvar\n\t\thashExceptions = [ 's3' , 'subs' , 'login' , 'logout', 'data', 'template', 'public', 'mailpreview' ],\n\t\thasher = function() {\n\t\t\tvar hash = [], length = 5,\n\t\t\tchars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');\n\t\t\tfor (var i = 0; i < length; i++) {\n\t\t\t\thash.push(chars[Math.floor(Math.random()*62)]);\n\t\t\t}\n\t\t\treturn hash.join('');\n\t\t},\n\t\trecFn = function(a_completed) {\n\t\t\tvar hash = hasher();\n\n\t\t\tif( _.contains( hashExceptions , hash ) ) {\n\t\t\t\trecFn( a_completed );\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLinkM.find({ hash : hash }, function(arr, linkObj){\n\n\t\t\t\tif(linkObj.length > 0) {\n\n\t\t\t\t\tvar currentDate = new Date(),\n\t\t\t\t\tlapsed = 0;\n\t\t\t\t\tfor(var i = 0; i < linkObj.length; i++) {\n\t\t\t\t\t\tvar jsonLinkObj = linkObj[i].toJSON();\n\n\t\t\t\t\t\tif(currentDate.getTime() > ( new Date(jsonLinkObj.dateCreated).getTime() + jsonLinkObj.ttl * 1000 ) ) {\n\t\t\t\t\t\t\tlapsed++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif(linkObj.length === lapsed) {\n\t\t\t\t\t\tLinkM.remove({ hash : hash }, function(){\n\t\t\t\t\t\t\ta_completed( hash );\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\trecFn( a_completed );\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\ta_completed( hash );\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\n\t\trecFn( function(goodHash) {\n\t\t\tdata.hash = goodHash;\n\t\t\tdata._idBHAccount = that.idBHAccount;\n\t\t\tdata.dateCreated = new Date();\n\n\t\t\tLinkM.create(data, function (err, obj) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.log(err);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tdata.id = obj.id;\n\t\t\t\ta_callback(data);\n\t\t\t});\n\t\t});\n\t},\n\n\tinit : function() {\n\t\tvar that = this;\n\n\t\t//Load Employee\n\t\tthat.getEmployee( that.data.idEmployee , function( employee ){\n\n\t\t\tif (employee === null) {\n\t\t\t\treturn that.completed('none');\n\t\t\t}\n\t\t\tthat.employee = employee;\n\t\t\tthat.idBHAccount = that.employee._idBHAccount;\n\n\t\t\t//Load source email\n\t\t\tthat.loadEmailSource( that.employee.bhaccount );\n\n\t\t\t//Create link\n\t\t\tthat.generateLink( '/painter/EmployeePasswordCreate' , 'render' ,\n\t\t\t\t\t{ idEmployee : that.data.idEmployee } , 86400 ,\n\t\t\t\t//Success function\n\t\t\t\tfunction( link ) {\n\t\t\t\t\tvar hash = link.hash;\n\n\t\t\t\t\t//Prepare message\n\t\t\t\t\tthat.renderAll( that.renderTag , [ 'email_title' , 'email' ],\n\t\t\t\t\t\t\t{center: that.employee.bhaccount, employee: that.employee, hash: hash},\n\t\t\t\t\t\t\tfunction(val) {\n\t\t\t\t\t\tthat.email = {\n\t\t\t\t\t\t\tto \t     : that.employee.email,\n\t\t\t\t\t\t\tsubject  : val[0],\n\t\t\t\t\t\t\tbody \t : val[1],\n\t\t\t\t\t\t\timportant: true\n\t\t\t\t\t\t};\n\t\t\t\t\t\tthat.completed( 'email' );\n\t\t\t\t},\n\t\t\t\t//Error function\n\t\t\t\tfunction(err) {\n\t\t\t\t\tconsole.log(err);\n\t\t\t\t\tthat.completed( 'none' );\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t},\n\n\t/**\n\t* Change the state of the email employee hard-bounce.\n\t* pre: the handle must have a employee attribute.\n\t*/\n\tsetHardBounce: function( bool ) {\n\t\tEmployee.idBHAccount = this.employee._idBHAccount;\n\t\tEmployee.update( {_id : this.employee._id } , { isHardBounce: bool } , function( err , data) {});\n\t},\n\n\t/**\n\t* returns true if email === emailChecked and is not hardBounce\n\t* otherwise check if emailChecked is a valid account and return true or false depending of it\n\t*/\n\tcheckEmail: function( callback ) {\n\t\tcallback( true );\n\t\treturn;\n\n\t\tvar that = this;\n\t\tthat.callback = callback;\n\t\tEmployee.idBHAccount = this.employee._idBHAccount;\n\t\tEmployee.findOne( { _id : this.employee._id } ).exec( function( err, info ) {\n\t\t\tthat.callback( !info.isHardBounce );\n\t\t\t/*\n\t\t\tif ( info.email === info.emailChecked ) {\n\t\t\t\tthat.callback( !info.isHardBounce );\n\t\t\t} else {\n\t\t\t\tthat.info = info;\n\t\t\t\temailExistence.check( info.email, function( err, res ) {  //checking if the email account exists\n\t\t\t\t\tthat.setHardBounce(!res);\t\t\t\t\t\t\t//setting isHardBounce depending of the existence of the mail account\n\t\t\t\t\tEmployee.update( { _id : that.employee._id } , { emailChecked: that.info.email } , function( err , data) {}); //we update email with the emailChecked\n\t\t\t\t\tthat.callback( res );\n\t\t\t\t});\n\t\t\t}*/\n\t\t});\n\t}\n\n});\n\nmodule.exports = EmployeePasswordCreate;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":9,"column":4},"end":{"row":9,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"4":{"range":{"start":{"row":8,"column":38},"end":{"row":8,"column":47}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"5":{"range":{"start":{"row":52,"column":103},"end":{"row":52,"column":103}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"6":{"range":{"start":{"row":78,"column":109},"end":{"row":78,"column":109}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"7":{"range":{"start":{"row":161,"column":99},"end":{"row":161,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"8":{"range":{"start":{"row":182,"column":100},"end":{"row":182,"column":100}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"9":{"range":{"start":{"row":183,"column":106},"end":{"row":183,"column":106}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"10":{"range":{"start":{"row":184,"column":154},"end":{"row":184,"column":154}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"11":{"range":{"start":{"row":23,"column":8},"end":{"row":23,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"12":{"range":{"start":{"row":23,"column":12},"end":{"row":23,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"13":{"range":{"start":{"row":35,"column":0},"end":{"row":35,"column":78}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"14":{"range":{"start":{"row":35,"column":0},"end":{"row":35,"column":78}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"15":{"range":{"start":{"row":35,"column":0},"end":{"row":35,"column":78}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"16":{"range":{"start":{"row":35,"column":0},"end":{"row":35,"column":78}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"17":{"range":{"start":{"row":35,"column":0},"end":{"row":35,"column":78}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"18":{"range":{"start":{"row":36,"column":8},"end":{"row":36,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"19":{"range":{"start":{"row":39,"column":0},"end":{"row":39,"column":23}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"20":{"range":{"start":{"row":40,"column":0},"end":{"row":40,"column":20}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"21":{"range":{"start":{"row":42,"column":0},"end":{"row":42,"column":17}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"22":{"range":{"start":{"row":45,"column":0},"end":{"row":45,"column":34}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"23":{"range":{"start":{"row":45,"column":34},"end":{"row":45,"column":34}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"24":{"range":{"start":{"row":45,"column":26},"end":{"row":45,"column":34}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"25":{"range":{"start":{"row":46,"column":0},"end":{"row":46,"column":45}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"26":{"range":{"start":{"row":46,"column":0},"end":{"row":46,"column":45}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"27":{"range":{"start":{"row":48,"column":0},"end":{"row":48,"column":20}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"28":{"range":{"start":{"row":61,"column":0},"end":{"row":61,"column":33}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"29":{"range":{"start":{"row":65,"column":0},"end":{"row":65,"column":25}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"30":{"range":{"start":{"row":85,"column":0},"end":{"row":85,"column":27}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"31":{"range":{"start":{"row":88,"column":0},"end":{"row":88,"column":27}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"32":{"range":{"start":{"row":91,"column":0},"end":{"row":91,"column":25}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"33":{"range":{"start":{"row":107,"column":0},"end":{"row":107,"column":21}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"34":{"range":{"start":{"row":113,"column":8},"end":{"row":113,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"35":{"range":{"start":{"row":160,"column":8},"end":{"row":160,"column":52}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"36":{"range":{"start":{"row":161,"column":95},"end":{"row":161,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"37":{"range":{"start":{"row":161,"column":89},"end":{"row":161,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"38":{"range":{"start":{"row":169,"column":8},"end":{"row":169,"column":19}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"39":{"range":{"start":{"row":172,"column":8},"end":{"row":172,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"40":{"range":{"start":{"row":5,"column":4},"end":{"row":5,"column":45}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/employee_password_create.js","digestWhenLastPersisted":"d799ebeff525f8021cc34f8c521c96aed45e4176","preferredLineEnding":null,"nextMarkerId":42,"deserializer":"TextBuffer","version":5},{"id":"6ff6e712e3825f0e8176bbf9ab628e5d","text":"var _ = require('underscore'),\n    when = require('promised-io/promise'),\n    Employee = require( '../common/model/Employee.js').model(),\n    ResConfirmation = require('./res_confirmation.js'),\n    EmployeePasswordCreate = require('./employee_password_create.js');\n\nvar NotifWorkCancelled = function(config) {\n    this.preInit.apply(this, arguments);\n};\n\n_.extend(NotifWorkCancelled.prototype, ResConfirmation.prototype , EmployeePasswordCreate.prototype , {\n\n    renderTag: 'notif_client_work_cancelled',\n\n    targetType: 'user',\n\n    //This handler can send emails also in free accounts\n    freeAccountEmail: true,\n    sendAlsoIfRemoved: true,\n\n    init : function() {\n        var that = this;\n\n        that.getWork( that.data.idWork, function( work ) {\n\n            if( work ) {\n\n                that.work = work;\n                var pAgenda = that.load('Agenda',{ _id: that.work.idAgenda });\n\n                when.all( [ pAgenda ] ).then(function( data ){\n                    var agenda = data[2] && data[0].length > 0 ? data[0][0] : null;\n\n                    that.renderAll( that.renderTag , [ 'sms' , 'email_title' , 'email' ], { center: work.center , work : work, agenda: agenda },\n                        //Success function\n                        function( val ) {\n                            that.smsMessage = val[0];\n                            that.email = {\n                                to : work.client.email,\n                                subject : val[1],\n                                body : val[2],\n                                important: true\n                            };\n\n                            that.completedFn();\n                        }\n                        ,function(err) {\n                            console.log( err );\n                            that.completed( 'none' );\n                        });\n                });\n\n            } else {\n                that.completed('none');\n            }\n        });\n    },\n\n    completedFn : function() {\n        var that = this;\n        that.completed( ['email','push'] );\n    }\n\n});\n\nmodule.exports = NotifWorkCancelled;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":7,"column":4},"end":{"row":7,"column":40}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"4":{"range":{"start":{"row":6,"column":34},"end":{"row":6,"column":43}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"5":{"range":{"start":{"row":10,"column":102},"end":{"row":10,"column":103}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"6":{"range":{"start":{"row":33,"column":143},"end":{"row":33,"column":144}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"7":{"range":{"start":{"row":21,"column":8},"end":{"row":21,"column":24}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"8":{"range":{"start":{"row":59,"column":8},"end":{"row":59,"column":24}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"9":{"range":{"start":{"row":2,"column":4},"end":{"row":2,"column":63}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/notif_user_work_cancelled.js","digestWhenLastPersisted":"5635ae03028ed5a11f4b31db13274ffe7c395887","preferredLineEnding":null,"nextMarkerId":10,"deserializer":"TextBuffer","version":5},{"id":"3ce5b637b532fb41b43323b9b256774d","text":"var _ = require('underscore'),\n\twhen = require('promised-io/promise'),\n\tEmployee = require( '../common/model/Employee.js').model(),\n\tResConfirmation = require('./res_confirmation.js'),\n\tEmployeePasswordCreate = require('./employee_password_create.js');\n\nvar NotifWorkCreated = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend(NotifWorkCreated.prototype, ResConfirmation.prototype , EmployeePasswordCreate.prototype , {\n\n\trenderTag: 'notif_work_created',\n\n\ttargetType: 'employee',\n\n\t//This handler can send emails also in free accounts\n\tfreeAccountEmail: true,\n\n\tinit : function() {\n\t\tvar that = this;\n\n\t\tthat.getWork( that.data.idWork, function( work ) {\n\n\t\t\tif( work ) {\n\n\t\t\t\tthat.work = work;\n\t\t\t\tvar pEmployeeWork = that.work && that.work.idEmployee ? that.getEmployee( that.work.idEmployee ) : null;\n\n\t\t\t\tvar pEmployeeToNotify = that.getEmployee( that.data.idEmployee );\n\n\n\t\t\t\tvar pResourceAgenda = null;\n\t\t\t\tvar resources = _.uniq(_.flatten(_.pluck( work.resources ,'idResource')));\n\n\t\t\t\tif( resources.length > 0 ) {\n\t\t\t\t\tvar p = when.Deferred();\n\t\t\t\t\tthat.getModel('Resource').find({ _id: { $in: resources } }).populate({ path: 'idEmployee' , model: 'Employee' }).exec(function(err, resources) {\n\t\t\t\t\t\tp.resolve(_.map( resources , function(r){ return { name: r.idEmployee && r.idEmployee.name? r.idEmployee.name : r.name }}));\n\t\t\t\t\t});\n\t\t\t\t\tpResourceAgenda = p.promise;\n\t\t\t\t} else if( that.work.idAgenda ) {\n\t\t\t\t\tpResourceAgenda = that.load('Agenda',{ _id: that.work.idAgenda });\n\t\t\t\t}\n\n\t\t\t\twhen.all( [ pEmployeeWork , pEmployeeToNotify, pResourceAgenda ] ).then(function( data ){\n\t\t\t\t\tvar employeeWork = data[0];\n\t\t\t\t\tvar employeeToNotify = data[1];\n\t\t\t\t\tthat.employee = employeeToNotify;\n\t\t\t\t\tvar agenda = data[2] && data[2].length > 0 ? _.pluck( data[2] , 'name' ) : [];\n\t\t\t\t\tconsole.log( agenda );\n\t\t\t\t\tthat.renderAll( that.renderTag , [ 'sms' , 'email_title' , 'email' ], { center: work.center , work : work, employee: employeeWork, agenda: agenda },\n\t\t\t\t\t\t//Success function\n\t\t\t\t\t\tfunction( val ) {\n\t\t\t\t\t\t\tthat.smsMessage = val[0];\n\t\t\t\t\t\t\tthat.email = {\n\t\t\t\t\t\t\t\tto : employeeToNotify ? employeeToNotify.email : null,\n\t\t\t\t\t\t\t\tsubject : val[1],\n\t\t\t\t\t\t\t\tbody : val[2],\n\t\t\t\t\t\t\t\timportant: true\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tthat.completedFn();\n\t\t\t\t\t\t}\n\t\t\t\t\t\t//Error function\n\t\t\t\t\t\t,function(err) {\n\t\t\t\t\t\t\tconsole.log( err );\n\t\t\t\t\t\t\tthat.completed( 'none' );\n\t\t\t\t\t\t});\n\t\t\t\t});\n\n\t\t\t} else {\n\n\t\t\t\tthat.completed('none');\n\t\t\t}\n\t\t});\n\t},\n\n\tcompletedFn : function() {\n\t\tvar that = this;\n\t\tthat.completed( ['email', 'push'] );\n\t}\n\n});\n\nmodule.exports = NotifWorkCreated;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":7,"column":4},"end":{"row":7,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"4":{"range":{"start":{"row":6,"column":32},"end":{"row":6,"column":41}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"5":{"range":{"start":{"row":10,"column":100},"end":{"row":10,"column":101}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"6":{"range":{"start":{"row":27,"column":108},"end":{"row":27,"column":108}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"7":{"range":{"start":{"row":37,"column":149},"end":{"row":37,"column":149}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"8":{"range":{"start":{"row":38,"column":130},"end":{"row":38,"column":130}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"9":{"range":{"start":{"row":45,"column":93},"end":{"row":45,"column":93}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"10":{"range":{"start":{"row":51,"column":153},"end":{"row":51,"column":153}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"11":{"range":{"start":{"row":20,"column":8},"end":{"row":20,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"12":{"range":{"start":{"row":38,"column":130},"end":{"row":38,"column":130}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"13":{"range":{"start":{"row":78,"column":8},"end":{"row":78,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"14":{"range":{"start":{"row":2,"column":4},"end":{"row":2,"column":60}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/notif_work_created.js","digestWhenLastPersisted":"acf20c72eec956142c0a4f08e3146174a05e0745","preferredLineEnding":null,"nextMarkerId":15,"deserializer":"TextBuffer","version":5},{"id":"c3b02380936c5164cb48a6638d962be8","text":"var _ = require('underscore'),\n\tDateUtils = require('date-utils'),\n\tBaseHandler = require('./base.js');\n\nvar PreUserWelcome = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend(PreUserWelcome.prototype, BaseHandler.prototype , {\n\n\trenderTag : 'preuser_welcome',\n\n\ttargetType: 'user',\n\n\tfreeAccountEmail: true,\n\n\tcanUnsubscribe: true,\n\n\tinit : function() {\n\t\tvar that = this;\n\n\t\tthat.idUser = that.data.idUser;\n\n\t\tthat.getModel('PreUser').findById( that.idUser ).exec(function( err , user ) {\n\n\t\t\tthat.user = user;\n\n\t\t\tif( that.user && that.user.email ) {\n\n\t\t\t\tthat.email = {\n\t\t\t\t\ttemplate: \"datos-bienvenida\",\n\t\t\t\t\ttags: ['welcome','preuser'],\n\t\t\t\t\tsubject: \"¡Bienvenido a Bellahora! Aquí tienes tu código promocional.\",\n\t\t\t\t\tfrom_name: \"Bellahora\",\n\t\t\t\t\tto: user.email,\n\t\t\t\t\timportant: true\n\t\t\t\t};\n\n\t\t\t\tthat.setVar( 'unsub' , 'https://bellahora.com/user/unsubscribe/' + that.encrypt( user.email ) );\n\n\t\t\t\tthat.completed( 'email' );\n\t\t\t} else {\n\t\t\t\tthat.completed( 'none' );\n\t\t\t}\n\t\t});\n\t}\n});\n\nmodule.exports = PreUserWelcome;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":5,"column":4},"end":{"row":5,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"4":{"range":{"start":{"row":4,"column":30},"end":{"row":4,"column":39}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"5":{"range":{"start":{"row":38,"column":100},"end":{"row":38,"column":100}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"6":{"range":{"start":{"row":19,"column":8},"end":{"row":19,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"7":{"range":{"start":{"row":30,"column":34},"end":{"row":30,"column":34}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"8":{"range":{"start":{"row":32,"column":76},"end":{"row":32,"column":76}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"9":{"range":{"start":{"row":33,"column":0},"end":{"row":33,"column":28}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"10":{"range":{"start":{"row":33,"column":28},"end":{"row":33,"column":28}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"11":{"range":{"start":{"row":1,"column":4},"end":{"row":1,"column":35}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/preuser_welcome.js","digestWhenLastPersisted":"4657e996fcd7d536f4a9f1976b72a70358a1c1bc","preferredLineEnding":null,"nextMarkerId":12,"deserializer":"TextBuffer","version":5},{"id":"b71509112cf0de782b391e49131b7847","text":"var _ = require('underscore'),\n\tRemSameDay = require('./rem_sameday.js');\n\nvar RemDayBefore = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend(RemDayBefore.prototype, RemSameDay.prototype , {\n\n\trenderTag: 'rem_daybefore',\n\n\tpreparingEmailAttributes: function() {\n\t\tRemSameDay.prototype.preparingEmailAttributes.apply( this );\n\n\t\tthis.email = {\n\t\t\ttemplate: 'datos-reserva',\n\t\t\tsubject: 'Recuerda que mañana tienes una cita en <%= center.name %>',\n\t\t\timportant: true\n\t\t};\n\n\t\tthis.email_vars.title = 'Recuerda que mañana tienes una cita en <%= center.name %>';\n\t},\n});\n\nmodule.exports = RemDayBefore;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":4,"column":4},"end":{"row":4,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"4":{"range":{"start":{"row":3,"column":28},"end":{"row":3,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"5":{"range":{"start":{"row":12,"column":8},"end":{"row":12,"column":62}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"6":{"range":{"start":{"row":20,"column":0},"end":{"row":20,"column":86}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/rem_daybefore.js","digestWhenLastPersisted":"136eb6488096a14be9638389bc1c7d35248719fb","preferredLineEnding":null,"nextMarkerId":7,"deserializer":"TextBuffer","version":5},{"id":"d5df69e566475d1799aa10f404536bba","text":"var _ = require('underscore'),\n\tResConfirmation = require('./res_confirmation.js');\n\nvar RemSameDay = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend(RemSameDay.prototype, ResConfirmation.prototype , {\n\n\trenderTag: 'rem_sameday',\n\n\tpreparingEmailAttributes: function() {\n\t\tResConfirmation.prototype.preparingEmailAttributes.apply( this );\n\n\t\tthis.email = {\n\t\t\ttemplate: 'datos-reserva',\n\t\t\tsubject: 'Recuerda que hoy tienes una cita en <%= center.name %>',\n\t\t\timportant: true\n\t\t};\n\n\t\tthis.email_vars.title = 'Recuerda que hoy tienes una cita en <%= center.name %>';\n\t},\n\n\tcompletedFn : function() {\n\t\tvar that = this;\n\t\tthat.completed( that.work.client && that.work.client.alertReminders === \"true\" && that.work.center.nr === 1 ? that.preferredVia( that.work.client ) : 'none' );\n\t}\n});\n\nmodule.exports = RemSameDay;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":4,"column":4},"end":{"row":4,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"4":{"range":{"start":{"row":3,"column":26},"end":{"row":3,"column":35}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"5":{"range":{"start":{"row":25,"column":161},"end":{"row":25,"column":161}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"6":{"range":{"start":{"row":12,"column":8},"end":{"row":12,"column":67}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"7":{"range":{"start":{"row":20,"column":0},"end":{"row":20,"column":83}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"8":{"range":{"start":{"row":24,"column":8},"end":{"row":24,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"9":{"range":{"start":{"row":25,"column":86},"end":{"row":25,"column":161}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/rem_sameday.js","digestWhenLastPersisted":"7024eee7d72fb26f8993e37ae3dd3deaa3e43b9d","preferredLineEnding":null,"nextMarkerId":10,"deserializer":"TextBuffer","version":5},{"id":"589b95f888a93a2d0a61644f3907d32e","text":"var _ = require('underscore'),\n\tDateUtils = require('date-utils'),\n\tBaseHandler = require('./base.js');\n\nvar ResConfirmation = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend(ResConfirmation.prototype, BaseHandler.prototype , {\n\n\trenderTag : 'res_confirmation',\n\n\twork : null,\n\n\tsmsMessage : null,\n\n\t//This handler can send emails also in free accounts\n\tfreeAccountEmail: true,\n\n\tpreparingEmailAttributes: function() {\n\n\t\tthis.email = {\n\t\t\ttemplate: 'datos-reserva',\n\t\t\tsubject: '¡Felicidades! Tu reserva en <%= center.name %> ha sido confirmada con éxito.',\n\t\t\timportant: true\n\t\t};\n\n\t\tthis.header_text_template = '<td valign=\"top\" class=\"mcnTextContent\" style=\"padding-top:9px; padding-right: 18px; padding-bottom: 9px; padding-left: 18px;\"><span style=\"font-size:24px; text-transform:uppercase\"><%= center.name %></span></td>';\n\n\t\tthis.header_img_template = '<td class=\"mcnImageContent\" valign=\"top\" style=\"padding-right: 9px; padding-left: 9px; padding-top: 0; padding-bottom: 0; text-align:center;\"><img align=\"center\" src=\"<%= logo %>\" width=\"300\" style=\"max-width:300px; padding-bottom: 0; display: inline !important; vertical-align: bottom;\" class=\"mcnImage\"></td>';\n\n\t\tthis.treat_template = '<span style=\"font-size:20px\"><span style=\"font-size:12px\">TRATAMIENTO</span><br /><span style=\"font-size:18px\"><%= name %></span>&nbsp;<img align=\"none\" height=\"20\" src=\"https://gallery.mailchimp.com/27d14b96c4fd5949e165b0d69/images/c15b6fd6-dac7-44f1-92fc-b67bcd0d08cb.png\" style=\"width: 20px; height: 20px; margin: 0px 0px -4px;\" width=\"20\" />&nbsp;<span style=\"color:#696969\"><span style=\"font-size:14px\"><%=avgtime%> minutos</span></span></span><br />';\n\n\t\tthis.email_vars = {\n\t\t\twelcome: 'Hola<%= client ? \" \"+client.name : \"\" %>,',\n\t\t\ttitle: '¡Felicidades! Tu reserva ha sido confirmada con éxito.',\n\t\t\tweekday: '<%= weekday %>',\n\t\t\tday: '<%= day.getDate() %>',\n\t\t\tmonth: '<%= month %>',\n\t\t\thour: '<%= iniHour %>',\n\t\t\tmin: '<%= min %> minutos',\n\t\t\tblock_treatments: '<%= block_treatments %>',\n\t\t\tcenter_name: '<%= center.name %>',\n\t\t\tcenter_address: '<%= centerAddress ? centerAddress + ( center.phone ? \" (Tel: \"+center.phone+\")\": \"\") : \"\" %>',\n\t\t\tcenter_path: '<%= center.path %>',\n\t\t\tmap: '<%= map %>',\n\t\t\tfacebook_url: 'https://<%= fb %>',\n\t\t\tweb_url: 'https://<%= web %>',\n\t\t\tcancel_url: '<%= cancel %>'\n\t\t};\n\t},\n\n\tinit : function() {\n\t\tvar that = this;\n\n\t\tthat.preparingEmailAttributes();\n\n\t\tthat.getWork( that.data.idWork, function(work) {\n\t\t\tif( work ) {\n\t\t\t\tthat.work = work;\n\n\t\t\t\tthat.renderAll( that.renderTag , [ 'sms' ], { center: work.center , work : work },\n\t\t\t\t\t//Success function\n\t\t\t\t\tfunction( val ) {\n\t\t\t\t\t\tthat.smsMessage = val[0];\n\t\t\t\t\t\tthat.email.to = that.getClientEmail();\n\t\t\t\t\t\tthat.email.subject = _.template( that.email.subject , work );\n\t\t\t\t\t\tthat.applyEmailVars( that.generateData( work ) );\n\n\t\t\t\t\t\t//Customizing email\n\t\t\t\t\t\tif( (!work.from || work.from.substr(0,2) !== 'p_') && work.center.accountType === \"premium\" ) {\n\t\t\t\t\t\t\tthat.email.template = 'datos-reserva-custom';\n\n\t\t\t\t\t\t\tvar webconfig = work.center.webData && work.center.webData.configs && work.center.webData.configs[0] ? work.center.webData.configs[0].kv : null;\n\t\t\t\t\t\t\tvar logo = webconfig ? _.findWhere( webconfig , { id: 'logo' }) : null;\n\t\t\t\t\t\t\tvar colorHeader = webconfig ? _.findWhere( webconfig , { id: 'color-header' }): null;\n\n\t\t\t\t\t\t\tthat.setVar( 'color' , colorHeader && colorHeader.value ? colorHeader.value[0] : '#ff0b6d' );\n\n\t\t\t\t\t\t\tif( logo && logo.value && logo.value[0] ) {\n\t\t\t\t\t\t\t\t//Custom image header\n\t\t\t\t\t\t\t\tthat.setVar( 'header_block' , _.template( that.header_img_template , _.extend({},work,{ logo: logo.value[0] }) ) );\n\t\t\t\t\t\t\t} else{\n\t\t\t\t\t\t\t\t//Text header\n\t\t\t\t\t\t\t\tthat.setVar( 'header_block' , _.template( that.header_text_template , work  ) );\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthat.completedFn();\n\t\t\t\t\t}\n\t\t\t\t\t//Error function\n\t\t\t\t\t,function(err) {\n\t\t\t\t\t\tconsole.log( err );\n\t\t\t\t\t\tthat.completed( 'none' );\n\t\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthat.completed( 'none' );\n\t\t\t}\n\t\t});\n\t},\n\n\tgenerateData: function( work ) {\n\t\tvar that = this;\n\t\tvar block = _.reduce( work.treatment , function(memo,t){\n\t\t\tif(!t) t = {};\n\t\t\tif(!t.name) t.name = 'Sin especificar';\n\t\t\tif(!t.avgtime) t.avgtime = \"Sin especificar\";\n\t\t\treturn memo += _.template(that.treat_template ,t);\n\t\t},'');\n\t\tif( !block ) {\n\t\t\tblock = _.template( that.treat_template , { name: 'Sin especificar' , avgtime: '~ 60' } );\n\t\t}\n\n\t\tvar pos = \"\";\n\t\tvar map = \"\";\n        if( work.center.location && work.center.location.geo && work.center.location.geo.coordinates ) {\n            pos = work.center.location.geo.coordinates.reverse().join(',');\n            map = '<img src=\"https://maps.googleapis.com/maps/api/staticmap?center='+pos+'&markers=size:mid%7Ccolor:purple%7C'+pos+'&zoom=16&size=564x260&sensor=false\" />';\n        }\n\n\t\tvar objectForExtend = {\n\t\t\tblock_treatments : block,\n\t\t\tweekday \t\t : that.weekdays[ work.day.getDay() ],\n\t\t\tmonth \t\t\t : that.months[ work.day.getMonth() ],\n\t\t\tmin \t\t\t : that.getDuration( work.iniHour , work.fiHour ),\n\t\t\tmap \t\t\t : map,\n\t\t\tfb  \t\t\t : work.center.facebook || 'https://www.facebook.com/Bellahora',\n\t\t\tweb\t\t\t\t : work.center.portal !== 1 || work.center.accountType === \"premium\" ? work.center.web || 'https://bellahora.com/'+work.center.path : 'https://bellahora.com/es/place'+work.center.path+'?utm_source=email_transactional&utm_medium=icono_web&utm_campaign=transactional',\n\t\t\tcenterAddress: that.getCenterAddress(work.center)\n\t\t};\n\n\t\tif(work.client) objectForExtend.cancel = 'http://www.bellahora.com/'+work.center.path+'/s/bookinglist/'+work.client._id;\n\n\t\treturn _.extend( {} , work , objectForExtend);\n\t},\n\n\tgetDuration: function( iniHour , fiHour ) {\n\t\tvar that = this,\n\t\t\tiniArr = iniHour.split(':'),\n\t\t\tfiArr = fiHour.split(':'),\n\t        hourIni = iniArr[0],\n\t        minIni = iniArr[1],\n\t        hourFi = fiArr[0],\n\t        minFi = fiArr[0];\n\n        return (hourFi - hourIni)*60 + (minFi - minIni);\n\t},\n\n\tgetClientEmail: function() {\n\t\tvar client = this.work.client;\n\t\tvar client_email = client ? (client.email && client.email.indexOf(\"@\") !== -1 ? client.email : client.emailHidden) : null;\n\t\treturn client_email;\n\t},\n\n\tgetCenterAddress: function(bhAccount){\n\t\tif(!bhAccount.location)\n\t\t\treturn bhAccount.address || '';\n\t\tvar firstComponent = [];\n\t\tvar secondComponent = [];\n\t\tif(bhAccount.location.stName)\n\t\t\tfirstComponent.push(bhAccount.location.stName);\n\t\tif(bhAccount.location.stNumber)\n\t\t\tfirstComponent.push(bhAccount.location.stNumber);\n\t\tif(bhAccount.location.postcode)\n\t\t\tsecondComponent.push(bhAccount.location.postcode);\n\t\tif(bhAccount.location.city)\n\t\t\tsecondComponent.push(bhAccount.location.city);\n\t\treturn [firstComponent.join(' '), secondComponent.join(' ')].join(', ');\n\t},\n\n\tcompletedFn : function() {\n\t\tvar that = this;\n\t\tthat.completed( that.preferredVia( that.work.client ) !== \"none\" ? \"email\" : \"none\"  );\n\t}\n\n});\n\nmodule.exports = ResConfirmation;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"6":{"range":{"start":{"row":5,"column":4},"end":{"row":5,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"7":{"range":{"start":{"row":4,"column":31},"end":{"row":4,"column":40}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"8":{"range":{"start":{"row":27,"column":245},"end":{"row":27,"column":245}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"9":{"range":{"start":{"row":29,"column":342},"end":{"row":29,"column":342}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"10":{"range":{"start":{"row":31,"column":482},"end":{"row":31,"column":482}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"11":{"range":{"start":{"row":43,"column":114},"end":{"row":43,"column":114}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"12":{"range":{"start":{"row":70,"column":101},"end":{"row":70,"column":101}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"13":{"range":{"start":{"row":73,"column":151},"end":{"row":73,"column":151}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"14":{"range":{"start":{"row":75,"column":92},"end":{"row":75,"column":92}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"15":{"range":{"start":{"row":77,"column":100},"end":{"row":77,"column":100}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"16":{"range":{"start":{"row":81,"column":123},"end":{"row":81,"column":123}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"17":{"range":{"start":{"row":84,"column":88},"end":{"row":84,"column":88}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"18":{"range":{"start":{"row":110,"column":93},"end":{"row":110,"column":93}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"19":{"range":{"start":{"row":115,"column":103},"end":{"row":115,"column":104}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"20":{"range":{"start":{"row":117,"column":171},"end":{"row":117,"column":172}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"21":{"range":{"start":{"row":127,"column":276},"end":{"row":127,"column":276}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"22":{"range":{"start":{"row":131,"column":122},"end":{"row":131,"column":122}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"23":{"range":{"start":{"row":150,"column":124},"end":{"row":150,"column":124}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"24":{"range":{"start":{"row":21,"column":8},"end":{"row":21,"column":16}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"25":{"range":{"start":{"row":27,"column":0},"end":{"row":27,"column":245}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"26":{"range":{"start":{"row":29,"column":0},"end":{"row":29,"column":342}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"27":{"range":{"start":{"row":31,"column":0},"end":{"row":31,"column":482}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"28":{"range":{"start":{"row":33,"column":0},"end":{"row":33,"column":21}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"29":{"range":{"start":{"row":41,"column":0},"end":{"row":41,"column":47}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"30":{"range":{"start":{"row":42,"column":0},"end":{"row":42,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"31":{"range":{"start":{"row":43,"column":0},"end":{"row":43,"column":114}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"32":{"range":{"start":{"row":44,"column":0},"end":{"row":44,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"33":{"range":{"start":{"row":46,"column":0},"end":{"row":46,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"34":{"range":{"start":{"row":47,"column":0},"end":{"row":47,"column":33}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"35":{"range":{"start":{"row":48,"column":0},"end":{"row":48,"column":30}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"36":{"range":{"start":{"row":53,"column":8},"end":{"row":53,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"37":{"range":{"start":{"row":70,"column":101},"end":{"row":70,"column":101}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"38":{"range":{"start":{"row":81,"column":0},"end":{"row":81,"column":123}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"39":{"range":{"start":{"row":84,"column":0},"end":{"row":84,"column":88}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"40":{"range":{"start":{"row":102,"column":8},"end":{"row":102,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"41":{"range":{"start":{"row":104,"column":17},"end":{"row":104,"column":17}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"42":{"range":{"start":{"row":105,"column":24},"end":{"row":105,"column":42}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"43":{"range":{"start":{"row":106,"column":27},"end":{"row":106,"column":48}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"44":{"range":{"start":{"row":106,"column":48},"end":{"row":106,"column":48}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"45":{"range":{"start":{"row":107,"column":0},"end":{"row":107,"column":53}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"46":{"range":{"start":{"row":110,"column":0},"end":{"row":110,"column":93}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"47":{"range":{"start":{"row":113,"column":15},"end":{"row":113,"column":15}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"48":{"range":{"start":{"row":114,"column":15},"end":{"row":114,"column":15}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"49":{"range":{"start":{"row":121,"column":0},"end":{"row":121,"column":28}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"50":{"range":{"start":{"row":127,"column":99},"end":{"row":127,"column":276}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"51":{"range":{"start":{"row":131,"column":24},"end":{"row":131,"column":122}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"52":{"range":{"start":{"row":137,"column":8},"end":{"row":137,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"53":{"range":{"start":{"row":137,"column":12},"end":{"row":137,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"54":{"range":{"start":{"row":149,"column":8},"end":{"row":149,"column":32}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"55":{"range":{"start":{"row":150,"column":0},"end":{"row":150,"column":124}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{"2":{"range":{"start":{"row":31,"column":395},"end":{"row":31,"column":402}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"},"3":{"range":{"start":{"row":77,"column":89},"end":{"row":77,"column":96}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"},"4":{"range":{"start":{"row":117,"column":116},"end":{"row":117,"column":122}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"}},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{"56":{"range":{"start":{"row":31,"column":395},"end":{"row":31,"column":402}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"},"57":{"range":{"start":{"row":77,"column":89},"end":{"row":77,"column":96}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"}},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{"58":{"range":{"start":{"row":31,"column":395},"end":{"row":31,"column":402}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"},"59":{"range":{"start":{"row":77,"column":89},"end":{"row":77,"column":96}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"}},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{"60":{"range":{"start":{"row":31,"column":395},"end":{"row":31,"column":402}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"},"61":{"range":{"start":{"row":77,"column":89},"end":{"row":77,"column":96}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"}},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/res_confirmation.js","digestWhenLastPersisted":"18886f90802411583101f05a0fffcc4b06dbda1c","preferredLineEnding":null,"nextMarkerId":62,"deserializer":"TextBuffer","version":5},{"id":"915af682e56e95cd7e1087a6dd266a0b","text":"var _ = require('underscore'),\n\tBaseHandler = require('./base.js'),\n\twhen = require('promised-io/promise'),\n\tpathProject = '..',\n\tcrypt = require( pathProject + '/common/utils/crypt.js');\n\nvar Stars = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend(Stars.prototype, BaseHandler.prototype , {\n\n\trenderTag : 'stars',\n\n\temail \t  : null,\n\n\t//This handler can send emails also in free accounts\n\tfreeAccountEmail: true,\n\n\tpreparingEmailAttributes: function( json ) {\n\t\tvar that = this;\n\n\t\tthat.email = {\n\t\t\ttemplate: 'opinion',\n\t\t\tto: json.to,\n\t\t\tsubject: '*|USERNAME|*, qué tal ha ido en *|CENTER|*? Puntúanos!',\n\t\t\timportant: true\n\t\t};\n\n\t\tthat.email_vars = {\n\t\t\tusername: json.client.name,\n\t\t\tcenter: json.center.name,\n\t\t\turl: json.url\n\t\t};\n\n\t\tthat.applyEmailVars();\n\t},\n\n\tinit : function() {\n\t\tvar that = this;\n\n\t\tfunction sendStars(client) {\n\t\t\tvar clientEmail = client ? client.email || client.emailHidden : null;\n\n\t\t\tif( client && clientEmail ) {\n\n\t\t\t\tvar idClientEncrypted = new crypt().encrypt( that.data.idClient );\n\n\t\t\t\tvar url = 'https://bellahora.com/public/stars/' + idClientEncrypted;\n\n\t\t\t\tif( client.stars !== true && client.center.ve === 1 ) {\n\n\t\t\t\t\tthat.preparingEmailAttributes({\n\t\t\t\t\t\tcenter: client.center,\n\t\t\t\t\t\tclient: client,\n\t\t\t\t\t\turl: url,\n\t\t\t\t\t\tto: clientEmail\n\t\t\t\t\t});\n\n\t\t\t\t\tthat.completed( that.preferredVia( that.client , true ) !== \"none\" ? \"email\" : \"none\"  );\n\n\t\t\t\t} else {\n\t\t\t\t\tthat.completed( 'none' );\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthat.completed( 'none' );\n\t\t\t}\n\t\t}\n\n\t\tif(that.data.idClient &&\n\t\t   _.isObject(that.data.idClient) &&\n\t\t  (that.data.idClient.email || that.data.idClient.emailHidden)\n\t\t) {\n\t\t\tsendStars(that.data.idClient);\n\t\t} else {\n\t\t\tthat.getClient( that.data.idClient , function( client ){\n\t\t\t\tsendStars(client);\n\t\t\t});\n\t\t}\n\t}\n});\n\nmodule.exports = Stars;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"5":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"6":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"7":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"8":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"9":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"10":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"11":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"12":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"13":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"14":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"15":{"range":{"start":{"row":83,"column":0},"end":{"row":83,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":2,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/stars.js","digestWhenLastPersisted":"28b7a7b0e1936f444a8efdbd7f33995ae2ea6c8d","preferredLineEnding":null,"nextMarkerId":18,"deserializer":"TextBuffer","version":5},{"id":"1b849f14561e8dd7edd2dbd8faf0fa88","text":"var\n//Variables\n    pathProject = '..',\n//Dependencies\n    _ = require('underscore'),\n    dateUtils = require('date-utils'),\n    when = require('promised-io/promise'),\n    BaseHandler = require('./base.js');\n\nvar RecoverPasswordUser = function(config) {\n    this.preInit.apply(this, arguments);\n};\n\n_.extend( RecoverPasswordUser.prototype, BaseHandler.prototype , {\n\n    email : null,\n    freeAccountEmail : true,\n\n    getEmails : function( accounts ) {\n        var that = this,\n            retPromise = new when.Deferred();\n        retPromise.resolve([that.data.json.email]);\n        return retPromise;\n    },\n    init : function() {\n        var that = this;\n        var sendEmail = function (emails) {\n            that.email = {\n                from_email \t\t   \t: \"contacta@bellahora.com\",\n                from_name \t\t   \t: \"Bellahora\",\n                to \t\t\t  \t   \t: emails,\n                subject\t\t\t\t: \"Recupera tu contraseña de Bellahora\",\n                template:\"recover-password\",\n                important: true,\n                merge:true,\n                merge_language: \"mailchimp\",\n                global_merge_vars: [{\n                    name: \"NAME\",\n                    content:that.data.json.name\n                }, {\n                    name: \"LINK\",\n                    content:that.data.json.link\n                }]\n            };\n            that.completed(\"email\");\n        };\n\n        that.getEmails().then(sendEmail);\n    }\n});\n\nmodule.exports = RecoverPasswordUser;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"4":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"5":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"7":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"8":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"9":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"10":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"11":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"12":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"13":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"14":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"15":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"16":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"17":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"18":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"19":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"20":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"21":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"22":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"23":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"24":{"range":{"start":{"row":52,"column":0},"end":{"row":52,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":2,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/user_password_recover.js","digestWhenLastPersisted":"d3e15a52167fa635ad65b7ef2fa5e98c49157d5e","preferredLineEnding":null,"nextMarkerId":27,"deserializer":"TextBuffer","version":5},{"id":"e1994b895f5d0011555f01cc685dc232","text":"var _ = require('underscore'),\n\tBaseHandler = require('./base.js');\n\nvar UserWelcome = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend(UserWelcome.prototype, BaseHandler.prototype , {\n\n\trenderTag: \"user_bh_welcome\",\n\n\temail : null,\n\n\ttargetType: 'user',\n\n\tfreeAccountEmail: true,\n\n\tcanUnsubscribe: true,\n\n\tinit : function() {\n\t\tvar that = this;\n\n\t\tthat.idUser = that.data.idUser;\n\t\tthat.idPreUser = that.data.idPreUser;\n\n\t\tvar query = that.idUser ? that.getModel('User').findById( that.idUser ) : that.getModel('PreUser').findById( that.idPreUser );\n\n\t\tquery.exec(function( err , user ) {\n\n\t\t\tthat.user = user;\n\n\t\t\tif( user && user.email ) {\n\n\t\t\t\tthat.email = {\n\t\t\t\t\tfrom_email \t\t   : \"contacta@bellahora.com\",\n\t\t\t\t\tfrom_name \t\t   : \"Bellahora\",\n\t\t\t\t\tto \t\t\t  \t   : user.email,\n\t\t\t\t\tsubject \t\t   : '¡Bienvenid' + (user.gender === \"male\" ? 'o' : user.gender === \"female\" ? 'a' : '@')+' '+user.name+'! Reserva fácilmente tus citas de bellahora - 10€ de regalo para ti',\n\t\t\t\t\ttemplate \t\t   : \"bh-bienvenida\",\n\t\t\t\t\timportant: true\n\t\t\t\t};\n\n\t\t\t\tthat.setVar( 'unsub' , 'https://bellahora.com/user/unsubscribe/' + that.encrypt( user.email ) );\n\n\t\t\t\tconsole.log( that.email );\n\t\t\t\tthat.completed( 'email' );\n\n\t\t\t} else {\n\n\t\t\t\tthat.completed( 'none' );\n\t\t\t}\n\t\t});\n\t}\n});\n\nmodule.exports = UserWelcome;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":4,"column":4},"end":{"row":4,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"4":{"range":{"start":{"row":3,"column":27},"end":{"row":3,"column":36}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"5":{"range":{"start":{"row":25,"column":128},"end":{"row":25,"column":128}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"6":{"range":{"start":{"row":37,"column":189},"end":{"row":37,"column":189}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"7":{"range":{"start":{"row":42,"column":100},"end":{"row":42,"column":100}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"8":{"range":{"start":{"row":9,"column":30},"end":{"row":9,"column":30}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"9":{"range":{"start":{"row":20,"column":8},"end":{"row":20,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"10":{"range":{"start":{"row":34,"column":0},"end":{"row":34,"column":48}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"11":{"range":{"start":{"row":34,"column":48},"end":{"row":34,"column":48}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"12":{"range":{"start":{"row":35,"column":0},"end":{"row":35,"column":34}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"13":{"range":{"start":{"row":35,"column":34},"end":{"row":35,"column":34}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"14":{"range":{"start":{"row":37,"column":79},"end":{"row":37,"column":189}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"15":{"range":{"start":{"row":37,"column":112},"end":{"row":37,"column":189}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"16":{"range":{"start":{"row":38,"column":37},"end":{"row":38,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"12":{"id":"12","maintainHistory":false,"markersById":{},"version":2},"13":{"id":"13","maintainHistory":false,"markersById":{},"version":2},"14":{"id":"14","maintainHistory":false,"markersById":{},"version":2},"22":{"id":"22","maintainHistory":false,"markersById":{},"version":2},"23":{"id":"23","maintainHistory":false,"markersById":{},"version":2},"31":{"id":"31","maintainHistory":false,"markersById":{},"version":2},"32":{"id":"32","maintainHistory":false,"markersById":{},"version":2},"42":{"id":"42","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":43,"history":{"version":3,"nextCheckpointId":1,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/user_welcome.js","digestWhenLastPersisted":"43a21547d897c4d2002d629f5763798515578e35","preferredLineEnding":null,"nextMarkerId":18,"deserializer":"TextBuffer","version":5},{"id":"be1ea8219b0fa8d3b9320ae5924e89f6","text":"var\n//Variables\npathProject = '..',\n//Dependencies\n_ = require('underscore'),\ndateUtils = require('date-utils'),\nejs = require('ejs'),\nwhen = require('promised-io/promise'),\nknox = require('knox'),\nfs = require('fs'),\nCrypt = require( '../common/utils/crypt.js' ),\n//Own dependencies\nmapper = require(pathProject+\"/common/utils/mapper.js\"),\nemailExistence = require('email-existence'),\nObjectId = require('mongoose').Types.ObjectId;\n\nvar logger = require('../common/utils/logentries')();\n_.str = require('underscore.string');\n\nvar BaseHandler = function(config) {\n\tthis.preInit.apply(this, arguments);\n};\n\n_.extend( BaseHandler.prototype , {\n\t//Constants\n\tNO_ALERTS : 0,\n\tALERT_EMAIL : 1,\n\tALERT_WHATSAPP : 2,\n\tweekdays : [\"Domingo\", \"Lunes\", \"Martes\", \"Miércoles\", \"Jueves\", \"Viernes\", \"Sábado\"],\n\tmonths : [\"Enero\", \"Febrero\", \"Marzo\", \"Abril\", \"Mayo\", \"Junio\", \"Julio\", \"Agosto\", \"Septiembre\", \"Octubre\", \"Noviembre\", \"Diciembre\"],\n\n\t//Target\n\ttargetType: 'client', //client|user|employee\n\n\t//Attributes\n\tdata : null,\n\tcompleted : null,\n\n\tcache : null,\n\n\tpremiumAccount: null,\n\n\tbhaccount : null,\n\n\t/**\n\t * If is true, an optimization can be applied. Because you can send in one request an array of emails.\n\t */\n\tgroupable: false,\n\n\t//Methods\n\tpreInit: function(config) {\n\t\tvar that = this;\n\t\tthat.cache = config.cache;\n\t\tthat.data = config.pollmessage;\n\t\tthat.whenResolved = config.whenResolved;\n\t\tthat.completed = config.callback;\n\t\tthat.init();\n\t},\n\n\t/**\n\t* Makes the main process of the handler\n\t*/\n\tinit: function() {},\n\n\t/**\n\t * Set a merge variable on an email\n\t */\n\tsetVar: function( a_key , value ) {\n\t\tvar key = a_key.toUpperCase();\n\n\t\tif(!this.email) {\n\t\t\tthis.email = {};\n\t\t}\n\t\tif(!this.email.global_merge_vars) {\n\t\t\tthis.email.global_merge_vars = [];\n\t\t}\n\n\t\tif( _.where( this.email.global_merge_vars , { name: key }).length > 0 ) {\n\t\t\t_.where( this.email.global_merge_vars , { name: key })[0].content = value;\n\t\t} else {\n\t\t\tthis.email.global_merge_vars.push({\n\t\t\t\tname \t: key,\n\t\t\t\tcontent : value\n\t\t\t});\n\t\t}\n\n\t\treturn this;\n\t},\n\n\tapplyEmailVars: function( data , a_obj ) {\n\t\tvar obj = a_obj || _.result( this , 'email_vars' );\n\t\tfor( var name in obj ) {\n\t\t\tthis.setVar( name , data ? _.template( obj[ name ] , data ) : obj[ name ] );\n\t\t}\n\t},\n\n\tencrypt: function( str ) {\n\t\tvar crypt = new Crypt( 'e7w95d4f9wd52g' );\n\t\treturn str ? crypt.encrypt( str ) : '';\n\t},\n\n\tload : function( model , findjson ) {\n\t\tvar that = this , def = when.Deferred();\n\n\t\tif( typeof findjson === \"function\" ) {\n\t\t\tfindjson( that.getModel( model ) , function( data ){\n\t\t\t\tdef.resolve( data );\n\t\t\t});\n\t\t} else {\n\t\t\tthat.getModel( model ).find( findjson , function(arr, objs) {\n\t\t\t\tdef.resolve( objs );\n\t\t\t});\n\t\t}\n\n\t\treturn def.promise;\n\t},\n\n\tgetModel : function( strModel ) {\n\t\tvar model = require( pathProject + '/common/model/'+strModel+'.js').model();\n\t\tmodel.idBHAccount = this.idBHAccount;\n\t\treturn model;\n\t},\n\n\tpromise: function() {\n\t\treturn new when.Deferred();\n\t},\n\n\tloadEmailSource : function( bhaccount ) {\n\t\tvar that = this;\n\n\t\tif( bhaccount ) {\n\n\t\t\tif( bhaccount.domainEmail && bhaccount.domainEmail.length > 0 ) {\n\n\t\t\t\tthat.emailSource = bhaccount.domainEmail;\n\n\t\t\t} else if( bhaccount.domain && bhaccount.domain.length > 0 ) {\n\n\t\t\t\tthat.emailSource = \"email@\"+bhaccount.domain;\n\n\t\t\t} else {\n\n\t\t\t\tthat.emailSource = bhaccount.path.replace(/[^a-z\\d\\.\\-\\_]+/gi, \"\")+\"@mail.bellahora.com\";\n\t\t\t}\n\n\t\t\tthat.nameSource = bhaccount.name;\n\n\t\t\tif( bhaccount.accountType === \"premium\" || bhaccount.accountType === \"free-booking\" ) {\n\n\t\t\t\tthat.premiumAccount = true;\n\t\t\t}\n\t\t\treturn;\n\n\t\t} else {\n\t\t\tvar prom = new when.Deferred();\n\n\t\t\tif( that.idBHAccount ) {\n\t\t\t\tthat.getMapper('BHAccount').findById( that.idBHAccount , function(arr, a_bhaccount) {\n\n\t\t\t\t\tif( a_bhaccount && a_bhaccount.domainEmail && a_bhaccount.domainEmail.length > 0 ) {\n\n\t\t\t\t\t\tthat.emailSource = a_bhaccount.domainEmail;\n\n\t\t\t\t\t} else if( a_bhaccount && a_bhaccount.domain && a_bhaccount.domain.length > 0 ) {\n\n\t\t\t\t\t\tthat.emailSource = \"no-responder@\"+a_bhaccount.domain;\n\t\t\t\t\t}\n\n\t\t\t\t\tif( a_bhaccount && a_bhaccount.accountType === \"premium\" ) {\n\t\t\t\t\t\tthat.premiumAccount = true;\n\t\t\t\t\t}\n\t\t\t\t\tprom.resolve();\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tprom.resolve();\n\t\t\t}\n\n\t\t\treturn prom.promise;\n\t\t}\n\t},\n\n\t/**\n\t* Get work data and its immediate references : (idTreatment, idClient)\n\t*/\n\tgetWork: function( idWork , callback) {\n\t\tvar that = this;\n\t\tvar processWhenWork = function( a_work ) {\n\n\t\t\tthat.idBHAccount = a_work._idBHAccount;\n\n\t\t\tvar work = a_work.toJSON ? a_work.toJSON() : a_work;\n\n\t\t\tif( !work.proc ) {\n\t\t\t\twork.proc = {};\n\t\t\t}\n\t\t\tif( work.day ) {\n\t\t\t\tvar date = new Date( work.day );\n\t\t\t\twork.proc.day = that.weekdays[ date.getDay() ] + \", \" + date.getDate()+\" de \" + that.months[ date.getMonth() ];\n\t\t\t}\n\n\t\t\tvar prom = [];\n\n\t\t\t//Load Email source\n\t\t\tprom.push( that.loadEmailSource() );\n\n\t\t\t//Load Client\n\t\t\tif( work.idClient && work.idClient.length > 0 ) {\n\t\t\t\tvar pclient = new when.Deferred();\n\t\t\t\tthat.getClient( work.idClient, function(client){\n\t\t\t\t\twork.client = client || {};\n\t\t\t\t\tpclient.resolve();\n\t\t\t\t});\n\n\t\t\t\tprom.push( pclient.promise );\n\t\t\t} else {\n\t\t\t\twork.client = {};\n\t\t\t}\n\t\t\t//------------\n\n\n\t\t\t//Load BHAccount\n\t\t\tvar promBHAccount = new when.Deferred();\n\t\t\tthat.getBHAccount( work._idBHAccount , function( bhaccount ) {\n\t\t\t\twork.center = bhaccount;\n\t\t\t\tpromBHAccount.resolve();\n\t\t\t});\n\t\t\tprom.push( promBHAccount.promise );\n\t\t\t//---------------\n\n\n\t\t\tif(typeof work.idTreatment === \"string\") {\n\t\t\t\tvar aux = work.idTreatment;\n\t\t\t\twork.idTreatment = [ aux ];\n\t\t\t\t// Eliminamos valores nulos.\n\t\t\t\twork.idTreatment = _.without(work.idTreatment, null, undefined);\n\t\t\t}\n\n\n\t\t\t_.each( work.idTreatment , function( id ) {\n\t\t\t\tif(id && id.length > 0 ) {\n\t\t\t\t\tvar p = new when.Deferred();\n\t\t\t\t\tprom.push( p.promise );\n\n\t\t\t\t\tthat.getMapper('Treatment').findById( id , function( arr, a_treatment ) {\n\t\t\t\t\t\tvar treatment = a_treatment ? a_treatment.toJSON() : null;\n\n\t\t\t\t\t\tif( treatment && ( treatment.name || treatment.category ) ) {\n\t\t\t\t\t\t\tvar category = treatment.category || '',\n\t\t\t\t\t\t\tname =  treatment.name || '';\n\t\t\t\t\t\t\ttreatment.fullname = (category.length > 0 && name.length > 0) ? category+\": \"+name : (category+name);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif( !work.treatment ) {\n\t\t\t\t\t\t\twork.treatment = [];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif( treatment ) {\n\t\t\t\t\t\t\twork.treatment.push( treatment );\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tp.resolve();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\twhen.all( prom ).then( function(){\n\t\t\t\tcallback( work );\n\t\t\t});\n\t\t};\n\n\t\tthat.getMapper('Work').findById( idWork, function(err, a_work){\n\t\t\tif( !a_work ) {\n\t\t\t\tcallback( null );\n\t\t\t} else {\n\t\t\t\tprocessWhenWork( a_work );\n\t\t\t}\n\t\t});\n\t},\n\n\t/**\n\t* Get employee data\n\t*/\n\tgetEmployee : function( idEmployee , callback ) {\n\t\tvar that = this, prom = new when.Deferred();\n\n\t\tthat.getMapper('Employee').findById( idEmployee , function(err, a_employee) {\n\n\t\t\tthat.idBHAccount = a_employee._idBHAccount;\n\n\t\t\tvar employee = a_employee.toJSON();\n\n\t\t\tthat.getBHAccount( employee._idBHAccount , function(a_bhaccount) {\n\n\t\t\t\temployee.center = that.bhaccount;\n\n\t\t\t\t//Callback\n\t\t\t\tif( callback ) callback( employee );\n\t\t\t\tprom.resolve( employee );\n\t\t\t});\n\t\t});\n\n\t\treturn prom.promise;\n\t},\n\n\t/**\n\t* Get client data\n\t*/\n\tgetClient: function( idClient, callback ) {\n\t\tvar that = this, prom = new when.Deferred();\n\n\t\tthat.getMapper('Client').findById( idClient , function(arr, a_client) {\n\n\t\t\tif( a_client ) {\n\t\t\t\tthat.idBHAccount = a_client._idBHAccount;\n\t\t\t\tthat.client = a_client.toJSON();\n\n\t\t\t\tthat.getBHAccount( that.client._idBHAccount , function( bhaccount ) {\n\t\t\t\t\tthat.client.center = bhaccount;\n\n\t\t\t\t\t//Callback\n\t\t\t\t\tif( callback ) callback( that.client );\n\t\t\t\t\tprom.resolve( that.client );\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t//Callback\n\t\t\t\tif( callback ) callback( null );\n\t\t\t\tprom.resolve( null );\n\t\t\t}\n\n\t\t});\n\n\t\treturn prom.promise;\n\t},\n\n\t/**\n\t* Gets BHAccount\n\t*/\n\tgetBHAccount: function( idBHAccount , callback ) {\n\t\tvar that = this, prom = new when.Deferred();\n\n\t\tthat.getMapper('BHAccount').findById( idBHAccount , function(err, a_bhaccount) {\n\n\t\t\tvar bhaccount = that.bhaccount = a_bhaccount.toJSON();\n\n\t\t\tthat.loadEmailSource( a_bhaccount );\n\n\t\t\tvar promises = [];\n\n\t\t\t//BHAccount Province\n\t\t\tif( bhaccount.province ) {\n\t\t\t\tvar prom1 = new when.Deferred();\n\t\t\t\tpromises.push( prom1.promise );\n\t\t\t\tthat.getMapper('Province').findById( bhaccount.province , function( arr , data ) {\n\t\t\t\t\tprom1.resolve( data ? data.toJSON() : null );\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tpromises.push( null );\n\t\t\t}\n\t\t\t//------------------\n\n\t\t\t//BHAccount Town\n\t\t\tif( bhaccount.town ) {\n\t\t\t\tvar prom2 = new when.Deferred();\n\t\t\t\tpromises.push( prom2.promise );\n\t\t\t\tthat.getMapper('Town').findById( bhaccount.town , function( arr , data ) {\n\t\t\t\t\tprom2.resolve( data ? data.toJSON() : null );\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tpromises.push( null );\n\t\t\t}\n\t\t\t//------------------\n\n\t\t\t//BHAccount extended\n\t\t\tvar prom3 = new when.Deferred();\n\t\t\tpromises.push( prom3.promise );\n\t\t\tthat.getMapper( 'BHAccountExtended' , idBHAccount ).find( {} , function( arr, a_bhaccountextended ) {\n\t\t\t\tif( a_bhaccountextended && a_bhaccountextended.length > 0 ) {\n\t\t\t\t\tprom3.resolve( a_bhaccountextended[0].toJSON() );\n\t\t\t\t} else {\n\t\t\t\t\tprom3.resolve( null );\n\t\t\t\t}\n\t\t\t});\n\t\t\t//------------------\n\n\t\t\t//BHAccount Country\n\t\t\tvar prom0 = new when.Deferred();\n\t\t\tpromises.push( prom0.promise );\n\t\t\tthat.getMapper('Country').find({ idKey: bhaccount.country || 'es' } , function( err , data ) {\n\t\t\t\tprom0.resolve( data && data.length > 0 ? data[0].toJSON() : null );\n\t\t\t});\n\t\t\t//-----------------\n\n\t\t\t//BHAccount Web\n\t\t\tvar prom4 = new when.Deferred();\n\t\t\tpromises.push( prom4.promise );\n\t\t\tthat.getMapper('Web', idBHAccount).find({} , function( err , data ) {\n\t\t\t\tprom4.resolve( data && data.length > 0 ? data[0].toJSON() : null );\n\t\t\t});\n\t\t\t//-------------\n\n\t\t\twhen.all( promises ).then( function( data ) {\n\n\t\t\t\tif( data[0] ) {\n\t\t\t\t\tbhaccount.province = data[0];\n\t\t\t\t}\n\n\t\t\t\tif( data[1] ) {\n\t\t\t\t\tbhaccount.town = data[1];\n\t\t\t\t}\n\n\t\t\t\tif( data[2] ) {\n\t\t\t\t\tbhaccount.extended = data[2];\n\t\t\t\t}\n\n\t\t\t\tif( data[3] ) {\n\t\t\t\t\tbhaccount.country = data[3];\n\t\t\t\t}\n\n\t\t\t\tif( data[4] ) {\n\t\t\t\t\tbhaccount.webData = data[4];\n\t\t\t\t}\n\n\t\t\t\t//Callback\n\t\t\t\tif( callback ) callback( bhaccount );\n\t\t\t\tprom.resolve( bhaccount );\n\t\t\t});\n\t\t});\n\n\t\treturn prom.promise;\n\t},\n\n\t/**\n\t* Returns the corresponding mapper\n\t*/\n\tgetMapper : function( name , idBHAccount ) {\n\t\tif( name === \"BHAccount\" || name === \"BHPollMessage\" || name === \"Link\" ) {\n\t\t\treturn new mapper({ noBHAccount : true }).loadModel( name );\n\t\t} else {\n\t\t\tif( !idBHAccount ) {\n\t\t\t\tif(this.work) {\n\t\t\t\t\tidBHAccount = this.work._idBHAccount;\n\t\t\t\t}\n\t\t\t\tif(this.client) {\n\t\t\t\t\tidBHAccount = this.client._idBHAccount;\n\t\t\t\t}\n\t\t\t\tif(this.campaign) {\n\t\t\t\t\tidBHAccount = this.campaign._idBHAccount;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif( idBHAccount) {\n\t\t\t\treturn new mapper({ idBHAccount : idBHAccount }).loadModel( name );\n\t\t\t} else {\n\t\t\t\treturn new mapper().loadModel( name );\n\t\t\t}\n\t\t}\n\t},\n\n\n\t/**\n\t* Getting a name file template .html, will return the message processed.\n\t*/\n\trenderFromTemplate : function(nameTemplate, data, callback, callbackErr) {\n\t\tvar that = this,\n\t\tdef = new when.Deferred();\n\n\t\tvar p1 = that.customizeMail( data );\n\n\t\tvar defp2 = new when.Deferred(), p2 = defp2.promise;\n\t\tthat.getTemplate( './templates/'+nameTemplate+'.html',\n\t\tfunction(a_fn) { defp2.resolve( a_fn ); });\n\n\t\twhen.all( [ p1 , p2 ] ).then( function( arr_values ) {\n\t\t\tvar a_fn = arr_values[1];\n\t\t\tif( typeof a_fn !== \"function\" ) logger.log(a_fn);\n\n\t\t\tvar str = \"\";\n\n\t\t\ttry {\n\t\t\t\tstr = a_fn( data );\n\t\t\t\tif(callback) callback( str );\n\t\t\t\tdef.resolve( str );\n\t\t\t} catch( err ) {\n\t\t\t\tif( callbackErr ) callbackErr( err );\n\t\t\t\tdef.reject( err , true );\n\t\t\t}\n\t\t});\n\n\t\treturn def.promise;\n\t},\n\n\tgetTemplate: function( path , callback ) {\n\t\tvar options = { client: true };\n\n\t\toptions.filename = path;\n\n\t\ttry {\n\t\t\tvar str = fs.readFileSync(path, 'utf8');\n\t\t\tvar comp = ejs.compile(str, options);\n\t\t\tcallback(comp);\n\t\t} catch (err) {\n\t\t\tlogger.log(err);\n\t\t\tcallback(err);\n\t\t}\n\t},\n\n\tcustomizeMail : function( data ) {\n\t\tvar ret_def = new when.Deferred(),\n\t\tthat = this, connection = null,\n\t\tconnect = function() {\n\t\t\tif( connection ) return connection;\n\t\t\treturn connection = knox.createClient({\n\t\t\t    key: 'AKIAI452K7PQRA5GSO7A'\n\t\t\t  , secret: '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'\n\t\t\t  , bucket: 'bellahora'\n\t\t\t});\n\t\t},\n\t\tread = function( path , fn ) {\n\t\t\tvar def = new when.Deferred();\n\t\t\tconnect().getFile( path , function(err, res){\n\t\t\t\tfn( err , res , def );\n\t\t\t});\n\t\t\treturn def.promise;\n\t\t}\n\t\treadStatus = function( path ) {\n\t\t\tif( that.cache.status[ path ] ) return that.cache.status[ path ];\n\t\t\treturn read( path , function( err , res , def ) {\n\t\t\t\tvar status = (res && res.statusCode) ? res.statusCode : 404;\n\t\t\t\tdef.resolve( that.cache.status[ path ] = status );\n\t\t\t});\n\t\t},\n\t\treadFile = function( path , callback ) {\n\t\t\tif( that.cache.css[ path ] ) return that.cache.css[ path ];\n\n\t\t\treturn read( path , function( err , res , def ) {\n\t\t\t\tif( !err && res && res.statusCode === 200 ) {\n\t\t\t\t\tres.setEncoding('utf8');\n\t\t\t\t\tres.on('data', function(chunk){\n\t\t\t\t\t\tdef.resolve( that.cache.css[ path ] = chunk );\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tdef.resolve( that.cache.css[ path ] = null );\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\n\t\t//CSS and Logo\n\t\tvar p1,p2;\n\t\tif( data.center && data.center.path ) {\n\t\t\tvar path = data.center.path;\n\t\t\tp1 = readFile( '/profiles/'+path+'/css/email.css' );\n\t\t\tp2 = readStatus( '/profiles/'+path+'/img/logo.png' );\n\t\t}\n\n\t\twhen.all( [ p1 , p2 ] ).then( function( arr_values ) {\n\t\t\tdata.customCss = arr_values[0];\n\t\t\tdata.logo = arr_values[1] === 200;\n\t\t\tret_def.resolve();\n\t\t});\n\n\t\treturn ret_def.promise;\n\t},\n\n\t/**\n\t* To render multiple templates at the same time.\n\t*/\n\trenderAll : function( nameBase , arr_renders , data , callback , callbackErr ) {\n\t\tvar def = new when.Deferred(), promises = [];\n\n\t\tfor(var i = 0; i < arr_renders.length; i++) {\n\t\t\tpromises.push( this.renderFromTemplate( nameBase + \"_\" + arr_renders[i] , data ) );\n\t\t}\n\n\t\twhen.all( promises ).then(\n\t\t\t//Success callback\n\t\t\tfunction(arr_values){\n\n\t\t\t\tif(callback) callback( arr_values );\n\t\t\t\tdef.resolve( arr_values );\n\n\t\t\t//Error callback\n\t\t\t}, function(err) {\n\t\t\t\tif(callbackErr) callbackErr(err);\n\t\t\t\tdef.reject( err , true );\n\t\t\t});\n\n\t\treturn def.promise;\n\t},\n\n\n\t/**\n\t* Returns the preferred via\n\t* @public\n\t* @param {Object}  client\n\t* @param {Boolean} strictMode Can return 'none' if the user dont want to be notified. Default: false\n\t*/\n\tpreferredVia : function( client , strictMode ) {\n\t\tvar that = this,\n\t\tcenter = client.center,\n\t\treturnedVia = 'none',\n\t\tSMS = 'sms',\n\t\tEMAIL = 'email';\n\n\t\tif( client && center ) {\n\n\t\t\t//Check smsPriority\n\t\t\tif( (!center.smsPriority || center.smsPriority === 0) && (client.email || client.emailHidden) ) {\n\t\t\t\treturnedVia = EMAIL;\n\t\t\t}\n\n\t\t\tif( center.smsPriority === 1 && client.phone ) {\n\t\t\t\treturnedVia = SMS;\n\t\t\t} else if( !(center.sms > 0) ) {\n\t\t\t\treturnedVia = EMAIL;\n\t\t\t}\n\n\t\t\tif( center.smsPriority === 2 ) {\n\t\t\t\tif( client.email || client.emailHidden ) {\n\t\t\t\t\treturnedVia = EMAIL;\n\t\t\t\t} else if( client.phone ) {\n\t\t\t\t\treturnedVia = SMS;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn returnedVia;\n\t},\n\n\t/**\n\t* Taking a client object, it extracts the mobile phone if exists.\n\t* @public\n\t* Return the mobile phone client or null.\n\t*/\n\tgetPhoneFromClient: function( client ) {\n\t\tvar retphone = null,\n\t\tphones = [],\n\t\tfn_extractphones = function( str ) {\n\t\t\tif( str.indexOf(\"/\") !== -1 ) {\n\t\t\t\t_.each( str.split(\"/\") , function(p){\n\t\t\t\t\tphones.push( _.str.trim( p ) );\n\t\t\t\t});\n\t\t\t} else if( str.indexOf(\"-\") !== -1 ) {\n\t\t\t\t_.each( str.split(\"-\") , function(p){\n\t\t\t\t\tphones.push( _.str.trim( p ) );\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tphones.push( str );\n\t\t\t}\n\t\t};\n\n\t\tif( client.phone ) {\n\t\t\tfn_extractphones( client.phone );\n\t\t}\n\t\tif( client.phone2 ) {\n\t\t\tfn_extractphones( client.phone2 );\n\t\t}\n\n\t\t_.each( phones , function( phone ){\n\t\t\tif( retphone === null && phone.length === 9 && ( phone.charAt(0) === \"6\" || phone.charAt(0) === \"7\" ) ) {\n\t\t\t\tretphone = phone;\n\t\t\t}\n\t\t});\n\n\t\treturn retphone;\n\t},\n\n\tgetPushDevices: function( target ) {\n\t\tvar ret = null;\n\n\t\tif( target && (target.pushios.length > 0 || target.pushandroid.length > 0) ) {\n\t\t\tret = {\n\t\t\t\tios \t: target.pushios || [],\n\t\t\t\tandroid : target.pushandroid || []\n\t\t\t};\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\t/**\n\t* Renders a Message depending on wich via will be delivered\n\t* @public\n\t* @param {string} via\n\t*/\n\tgetMessageVia : function( nameVia ) {\n\t\tif( this.via[ nameVia ] ) {\n\t\t\treturn this.via[ nameVia ].call(this);\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t},\n\n\t/**\n\t* Vias by default. Sometimes it needs to be redefined.\n\t*/\n\tvia: {\n\n\t\tpush: function() {\n\t\t\tvar target = this[ this.targetType ];\n\t\t\treturn {\n\t\t\t\ttargetType: this.targetType,\n\t\t\t\ttarget : target,\n\t\t\t\tdevices: this.getPushDevices( target ),\n\t\t\t\ttitle: this.title,\n\t\t\t\textraData: this.extraData,\n\t\t\t\tmessage: this.pushMessage || this.smsMessage\n\t\t\t};\n\t\t},\n\n\t\tsms : function() {\n\t\t\tvar that = this,\n\t\t\tclient = that.client ? that.client : ( that.work ? that.work.client : null ),\n\t\t\tphone = client ? that.getPhoneFromClient( client ) : null;\n\n\t\t\treturn [ that.smsMessage , phone , that.bhaccount ];\n\t\t},\n\n\t\temail : function() {\n\t\t\tvar that = this;\n\n\t\t\tif( !that.email ) { that.email = {}; }\n\n\t\t\tthat.email.tags = [];\n\t\t\tif( that.renderTag ) {\n\t\t\t\tthat.email.tags.push( that.renderTag );\n\t\t\t}\n\t\t\tif( that.extraTags ) {\n\t\t\t\tthat.email.tags = that.email.tags.concat( that.extraTags );\n\t\t\t}\n\n\t\t\tif( that.emailSource ) {\n\t\t\t\tthat.email.from_email = that.emailSource;\n\t\t\t}\n\n\t\t\tif( that.nameSource ) {\n\t\t\t\tthat.email.from_name = that.nameSource;\n\t\t\t}\n\n\t\t\tif( (that.premiumAccount && that.premiumAccount === true) || that.freeAccountEmail === true ) {\n\t\t\t\treturn that.email;\n\t\t\t} else {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\n\t},\n\n\t/**\n\t* Change the state of the email client/employee to hard-bounce.\n\t* pre: the hundle must have a client attribute.\n\t*/\n\tsetHardBounce: function( bool ) {\n\t\tthat.getMapper('Client').update( { _id : this.client._id } , { isHardBounce: bool } , function( err , data) {});\n\t},\n\n\t/**\n\t* returns true if email === emailChecked and is not hardBounce\n\t* otherwise check if emailChecked is a valid account and return true or false depending of it\n\t*\n\t* callback is used for retro-compatibility\n\t*/\n\tcheckEmail: function( callback ) {\n\t\tvar that = this;\n\t\tvar ret = true;\n\n\t\tthat.callback = callback;\n\n\t\tif( that.client && that.targetType === 'client' ) {\n\t\t\tret = !that.client.isHardBounce;\n\t\t\tif( callback ) callback( ret , 'HardBounce' );\n\t\t} else if( that.employee && that.targetType === 'employee' && that.canUnsubscribe === true ) {\n\t\t\tret = !that.employee.isUnsubscribed;\n\t\t\tif( callback ) callback( ret , 'Unsubscribed' );\n\t\t} else if( that.user && that.targetType === 'user' ) {\n\t\t\tret = !that.user.isUnsubscribed;\n\t\t\tif( callback ) callback( ret , 'Unsubscribed' );\n\t\t} else {\n\t\t\tif( callback ) callback( true );\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\t/**\n\t * Add the message result status to the log\n\t * @param a_data { via , number , email , state }\n\t */\n\taddToPullerLog: function( a_data ) {\n\t\tvar that = this;\n\n\t\tif( that.idBHAccount ) {\n\n\t\t\tvar LogPuller = that.getModel('LogPuller');\n\t\t\tvar data = _.extend( {},{\n\t\t\t\t_idBHAccount : that.idBHAccount,\n\t\t\t\tdate \t\t : new Date(),\n\t\t\t\ttype \t\t : that.renderTag,\n\t\t\t\tmessage \t : a_data.via === \"email\" ? that.email.subject : that.smsMessage\n\t\t\t} , a_data );\n\n\t\t\tif( that.targetType === \"client\" ) {\n\t\t\t\tdata.idClient = that.client ? that.client._id : null;\n\t\t\t}\n\t\t\tif( that.targetType === \"employee\" ) {\n\t\t\t\tdata.idEmployee = that.employee ? that.employee._id : null;\n\t\t\t}\n\n\t\t\tLogPuller.create( data , function(err, obj) {} );\n\t\t}\n\t}\n});\n\nmodule.exports = BaseHandler;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"12":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"13":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"14":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"15":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"16":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"17":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"18":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"never"},"19":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"20":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"21":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"22":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"23":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"24":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"25":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"26":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"27":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"28":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"29":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"30":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"31":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"32":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"33":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"34":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"35":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"36":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"37":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"38":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"39":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"40":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"41":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"42":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"43":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"44":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"45":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"46":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"47":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"48":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"49":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"50":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"51":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"52":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"53":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"54":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"55":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"56":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"57":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"58":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"59":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"60":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"61":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"62":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"63":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"64":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"65":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"66":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"67":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"68":{"range":{"start":{"row":813,"column":0},"end":{"row":813,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"5":{"id":"5","maintainHistory":false,"markersById":{},"version":2},"6":{"id":"6","maintainHistory":false,"markersById":{},"version":2},"7":{"id":"7","maintainHistory":false,"markersById":{},"version":2},"15":{"id":"15","maintainHistory":false,"markersById":{},"version":2},"16":{"id":"16","maintainHistory":false,"markersById":{},"version":2},"24":{"id":"24","maintainHistory":false,"markersById":{},"version":2},"25":{"id":"25","maintainHistory":false,"markersById":{},"version":2},"35":{"id":"35","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":36,"history":{"version":3,"nextCheckpointId":2,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/puller/handlers/base.js","digestWhenLastPersisted":"16e720f33d8de73992fc63dcc544fbc8af904572","preferredLineEnding":null,"nextMarkerId":76,"deserializer":"TextBuffer","version":5}]},"workspace":{"deserializer":"Workspace","paneContainer":{"deserializer":"PaneContainer","version":1,"root":{"deserializer":"Pane","id":3,"items":[{"deserializer":"TextEditor","id":600,"softTabs":true,"firstVisibleScreenRow":110,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":601,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/employee_password_create.js","bufferId":"ebd84f7ff6c9a777e44810b6c96db7a3","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":616,"softTabs":true,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":617,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/notif_user_work_cancelled.js","bufferId":"6ff6e712e3825f0e8176bbf9ab628e5d","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":624,"softTabs":true,"firstVisibleScreenRow":23,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":625,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/notif_work_created.js","bufferId":"3ce5b637b532fb41b43323b9b256774d","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":628,"softTabs":true,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":629,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/preuser_welcome.js","bufferId":"c3b02380936c5164cb48a6638d962be8","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":632,"softTabs":true,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":633,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/rem_daybefore.js","bufferId":"b71509112cf0de782b391e49131b7847","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":636,"softTabs":true,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":637,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/rem_sameday.js","bufferId":"d5df69e566475d1799aa10f404536bba","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":640,"softTabs":true,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":641,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/res_confirmation.js","bufferId":"589b95f888a93a2d0a61644f3907d32e","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":644,"softTabs":true,"firstVisibleScreenRow":36,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":645,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/stars.js","bufferId":"915af682e56e95cd7e1087a6dd266a0b","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":978,"softTabs":true,"firstVisibleScreenRow":169,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":979,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/base.js","bufferId":"be1ea8219b0fa8d3b9320ae5924e89f6","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":648,"softTabs":true,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":649,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/user_password_recover.js","bufferId":"1b849f14561e8dd7edd2dbd8faf0fa88","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":652,"softTabs":true,"firstVisibleScreenRow":7,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":653,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/puller/handlers/user_welcome.js","bufferId":"e1994b895f5d0011555f01cc685dc232","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"SettingsView","version":2,"activePanelName":"Settings","uri":"atom://config/updates"}],"activeItemURI":"atom://config/updates","focused":true,"flexScale":1},"activePaneId":3},"packagesWithActiveGrammars":["language-javascript-better","language-hyperlink","language-todo"],"destroyedItemURIs":["/home/bellahora-04/Bellahora/puller/templates/rem_sameday_email_title.html","/home/bellahora-04/Bellahora/puller/templates/notif_work_created_email.html","/home/bellahora-04/Bellahora/puller/templates/bill_email_title.html","/home/bellahora-04/Bellahora/puller/templates/bill_email.html","/home/bellahora-04/Bellahora/puller/templates/designs/campaign_client_email.html","/home/bellahora-04/Bellahora/puller/templates/designs/emp_password_create.html","/home/bellahora-04/Bellahora/puller/templates/welcome_email_title.html","/home/bellahora-04/Bellahora/puller/handlers/bh_bill.js","/home/bellahora-04/Bellahora/puller/templates/campaign_client_email_title.html","/home/bellahora-04/Bellahora/puller/templates/campaign_client_email.html","/home/bellahora-04/Bellahora/puller/templates/campaign_client_whatsapp.html","/home/bellahora-04/Bellahora/puller/templates/rem_daybefore_email_title.html","/home/bellahora-04/Bellahora/puller/templates/rem_daybefore_email.html","/home/bellahora-04/Bellahora/puller/templates/bh_bill_pdf.html","/home/bellahora-04/Bellahora/puller/templates/rem_daybefore_whatsapp.html","/home/bellahora-04/Bellahora/puller/templates/rem_hoursago_email_title.html","/home/bellahora-04/Bellahora/puller/templates/rem_hoursago_sms.html","/home/bellahora-04/Bellahora/puller/templates/rem_hoursago_whatsapp.html","/home/bellahora-04/Bellahora/puller/handlers/bill.js","/home/bellahora-04/Bellahora/puller/handlers/bh_mailing.js","/home/bellahora-04/Bellahora/puller/handlers/campaign_client.js","/home/bellahora-04/Bellahora/puller/handlers/campaign.js","/home/bellahora-04/Bellahora/puller/handlers/check_and_welcome.js","/home/bellahora-04/Bellahora/puller/handlers/check.js","/home/bellahora-04/Bellahora/puller/handlers/email_one.js","/home/bellahora-04/Bellahora/puller/handlers/employee_password_recovery.js","/home/bellahora-04/Bellahora/puller/handlers/newsletter.js","/home/bellahora-04/Bellahora/puller/handlers/notif_user_campaign.js","/home/bellahora-04/Bellahora/puller/handlers/notif_work_cancelled.js","/home/bellahora-04/Bellahora/puller/handlers/pending_confirmation_alert.js","/home/bellahora-04/Bellahora/puller/handlers/poll.js","/home/bellahora-04/Bellahora/puller/handlers/rem_hoursago.js","/home/bellahora-04/Bellahora/puller/handlers/res_preconfirmation_decision.js","/home/bellahora-04/Bellahora/puller/handlers/welcome.js","/home/bellahora-04/Bellahora/puller/handlers/bh_welcome.js","/home/bellahora-04/Bellahora/puller/templates/email_one_email.html","/home/bellahora-04/Bellahora/puller/templates/emp_password_create_email_title.html","/home/bellahora-04/Bellahora/puller/templates/emp_password_create_email.html","/home/bellahora-04/Bellahora/puller/templates/emp_password_recovery_email_title.html","/home/bellahora-04/Bellahora/puller/templates/emp_password_recovery_email.html","/home/bellahora-04/Bellahora/puller/templates/parents/default_simple_bottom.ejs","/home/bellahora-04/Bellahora/puller/templates/parents/default_bottom.ejs","/home/bellahora-04/Bellahora/puller/templates/poll_email_title.html","/home/bellahora-04/Bellahora/puller/templates/pending_confirmation_alert_email.html","/home/bellahora-04/Bellahora/puller/templates/parents/default_top.ejs","/home/bellahora-04/Bellahora/puller/templates/bh_bill_email_title.html","/home/bellahora-04/Bellahora/puller/templates/bh_bill_email.html"]},"packageStates":{"linter":{"scope":"File"},"pigments":{"project":{"deserializer":"ColorProject","timestamp":"2016-05-10T09:47:14.053Z","version":"1.0.1","markersVersion":"1.0.6","globalSourceNames":["**/*.styl","**/*.stylus","**/*.less","**/*.sass","**/*.scss"],"globalIgnoredNames":["vendor/*","node_modules/*","spec/*","test/*"],"buffers":{"600":{"id":600,"path":"/home/bellahora-04/Bellahora/puller/handlers/employee_password_create.js","colorMarkers":[]},"616":{"id":616,"path":"/home/bellahora-04/Bellahora/puller/handlers/notif_user_work_cancelled.js","colorMarkers":[]},"624":{"id":624,"path":"/home/bellahora-04/Bellahora/puller/handlers/notif_work_created.js","colorMarkers":[]},"628":{"id":628,"path":"/home/bellahora-04/Bellahora/puller/handlers/preuser_welcome.js","colorMarkers":[]},"632":{"id":632,"path":"/home/bellahora-04/Bellahora/puller/handlers/rem_daybefore.js","colorMarkers":[]},"636":{"id":636,"path":"/home/bellahora-04/Bellahora/puller/handlers/rem_sameday.js","colorMarkers":[]},"640":{"id":640,"path":"/home/bellahora-04/Bellahora/puller/handlers/res_confirmation.js","colorMarkers":[{"markerId":"60","bufferRange":[[31,395],[31,402]],"color":[105,105,105,1],"text":"#696969","variables":[]},{"markerId":"61","bufferRange":[[77,89],[77,96]],"color":[255,11,109,1],"text":"#ff0b6d","variables":[]}]},"644":{"id":644,"path":"/home/bellahora-04/Bellahora/puller/handlers/stars.js","colorMarkers":[]},"648":{"id":648,"path":"/home/bellahora-04/Bellahora/puller/handlers/user_password_recover.js","colorMarkers":[]},"652":{"id":652,"path":"/home/bellahora-04/Bellahora/puller/handlers/user_welcome.js","colorMarkers":[]},"978":{"id":978,"path":"/home/bellahora-04/Bellahora/puller/handlers/base.js","colorMarkers":[]}},"paths":[],"variables":{"deserializer":"VariablesCollection","content":[]}}},"find-and-replace":{"findOptions":{"findPattern":"renderFromTemplate","replacePattern":"","pathsPattern":"","useRegex":false,"wholeWord":false,"caseSensitive":false,"inCurrentSelection":false},"findHistory":["push","getWork","getMapper","renderAll","pushios","via:","welcome_email","stars_email","rem_hoursago","bill_email","bh_bill","renderFromTemplate","getTemplate","renderFromTemplate"],"replaceHistory":[],"pathsHistory":[]},"fuzzy-finder":{"/home/bellahora-04/Bellahora/puller/handlers/employee_password_create.js":1458636067275,"/home/bellahora-04/Bellahora/puller/handlers/notif_user_work_cancelled.js":1458636198413,"/home/bellahora-04/Bellahora/puller/handlers/notif_work_created.js":1458636237431,"/home/bellahora-04/Bellahora/puller/handlers/preuser_welcome.js":1458636258678,"/home/bellahora-04/Bellahora/puller/handlers/rem_daybefore.js":1458636268737,"/home/bellahora-04/Bellahora/puller/handlers/rem_sameday.js":1458636314670,"/home/bellahora-04/Bellahora/puller/handlers/res_confirmation.js":1458636315541,"/home/bellahora-04/Bellahora/puller/handlers/stars.js":1458636518216,"/home/bellahora-04/Bellahora/puller/handlers/base.js":1458637942170,"/home/bellahora-04/Bellahora/puller/handlers/user_password_recover.js":1458636404218,"/home/bellahora-04/Bellahora/puller/handlers/user_welcome.js":1458636423761},"keybinding-resolver":{},"metrics":{"sessionLength":13389653},"tabs":[{"previewTabURI":"/home/bellahora-04/Bellahora/puller/handlers/base.js"}],"tree-view":{"directoryExpansionStates":{"/home/bellahora-04/Bellahora/puller":{"isExpanded":true,"entries":{".git":{"isExpanded":false,"entries":{}},"common":{"isExpanded":false,"entries":{}},"handlers":{"isExpanded":true,"entries":{}},"node_modules":{"isExpanded":false,"entries":{}},"templates":{"isExpanded":true,"entries":{"designs":{"isExpanded":false,"entries":{}},"parents":{"isExpanded":true,"entries":{}}}},"via":{"isExpanded":false,"entries":{}}}}},"selectedPath":"/home/bellahora-04/Bellahora/puller","hasFocus":false,"attached":true,"scrollLeft":48,"scrollTop":0,"width":156}},"fullScreen":false}