{"mode":"editor","version":1,"windowDimensions":{"x":0,"y":181,"width":1050,"height":1499,"maximized":false},"grammars":{"grammarOverridesByPath":{"/home/bellahora-04/Bellahora/portal/resources/views/bookings.html":"text.html.basic"}},"project":{"deserializer":"Project","paths":["/home/bellahora-04/Bellahora/portal"],"buffers":[{"id":"7936cbac2503fb9b2c58343de44271d3","text":"var _ = require('lodash'),\n\tpathModels = '../common/model',\n\twhen = require('promised-io/promise'),\n\tObjectId = require('mongoose').Types.ObjectId,\n\tTimeInterval = require( pathModels + '/TimeInterval.js').model(),\n\tutil = require('util'),\n\tconfig = require('../config.js'),\n\trequest = require('request'),\n\thash = require('object-hash'),\n\tlogger = require('../common/utils/logentries')(),\n\tBasePainter = require('../painter/abstract/BasePainter.js'),\n\tBaseController \t\t = require('./abstract/BaseController.js'),\n\tdeviceP = require('device'),\n\tWorkControllerCommon = require('../common/controller/WorkController.js');\n\tCrypt = new require('../common/utils/crypt.js'),\n\tpaymentUtils = require('../common/utils/paymentSystem/utils.js');\n\nvar WorkController = function() {\n\tthis.init.apply(this, arguments);\n};\n\n\n_.extend(WorkController.prototype, WorkControllerCommon.prototype , BaseController.prototype , {\n\tpainter: null,\n\ttreatmentModel: require( pathModels + '/Treatment.js').model(),\n\tbhAccountModel: require( pathModels + '/BHAccount.js').model(),\n\tpromocodeModel: require(pathModels + '/PromoCode.js').model(),\n\taffiliatesTrackingModel: require(pathModels + '/AffiliateTracking.js').model(),\n\n\n\tinit: function(req, res, config) {\n\t\tBaseController.prototype.init.apply(this, arguments);\n\t\tthis.painter = new BasePainter(req, res, BasePainter.MODE_JSON);\n\t},\n//http://localhost:8082/api/portal/current/available-hours/51122c386380f1350f000001/546cc5024f87a2f619000181/2015-1-28\n\tavailableHours: function(idBHAccount, idTreatment, year, month, day, tzOffset){\n\t\tvar date = TimeInterval.fakeUTC(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10)),\n\t\t\ttodayOffset;\n\t\t// Testing caching-all strategy by params\n\t\t/*var h = hash.MD5({\n\t\t\tidBHAccount:idBHAccount,\n\t\t\tidTreatment:idTreatment,\n\t\t\tyear:year,\n\t\t\tmonth:month,\n\t\t\tday:day,\n\t\t\thints:this.req.query['hints']\n\t\t});\n\t\tvar key = \"availableHours:\"+h;\n\t\tthis.req.db.lrange(key, 0, -1, function (err, reply) {\n\t\t\t//this.req.db.del(key);\n\t\t\tif(!reply.length) {\n\t\t\t\ttry{\n\t\t\t\t\tvar hints = this.req.query['hints'] || [];\n\t\t\t\t\tif(!Array.isArray(hints))\n\t\t\t\t\t\thints = [hints];\n\t\t\t\t\tthis.treatmentModel.idBHAccount = ObjectId.fromString(idBHAccount);\n\t\t\t\t\tthis.treatmentModel.findOne({ _id: ObjectId.fromString(idTreatment) }, function(err, treatment){\n\t\t\t\t\t\tif(!treatment)\n\t\t\t\t\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t\t\t\t\ttreatment.availableHours(date, hints, function(err, dates){\n\t\t\t\t\t\t\tdates = (dates || [] ).map(function(date) {\n\t\t\t\t\t\t\t\tvar hour =  date.getUTCHours().toString();\n\t\t\t\t\t\t\t\tvar minute = date.getUTCMinutes().toString();\n\t\t\t\t\t\t\t\treturn util.format('%s:%s', hour < 10 ? '0' + hour : hour, minute < 10 ? '0' + minute : minute);\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tthis.req.db.del(key);\n\t\t\t\t\t\t\tthis.req.db.rpush.apply(this.req.db, [key].concat(dates));\n\n\t\t\t\t\t\t\tthis.painter.render(null, dates);\n\t\t\t\t\t\t}.bind(this));\n\t\t\t\t\t}.bind(this));\n\t\t\t\t} catch( exception ) {\n\t\t\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.painter.render(null, reply);\n\t\t\t}\n\t\t}.bind(this));*/\n// Today offset calculated if its from different timezone\n\t\tif (tzOffset) {\n\t\t\ttzOffset = parseInt(tzOffset, 10);\n\t\t\ttodayOffset = new Date();\n\t\t\ttodayOffset.setMinutes(todayOffset.getMinutes() - (tzOffset - todayOffset.getTimezoneOffset()));\n\t\t}\n\t\ttry{\n\t\t\tvar hints = this.req.query['hints'] || [];\n\t\t\tif(!Array.isArray(hints))\n\t\t\t\thints = [hints];\n\t\t\tthis.treatmentModel.idBHAccount = ObjectId.fromString(idBHAccount);\n\t\t\tthis.treatmentModel.findOne({ _id: ObjectId.fromString(idTreatment) }, function(err, treatment){\n\t\t\t\tif(!treatment)\n\t\t\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t\t\ttreatment.availableHours(date, hints, function(err, dates){\n\t\t\t\t\tdates = (dates || [] ).map(function(date) {\n\t\t\t\t\t\tvar hour =  date.getUTCHours().toString();\n\t\t\t\t\t\tvar minute = date.getUTCMinutes().toString();\n\t\t\t\t\t\treturn util.format('%s:%s', hour < 10 ? '0' + hour : hour, minute < 10 ? '0' + minute : minute);\n\t\t\t\t\t});\n\t\t\t\t\tthis.painter.render(null, dates);\n\t\t\t\t}.bind(this), todayOffset);\n\t\t\t}.bind(this));\n\t\t} catch( exception ) {\n\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t}\n\t},\n\n\n\tavailableHoursCombined: function(idBHAccount, idTreatments, year, month, day, tzOffset) {\n\t\tvar date = TimeInterval.fakeUTC(parseInt(year, 10), parseInt(month, 10) - 1, parseInt(day, 10)),\n\t\t\ttodayOffset;\n\t\tif (tzOffset) {\n\t\t\ttzOffset = parseInt(tzOffset, 10);\n\t\t\ttodayOffset = new Date();\n\t\t\ttodayOffset.setMinutes(todayOffset.getMinutes() - (tzOffset - todayOffset.getTimezoneOffset()));\n\t\t}\n\t\ttry{\n\t\t\tvar hints = this.req.query['hints'] || [];\n\t\t\tif(!Array.isArray(hints))\n\t\t\t\thints = [hints];\n\t\t\tthis.treatmentModel.idBHAccount = ObjectId.fromString(idBHAccount);\n\t\t\tthis.treatmentModel.find({ _id: { $in : idTreatments.map(function(idTreatment){\treturn ObjectId.fromString(idTreatment); }) } }, function(err, result){\n\t\t\t\tif(result.length != idTreatments.length)\n\t\t\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t\t\tresult = _.indexBy(result, '_id');\n\t\t\t\tthis.treatmentModel.availableHoursCombined(idTreatments.map(function(id){ return result[id]; }), date, hints, function(err, dates){\n\t\t\t\t\tthis.painter.render(null, (dates || [] ).map(function(date) {\n\t\t\t\t\t\tvar hour =  date.getUTCHours().toString();\n\t\t\t\t\t\tvar minute = date.getUTCMinutes().toString();\n\t\t\t\t\t\treturn util.format('%s:%s', hour < 10 ? '0' + hour : hour, minute < 10 ? '0' + minute : minute);\n\t\t\t\t\t}));\n\t\t\t\t}.bind(this), todayOffset);\n\t\t\t}.bind(this));\n\t\t} catch( exception ) {\n\t\t\tlogger.error(exception);\n\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t}\n\t},\n\n\tavailableDays: function(idBHAccount, idTreatment, year, month){\n\t\tvar dateStart = TimeInterval.fakeUTC(parseInt(year, 10), parseInt(month, 10) - 1);\n\t\tvar dateEnd = new Date(dateStart.getTime());\n\t\tdateEnd.setMonth(dateEnd.getMonth() + 1);\n\t\tif(dateStart < TimeInterval.fakeUTC())\n\t\t\tdateStart = TimeInterval.fakeUTC();\n\t\tvar hints = this.req.query['hints'] || [];\n\t\t\tif(!Array.isArray(hints))\n\t\t\t\thints = [hints];\n\t\ttry{\n\t\t\tthis.treatmentModel.idBHAccount = ObjectId.fromString(idBHAccount);\n\t\t\tthis.treatmentModel.findOne({ _id: ObjectId.fromString(idTreatment) }, function(err, treatment){\n\t\t\t\tif(!treatment)\n\t\t\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t\t\ttreatment.availableDays(dateStart, dateEnd, hints, function(err, days){\n\t\t\t\t\tthis.painter.render(null, days.map(function(day){ return day.getUTCDate(); }));\n\t\t\t\t}.bind(this));\n\t\t\t}.bind(this));\n\t\t} catch( exception ) {\n\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t}\n\t},\n\n\tavailableDaysCombined: function(idBHAccount, idTreatments, year, month){\n\t\tvar dateStart = TimeInterval.fakeUTC(parseInt(year, 10), parseInt(month, 10) - 1);\n\t\tvar dateEnd = new Date(dateStart.getTime());\n\t\tdateEnd.setMonth(dateEnd.getMonth() + 1);\n\t\tif(dateStart < TimeInterval.fakeUTC())\n\t\t\tdateStart = TimeInterval.fakeUTC();\n\t\tvar hints = this.req.query['hints'] || [];\n\t\t\tif(!Array.isArray(hints))\n\t\t\t\thints = [hints];\n\t\ttry{\n\t\t\tthis.treatmentModel.idBHAccount = ObjectId.fromString(idBHAccount);\n\t\t\tthis.treatmentModel.find({ _id: { $in : idTreatments.map(function(idTreatment){\treturn ObjectId.fromString(idTreatment); }) } }, function(err, result){\n\t\t\t\tif(result.length != idTreatments.length)\n\t\t\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t\t\tresult = _.indexBy(result, '_id');\n\n\t\t\t\tthis.treatmentModel.availableDaysCombined(idTreatments.map(function(id){ return result[id]; }), dateStart, dateEnd, hints, function(err, days){\n\t\t\t\t\tthis.painter.render(null, days.map(function(day){ return day.getUTCDate(); }));\n\t\t\t\t}.bind(this));\n\t\t\t}.bind(this));\n\t\t} catch( exception ) {\n\t\t\treturn this.res.status(404).json({ error : 'not_found'});\n\t\t}\n\t},\n\n\tbook: function(){\n\t\tvar ok = ['idcenter', 'treatment', 'day', 'hour'].every(function(field){\n\t\t\tif(this.req.body[field])\n\t\t\t\treturn true;\n\t\t\tthis.res.status(400).json({ success : false, error : 'missing_field', field: field});\n\t\t\treturn false;\n\t\t}.bind(this));\n\n\t\tif(!ok)\n\t\t\treturn;\n\n\t\tvar promocode = this.req.body.code;\n\t\tvar d = this.req.body.day.split('-');\n\t\tvar h = this.req.body.hour.split(':');\n\t\tvar date = TimeInterval.fakeUTC(parseInt(d[0], 10), parseInt(d[1], 10) - 1, parseInt(d[2], 10), parseInt(h[0], 10), parseInt(h[1], 10));\n\t\tvar idTreatments = Array.isArray(this.req.body['treatment'])? this.req.body['treatment'] : [this.req.body['treatment']];\n\t\tvar Client = require( pathModels + '/Client.js').model();\n\t\tClient.idBHAccount = this.req.body['idcenter'];\n\t\tvar hints = this.req.body['hints'] || [];\n\t\tif(hints == -1) hints = []; // Cualquier empleado\n\t\tif(!Array.isArray(hints))\n\t\t\thints = [hints];\n\n\t\tvar user = this.req.user;\n\n\t\t//Registro del pais para el usuario\n\t\tvar modelBHA = require( pathModels + '/BHAccount.js').model();\n\n\t\tmodelBHA.findOne({_id: this.req.body['idcenter']}, {country:1}).exec(function(err, data){\n\t\t\tif(data.country) {\n\t\t\t\tvar modelU = require( pathModels + '/User.js').model();\n\t\t\t\tmodelU.update({_id: user._id},{ $set: {country: data.country}}).exec(function (err,data){});\n\t\t\t}\n\t\t});\n\n\t\tvar createClient = function(callback) {\n\t\t\t//ME RINDO CON LO DEL IDBHACCOUNT.\n\t\t\tvar clientController = this.getController('Client'),\n                from = this.req.body.from;\n\n\t\t\tvar newClient = {\n\t\t\t\tname \t\t\t: user.get(\"name\"),\n\t\t\t\tlastname \t\t: user.get(\"lastname\"),\n\t\t\t\temailHidden \t: user.get(\"email\"),\n\t\t\t\tphone \t\t\t: user.get(\"phone\"),\n\t\t\t\talerts \t\t\t: 1,\n\t\t\t\tcreatedByClient : true,\n\t\t\t\tidUser \t\t\t: user._id\n\t\t\t};\n\n            if(from && from[0] == 'o') newClient.email = user.get(\"email\");\n\n\t\t\tclientController.create( callback, newClient);\n\t\t}.bind(this);\n\n\t\tvar createWork = function(idClient){\n\t\t\tvar Work = require( pathModels + '/Work.js').model();\n\t\t\tWork.idBHAccount = this.req.body['idcenter'];\n\n\t\t\tvar agent = this.req.headers['user-agent'] || \"\";\n\t\t\tvar device = deviceP(this.req.headers['user-agent']);\n\t\t\tif(device.type == 'phone' || device.type == 'tablet') {\n\t\t\t\tif(agent.match(/(android|okhttp)/gi)) device = \"android_\"+device.type;\n\t\t\t\telse if(agent.match(/(iPad|iPhone|iPod)/g)) device = \"ios_\"+device.type;\n\t\t\t} else device = device.type;\n\t\t\t/**\n\t\t\t * FROM VALUES==============================================================================\n\t\t\t *  p_web             ;; Booked in Portal Web ( by Client )\n\t\t\t *  p_android         ;; Booked in Portal App Android ( by Client )\n\t\t\t *  p_ios             ;; Booked in Portal App iOS ( by Client )\n\t\t\t *  o_web             ;; Booked in its own BHAccount Web ( by Client )\n\t\t\t *  o_android         ;; Booked in its own BHAccount app Android ( by Client )\n\t\t\t *  o_ios             ;; Booked in its own BHAccount app iOS ( by Client )\n\t\t\t *  o_widget          ;; Booked in its own BHAccount Widget ( by Client )\n\t\t\t *  o_fb              ;; Booked in its own BHAccount Facebook Widget ( by Client )\n\t\t\t * =========================================================================================\n\t\t\t */\n\t\t\tvar from = this.req.body.from;\n\t\t\tif(!from) {\n\t\t\t\tlogger.log({\n\t\t\t\t\treferer:  this.req.headers.referrer || this.req.headers.referer,\n\t\t\t\t\tagent: agent,\n\t\t\t\t\tdata: JSON.parse(JSON.stringify(this.req.body))\n\t\t\t\t});\n\t\t\t\tfrom = agent.match(/(android|okhttp)/gi) ? 'p_android' : agent.match(/(iPad|iPhone|iPod)/g) ? 'p_ios' : this.req.body.from;\n\t\t\t}\n\n\t\t\tvar data = {\n\t\t\t\tcomment: this.req.body.comment,\n\t\t\t\tpayment: this.req.body.cardName || this.req.body.cardIdentifier,\n\t\t\t\ttracking: this.req.cookies.tracking || this.req.body.tracking || undefined,\n\t\t\t\tdevice: device\n\t\t\t};\n\n\n\t\t\tWork.book( date, idTreatments, idClient, hints, from, this.req.body['useLoyalityCredit'] == 'true', promocode,function( work ){\n                this.affiliatesTrackingModel.workAffiliationCost(this.req.cookies.affiliation, work, function(pixel){\n\t\t\t\t\tif (work == 'cant_allocate_resources') {\n\t\t\t\t\t\treturn this.res.status(400).json({ success : false, error : 'invalid_booking', msg: \"Los recursos no estan disponibles, pruebe con otra hora.\"})\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvar p = new when.Deferred();\n\t\t\t\t\t\tif (work.payment) {\n                            var cc = {};\n                            if (this.req.body.cardIdentifier) {\n                                cc.cardIdentifier = this.req.body.cardIdentifier;\n                            } else {\n                                cc.cardName = this.req.body.cardName;\n                                cc.cardExpiryDate = this.req.body.cardExpiryDate;\n                                cc.cardNumber = this.req.body.cardNumber;\n                                cc.cardCVC = this.req.body.cardCVC;\n                                cc.saveCard = this.req.body.saveCard == 'true' ? true : false;\n                            }\n                            work.pay(cc).then(function (code){\n                                //console.log('Pagado con:', code);\n                                if (code < 0 || code >= 100) {\n                                    var errorMsg = \"No ha sido posible realizar el pago.\\nCompruebe que los datos de la tarjeta son correctos\";\n                                    if (code == 101)\n                                        errorMsg = \"No ha sido posible realizar el pago.\\nLa tarjeta de datos esta caducada\";\n                                    else if (code == 129)\n                                        errorMsg = \"No ha sido posible realizar el pago.\\nCódigo de seguridad (CVV2/CVC2) incorrecto.\";\n                                    else if (code == 9093)\n                                        errorMsg = \"No ha sido posible realizar el pago.\\nTarjeta no existente.\";\n                                    p.reject(errorMsg);\n                                } else {\n                                    p.resolve();\n                                }\n                            }.bind(this));\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tp.resolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tp.promise.then(function () {\n\t\t\t\t\t\t\t\twork.save(function( err , work ) {\n\t\t\t\t\t\t\t\t\tif(err){\n\t\t\t\t\t\t\t\t\t\tlogger.log(err);\n\t\t\t\t\t\t\t\t\t\treturn this.res.status(400).json({ success : false, error : 'invalid_booking', msg: \"Contacte con servico al cliente por favor\"});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tif( config && config.environment !== \"development\" ) {\n\t\t\t\t\t\t\t\t\t\trequest.get('https://www.bellahora.com/api/listen/work/' + work._id);\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tprocess.env.NODE_TLS_REJECT_UNAUTHORIZED = 0;\n\t\t\t\t\t\t\t\t\t\trequest({ url: this.req.protocol+'://'+this.req.get('host')+'/api/listen/work/' + work._id , rejectUnhauthorized: false });\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tthis.res.send({\n\t\t\t\t\t\t\t\t\t\tstate : work.state,\n\t\t\t\t\t\t\t\t\t\twork : _.pick(work, '_id' ,'state', 'price', 'idTreatment', 'resources', 'day', 'iniHour', 'fiHour', 'loyalityProgram', 'loyalityCredit', '_idBHAccount'),\n\t\t\t\t\t\t\t\t\t\tpixel : pixel\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}.bind( this ));\n\t\t\t\t\t\t\t}.bind(this),\n\t\t\t\t\t\t\tfunction (msg){\n\t\t\t\t\t\t\t\treturn this.res.status(400).json({ success : false, error :'invalid_payment', msg: msg});\n\t\t\t\t\t\t\t}.bind(this));\n\t\t\t\t\t}\n\t\t\t\t}.bind(this));\n\t\t\t}.bind(this), parseFloat(this.req.param('lat')), parseFloat(this.req.param('lon')), data);\n\t\t}.bind(this);\n\n\t\tvar runAll = function(){\n\t\t\twhen.seq([\n\t\t\t\tfunction(){\n\t\t\t\t\treturn this.bhAccountModel.findOne({_id : this.req.body['idcenter'] }).exec()\n\t\t\t\t}.bind(this),\n\t\t\t\tfunction(bhAccount){\n\t\t\t\t\tif(bhAccount.accountGroup)\n\t\t\t\t\t\treturn this.bhAccountModel.find({ accountGroup : bhAccount.accountGroup }).exec()\n\t\t\t\t\treturn [bhAccount];\n\t\t\t\t}.bind(this),\n\t\t\t\tfunction(bhAccounts){\n\t\t\t\t\tvar filter = {\n\t\t\t\t\t\t_idBHAccount : { $in : _.pluck(bhAccounts, 'id')},\n\t\t\t\t\t\t$or : [\n\t\t\t\t\t\t\t{ idUser : user._id },\n\t\t\t\t\t\t\t{ $and : [ { idUser : null }, { $or : [ { phone : user.phone } , { email : user.email } ] } ] }\n\t\t\t\t\t\t]\n\t\t\t\t\t};\n\t\t\t\t\tClient.findWithoutBHAccount(filter , function( err , clients ) {\n\t\t\t\t\t\tif(clients.length) {\n\t\t\t\t\t\t\tvar client = _.first(clients);\n\t\t\t\t\t\t\t//Actualizar datos del cliente\n\t\t\t\t\t\t\tif(!client.idUser)\n\t\t\t\t\t\t\t\tclient.idUser = this.getUserId();\n\t\t\t\t\t\t\t['name', 'lastname', 'email', 'phone'].forEach(function(field){\n\t\t\t\t\t\t\t\tif(user.get(field))\n\t\t\t\t\t\t\t\t\tclient[field] = user.get(field);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tclient.save();\n\t\t\t\t\t\t\tcreateWork(client._id);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcreateClient(function(data){\n\t\t\t\t\t\t\t\tcreateWork(data.model.id);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}.bind(this));\n\t\t\t\t}.bind(this)\n\t\t\t]);\n\t\t}.bind(this);\n\n\t\t//checkpromocode\n\t\tif(promocode) {\n\t\t\tvar that = this;\n\t\t\tvar datenow = new Date();\n\t\t\tthat.promocodeModel.findOne({\n\t\t\t\tcode:promocode,\n\t\t\t\tactive:true,\n\t\t\t\tstartDate:{$lte:datenow},\n\t\t\t\tendDate:{$gte:datenow}\n\t\t\t}, function(err, code) {\n\t\t\t\tif (err) return that.res.status(500).json(err);\n\t\t\t\tif (!code) return that.res.status(400).json({ success : false, error : 'invalid_promocode'});\n\n\t\t\t\tthat.applyCodeChecks(code, function(errors){\n\t\t\t\t\tif(errors) {\n\t\t\t\t\t\treturn that.res.status(400).json({ success : false, error : 'invalid_promocode'});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tpromocode = JSON.parse(JSON.stringify(code));\n\t\t\t\t\t\trunAll();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t})\n\t\t} else {\n\t\t\trunAll();\n\t\t}\n\n\t},\n\n\tresources: function(idBHAccount, idTreatmentBooking, year, month){\n\t\tvar TreatmentBooking = require( pathModels + '/TreatmentBooking.js').model();\n\t\tvar Resource = require( pathModels + '/Resource.js').model();\n\t\tvar Employee = require( pathModels + '/Employee.js').model();\n\t\tResource.idBHAccount = idBHAccount;\n\t\tTreatmentBooking.idBHAccount = idBHAccount;\n\t\tEmployee.idBHAccount = idBHAccount;\n        TreatmentBooking.findOne({ _id : idTreatmentBooking }, function(err, treatmentBooking){\n        \tif(!treatmentBooking)\n        \t\treturn this.res.status(404).json({ success : false, error : 'not_found'});\n        \tif(!treatmentBooking.resourceClass.length)\n        \t\treturn this.res.json([]);\n        \tResource.find({ resourceClass : { $in : treatmentBooking.resourceClass }}).lean().exec(function(err, resources){\n        \t\tvar idEmployees = [];\n        \t\tresources.forEach(function(resource){\n        \t\t\tif(resource.idEmployee)\n        \t\t\t\tidEmployees.push(resource.idEmployee);\n        \t\t});\n\t\t\t\tif(!idEmployees.length)\n        \t\t\treturn this.res.json(resources);\n        \t\tEmployee.find({_id: {$in : idEmployees }}, function(err, employees){\n        \t\t\temployees = _.indexBy(employees, '_id');\n        \t\t\tresources.forEach(function(resource){\n\t        \t\t\tif(employees[resource.idEmployee])\n\t        \t\t\t\tresource.employee = employees[resource.idEmployee];\n\t        \t\t});\n        \t\t\treturn this.res.json(resources);\n        \t\t}.bind(this));\n        \t}.bind(this));\n        }.bind(this));\n\t},\n\n\tcancel: function(  ) {\n\t\tif(!this.req.body.idWork)\n\t\t\treturn this.res.status(400).json({ success : false, error : 'missing_field', field: 'idWork'});\n\t\twhen.seq([\n\t\t\tfunction(idUser){\n\t\t\t\treturn this.getModel('Client').findWithoutBHAccount({ idUser : idUser }).lean().exec();\n\t\t\t}.bind(this),\n\t\t\tfunction(clients) {\n\t\t\t\treturn this.getModel('Work').findWithoutBHAccount({ idClient : { $in : _.pluck(clients, '_id') }, _id : this.req.body.idWork }).exec();\n\t\t\t}.bind(this),\n\t\t\tfunction(works){\n\t\t\t\tvar work = works.pop();\n\t\t\t\tif(!work)\n\t\t\t\t\treturn this.res.status(404).json({ success : false, error : 'work_not_found'});\n\t\t\t\tif(!work.can_cancel)\n\t\t\t\t\treturn this.res.status(400).json({ success : false, error : 'invalid_state', state: work.state });\n\n\t\t\t\tthis.bhAccountModel.findOne({_id:work._idBHAccount}, {bc:1}).lean().exec(function(err, bh){\n\t\t\t\t\tif(err)\n\t\t\t\t\t\treturn this.res.status(400).json({ success : false, error : 'unknow_error' });\n\t\t\t\t\tif(!bh.bc)\n\t\t\t\t\t\treturn this.res.status(400).json({ success : false, error : 'invalid_state', state: work.state });\n\t\t\t\t\telse {\n\t\t\t\t\t\twork.state = 'res_client_rejected';\n\t\t\t\t\t\twork.save(function(err){\n\t\t\t\t\t\t\tif(err)\n\t\t\t\t\t\t\t\treturn this.res.status(400).json({ success : false, error : 'unknow_error' });\n\t\t\t\t\t\t\tthis.res.json({ success :  true });\n\t\t\t\t\t\t\tif( config && config.environment !== \"development\" ) //Notificar a las apps\n\t\t\t\t\t\t\t\trequest.get('https://www.bellahora.com/api/listen/work/' + this.req.body.idWork);\n\t\t\t\t\t\t}.bind(this));\n\t\t\t\t\t}\n\t\t\t\t}.bind(this));\n\t\t\t}.bind(this)\n\t\t], this.getUserId());\n\n\t},\n\tapplyCodeChecks: function(code, callback) {\n\t\tvar that = this;\n        var Work = require( pathModels + '/Work.js').model().Model;\n        var promises = [];\n\n        promises.push(Work.count({\n            promoCodes: {$elemMatch: {idPromoCode:code._id}},\n\t\t\tstate: {$nin:['res_rejected', 'res_client_rejected', 'res_missing']}\n        }).exec());\n\n\t\tvar userPromises = [];\n\t\tif(that.req.user) {\n\t\t\tvar Client = require( pathModels + '/Client.js').model().Model;\n\t\t\t// We need idClient\n\t\t\tuserPromises.push(Client.find({\n\t\t\t\tidUser: that.req.user._id\n\t\t\t}, '_id').exec());\n\t\t}\n\t\tif(that.req.body.treatment) {\n\t\t\t//minAmount / maxAmount\n\t\t\tvar query = {_id: that.req.body.treatment};\n\t\t\tpromises.push(this.treatmentModel.findOne(query).exec());\n\n\t\t}\n\n\t\twhen.all(promises).then(function(results){\n\t\t\tresults = _.object(['timesUsed','minMax'], results);\n\n            if(results.timesUsed >= code.maxUses) return callback('Ya usado el máximo de veces');\n\n\t\t\tvar price = results.minMax.pvpWithDiscount || results.minMax.pvp;\n\t\t\tvar canApplyPrice = true;\n\t\t\tif(code.maxAmount && price > code.maxAmount) canApplyPrice = false;\n\t\t\tif(code.minAmount && price < code.minAmount) canApplyPrice = false;\n\n\t\t\tif(that.req.body.treatment && !canApplyPrice) {\n\t\t\t\treturn callback(\"No es aplicable al precio del tratamiento.\");\n\t\t\t}\n\n\t\t\twhen.all(userPromises).then(function(results){\n\t\t\t\tresults = _.object(['client'], results);\n\t\t\t\tresults.client = _.pluck(results.client, '_id');\n\n\t\t\t\tvar workPromises = [];\n\t\t\t\tif(results.client) {\n\n\t\t\t\t\t//check maxUsesPerUser\n\t\t\t\t\tworkPromises.push(Work.count({\n\t\t\t\t\t\tidClient: {$in:results.client},\n\t\t\t\t\t\tpromoCodes: {$elemMatch: {idPromoCode:code._id}},\n\t\t\t\t\t\tstate: {$nin:['res_rejected', 'res_client_rejected', 'res_missing']}\n\t\t\t\t\t}).exec());\n\n\t\t\t\t\t//check only first time\n\t\t\t\t\tworkPromises.push(Work.count({\n\t\t\t\t\t\tidClient: {$in:results.client},\n\t\t\t\t\t\tstate: {$nin:['res_rejected', 'res_client_rejected', 'res_missing']}\n\t\t\t\t\t}).exec());\n\t\t\t\t}\n\n\n\t\t\t\twhen.all(workPromises).then(function(results){\n\t\t\t\t\tresults = _.object(['maxUses','onlyFirstTime'], results);\n\n\t\t\t\t\tif(results.maxUses && results.maxUses >= code.maxUsesForUser)\n\t\t\t\t\t\treturn callback(\"Usado más veces de las posibles por usuario\");\n\n\t\t\t\t\tif(results.onlyFirstTime && results.onlyFirstTime >= 1 && code.onlyFirstTime)\n\t\t\t\t\t\treturn callback('Solo válido en la primera reserva.');\n\n\t\t\t\t\tcallback(0);\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t},\n\n\tcheckCode: function(code) {\n\t\tvar that = this;\n\t\tvar date = new Date();\n\t\tthat.promocodeModel.findOne({\n\t\t\tcode:code,\n\t\t\tactive:true,\n\t\t\tstartDate:{$lte:date},\n\t\t\tendDate:{$gte:date}\n\t\t}, function(err, code) {\n\t\t\tif (err) return that.res.status(500).json(err);\n\t\t\tif (!code) return that.res.json({exist: false, error:'Código inexistente'});\n\n\t\t\tthat.applyCodeChecks(code, function(errors){\n\t\t\t\tif(errors) {\n\t\t\t\t\tthat.res.json({valid:false, exist: true, error: errors});\n\t\t\t\t} else {\n\t\t\t\t\tthat.res.json({\n\t\t\t\t\t\texist:true,\n\t\t\t\t\t\tvalid:true,\n\t\t\t\t\t\tpromocode: {\n\t\t\t\t\t\t\ttype:code.type,\n\t\t\t\t\t\t\tvalue:code.value\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t})\n\t},\n\n\tgenerateURL: function () {\n\t\tvar data = this.req.body;\n\t\tdata.user = {};\n\t\tdata.user._id = this.req.user._id;\n\t\tdata.user.name = this.req.user.name;\n\t\tdata.user.lastname = this.req.user.lastname;\n\t\tdata.user.email = this.req.user.email;\n\t\tdata.user.phone = this.req.user.phone;\n\n\n\t\tvar cipher = new Crypt('+0g&8dVt1:h~^p');\n\t\tvar crypt = cipher.encrypt(JSON.stringify(data));\n\t\tthis.res.send(crypt);\n\t}\n});\n\nmodule.exports = WorkController;\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"4":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"79":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"87":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"312":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"313":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"315":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"316":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"317":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"318":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"319":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"320":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"321":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"322":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"323":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"324":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"325":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"326":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"327":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"328":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"329":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"330":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"331":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"339":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"340":{"range":{"start":{"row":603,"column":0},"end":{"row":603,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"347":{"range":{"start":{"row":85,"column":5},"end":{"row":85,"column":6}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"348":{"range":{"start":{"row":102,"column":2},"end":{"row":102,"column":3}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":85,"column":4},"end":{"row":85,"column":4}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"5":{"id":"5","maintainHistory":false,"markersById":{},"version":2},"6":{"id":"6","maintainHistory":false,"markersById":{},"version":2},"7":{"id":"7","maintainHistory":false,"markersById":{},"version":2},"9":{"id":"9","maintainHistory":false,"markersById":{},"version":2},"10":{"id":"10","maintainHistory":false,"markersById":{},"version":2},"18":{"id":"18","maintainHistory":false,"markersById":{},"version":2},"19":{"id":"19","maintainHistory":false,"markersById":{},"version":2},"27":{"id":"27","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":28,"history":{"version":3,"nextCheckpointId":89,"undoStack":[],"redoStack":[{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,19],[86,19]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,18],[86,18]],"newRange":[[86,18],[86,19]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[86,18],[86,19]],"newRange":[[86,18],[86,18]],"oldText":",","newText":""}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,19],[86,19]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,19],[86,19]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,18],[86,18]],"newRange":[[86,18],[86,19]],"oldText":"","newText":","}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,18],[86,18]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,18],[86,18]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,17],[86,17]],"newRange":[[86,17],[86,18]],"oldText":"","newText":"\\"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,17],[86,17]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,75],[86,75]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,74],[86,74]],"newRange":[[86,74],[86,75]],"oldText":"","newText":";"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,74],[86,74]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,73],[86,73]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,64],[86,67]],"newRange":[[86,64],[86,73]],"oldText":"tre","newText":"treatment"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,67],[86,67]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,67],[86,67]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,66],[86,66]],"newRange":[[86,66],[86,67]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[86,65],[86,65]],"newRange":[[86,65],[86,66]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[86,64],[86,64]],"newRange":[[86,64],[86,65]],"oldText":"","newText":"t"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,64],[86,64]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,64],[86,64]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,63],[86,63]],"newRange":[[86,63],[86,64]],"oldText":"","newText":" "}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,63],[86,63]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,63],[86,63]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,62],[86,62]],"newRange":[[86,62],[86,63]],"oldText":"","newText":","}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,62],[86,62]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,61],[86,61]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,60],[86,60]],"newRange":[[86,60],[86,61]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[86,59],[86,59]],"newRange":[[86,59],[86,60]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[86,58],[86,58]],"newRange":[[86,58],[86,59]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[86,57],[86,57]],"newRange":[[86,57],[86,58]],"oldText":"","newText":"m"}},{"type":"change","content":{"oldRange":[[86,56],[86,56]],"newRange":[[86,56],[86,57]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[86,55],[86,55]],"newRange":[[86,55],[86,56]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[86,54],[86,54]],"newRange":[[86,54],[86,55]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[86,53],[86,53]],"newRange":[[86,53],[86,54]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[86,52],[86,52]],"newRange":[[86,52],[86,53]],"oldText":"","newText":"t"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,52],[86,52]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,52],[86,52]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,51],[86,51]],"newRange":[[86,51],[86,52]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[86,50],[86,50]],"newRange":[[86,50],[86,51]],"oldText":"","newText":">"}},{"type":"change","content":{"oldRange":[[86,49],[86,49]],"newRange":[[86,49],[86,50]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[86,48],[86,48]],"newRange":[[86,48],[86,49]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[86,48],[86,49]],"newRange":[[86,48],[86,48]],"oldText":".","newText":""}},{"type":"change","content":{"oldRange":[[86,49],[86,50]],"newRange":[[86,49],[86,49]],"oldText":".","newText":""}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,50],[86,50]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,50],[86,50]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,49],[86,49]],"newRange":[[86,49],[86,50]],"oldText":"","newText":"."}},{"type":"change","content":{"oldRange":[[86,48],[86,48]],"newRange":[[86,48],[86,49]],"oldText":"","newText":"."}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,48],[86,48]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,48],[86,48]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,47],[86,47]],"newRange":[[86,47],[86,48]],"oldText":"","newText":" "}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,47],[86,47]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,47],[86,47]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,33],[86,37]],"newRange":[[86,33],[86,47]],"oldText":"avai","newText":"availableHours"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,37],[86,37]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,37],[86,37]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,36],[86,36]],"newRange":[[86,36],[86,37]],"oldText":"","newText":"i"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,36],[86,36]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,36],[86,36]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,35],[86,35]],"newRange":[[86,35],[86,36]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[86,34],[86,34]],"newRange":[[86,34],[86,35]],"oldText":"","newText":"v"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,34],[86,34]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,34],[86,34]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,33],[86,33]],"newRange":[[86,33],[86,34]],"oldText":"","newText":"a"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,33],[86,33]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,33],[86,33]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,32],[86,32]],"newRange":[[86,32],[86,33]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[86,31],[86,31]],"newRange":[[86,31],[86,32]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[86,31],[86,32]],"newRange":[[86,31],[86,31]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[86,32],[86,33]],"newRange":[[86,32],[86,32]],"oldText":"-","newText":""}},{"type":"change","content":{"oldRange":[[86,33],[86,34]],"newRange":[[86,33],[86,33]],"oldText":"-","newText":""}},{"type":"change","content":{"oldRange":[[86,34],[86,35]],"newRange":[[86,34],[86,34]],"oldText":">","newText":""}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,35],[86,35]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,35],[86,35]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,34],[86,34]],"newRange":[[86,34],[86,35]],"oldText":"","newText":">"}},{"type":"change","content":{"oldRange":[[86,33],[86,33]],"newRange":[[86,33],[86,34]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[86,32],[86,32]],"newRange":[[86,32],[86,33]],"oldText":"","newText":"-"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,32],[86,32]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,32],[86,32]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,31],[86,31]],"newRange":[[86,31],[86,32]],"oldText":"","newText":" "}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,31],[86,31]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,31],[86,31]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward"},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,17],[86,22]],"newRange":[[86,17],[86,31]],"oldText":"WorkC","newText":"WorkController"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,22],[86,22]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,22],[86,22]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,21],[86,21]],"newRange":[[86,21],[86,22]],"oldText":"","newText":"C"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,21],[86,21]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,21],[86,21]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,20],[86,20]],"newRange":[[86,20],[86,21]],"oldText":"","newText":"k"}},{"type":"change","content":{"oldRange":[[86,19],[86,19]],"newRange":[[86,19],[86,20]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[86,18],[86,18]],"newRange":[[86,18],[86,19]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[86,17],[86,17]],"newRange":[[86,17],[86,18]],"oldText":"","newText":"W"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,17],[86,17]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,18],[86,18]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,16],[86,16]],"newRange":[[86,16],[86,18]],"oldText":"","newText":"''"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,16],[86,16]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,17],[86,17]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,15],[86,15]],"newRange":[[86,15],[86,17]],"oldText":"","newText":"()"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,15],[86,15]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,15],[86,15]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,14],[86,14]],"newRange":[[86,14],[86,15]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[86,13],[86,13]],"newRange":[[86,13],[86,14]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[86,12],[86,12]],"newRange":[[86,12],[86,13]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[86,11],[86,11]],"newRange":[[86,11],[86,12]],"oldText":"","newText":"."}},{"type":"change","content":{"oldRange":[[86,10],[86,10]],"newRange":[[86,10],[86,11]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[86,9],[86,9]],"newRange":[[86,9],[86,10]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[86,8],[86,8]],"newRange":[[86,8],[86,9]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[86,7],[86,7]],"newRange":[[86,7],[86,8]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[86,6],[86,6]],"newRange":[[86,6],[86,7]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[86,5],[86,5]],"newRange":[[86,5],[86,6]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[86,4],[86,4]],"newRange":[[86,4],[86,5]],"oldText":"","newText":"c"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,4],[86,4]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,4],[86,4]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,4],[86,5]],"newRange":[[86,4],[86,4]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[86,5],[86,6]],"newRange":[[86,5],[86,5]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[86,6],[86,7]],"newRange":[[86,6],[86,6]],"oldText":"o","newText":""}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,7],[86,7]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,7],[86,7]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,6],[86,6]],"newRange":[[86,6],[86,7]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[86,5],[86,5]],"newRange":[[86,5],[86,6]],"oldText":"","newText":"c"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[86,5],[86,5]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[86,5],[86,5]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[86,0],[86,0]],"newRange":[[86,0],[86,5]],"oldText":"","newText":"\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[85,62],[85,62]],"newRange":[[85,62],[86,0]],"oldText":"","newText":"\n"}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[85,61],[85,61]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}}]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/portal/controller/WorkController.js","digestWhenLastPersisted":"c7a5bcff814679ce3eaa5be81a7beb6fed49328b","preferredLineEnding":null,"nextMarkerId":349,"deserializer":"TextBuffer","version":5},{"id":"5b5b6e90a835c3b7ce43d245343f592f","text":"\"use strict\";\n\nvar mongoose = require('mongoose'),\n    _ = require('underscore'),\n    logger = require('../utils/logentries')(),\n    when = require('promised-io/promise'),\n    TimeInterval = require('./TimeInterval.js').model(),\n    BHAccount = require('./BHAccount.js').model(),\n    TreatmentBooking = require('./TreatmentBooking.js').model(),\n    OnRemoteDeleteAbstract = require('./abstract/OnRemoteDeleteSchemaAbstract.js'),\n    LogHistorySchemaAbstract = require('./abstract/LogHistorySchemaAbstract.js'),\n    PrePostMixin = require('./abstract/PrePostMixin.js');\n\nvar Name = 'Treatment';\n\nvar TreatmentImage = new mongoose.Schema({\n    _id: false,\n    date : { type : Date, default : Date.now, required : true },\n    url  :  { type : String, required : true },\n\n    confirmed\t\t\t: { type: Boolean, default: false, index:true}, // show or not\n    revised\t\t\t  : { type: Boolean, default: false, index:true} // modarated or not\n});\n\nvar Schema = new mongoose.Schema({\n\t_idBHAccount: String,\n\n    idBHCategory: [String],\n    namePublic: String,\n\n    category: String,\n    name: String,\n    description: String,\n\n    nameTicket:String,\n    price: Number,\n    priceDiscount: Number,\n    discount: Number,\n    discountExpiration: Date,\n\n    gender: { type: String, default: \"all\"}, /* male , female , boy , girl */\n    tax: Number,\n    avgtime: { type: Number, min: 0, max: 1440}, /*Minutes*/\n\n    idTreatmentBooking: String,\n\n    idEmployee: String,\n    visibility: String, /* agenda , client , all */\n\n    //Dates\n    datemod : { type: Date , default: new Date(2013, 1, 1) },\n\n    /**\n     * TreatmentPack Attributes\n     */\n    idTreatment: [String], // Treatments included in a treatment-pack ( this attribute is only available in a treatment-pack )\n\n    sharedKey: String,\n\n    //If its shown in its web\n    web: String,\n\n    imported: Boolean, // if imported from file\n\n    // Stablishes if the works made by the center have applied their discount\n    ownDiscount: Boolean,\n\n    images: [ TreatmentImage ]\n});\n\nSchema.index({ _idBHAccount: 1 });\n\nSchema.index({ sharedKey: 1 , _idBHAccount: 1 });\n\nSchema.virtual('pvp').get(function(){\n    return Math.round((this.price || 0) * (1 + ( (this.tax || 0 )/ 100 ) ), 2);\n});\n\nSchema.virtual('pvpWithoutRound').get(function(){\n    return (this.price || 0) * (1 + ( (this.tax || 0 )/ 100 ) );\n});\n\nSchema.virtual('pvpWithDiscount').get(function(){\n    return Math.round((this.priceDiscount || 0) * (1 + ( (this.tax || 0 )/ 100 ) ), 2);\n});\n\nSchema.virtual('pvpWithDiscountWithoutRound').get(function(){\n    return (this.priceDiscount || 0) * (1 + ( (this.tax || 0 )/ 100 ) );\n});\n\nSchema.methods.availableDays = function(from, to, resourceHints, callback){\n    var response = new when.Deferred();\n    var promises = [];\n    var Resource = require('./Resource.js').model();\n\n    TreatmentBooking.findOne({ _id : this.idTreatmentBooking }, function(err, treatmentBooking){\n        if(err){\n            if(callback)\n                callback(err);\n            return  logger.error(err);\n        }\n        while(from < to){\n            var currentDate = new Date(from.getTime());\n            promises.push(when.all(currentDate, Resource.getAvailableIntervals(this._idBHAccount, treatmentBooking.resourceClass, currentDate, this.avgtime, resourceHints)));\n            from.setUTCDate(from.getUTCDate() + 1);\n        }\n        when.all(promises).then(function(results){\n            var days = [];\n            results.forEach(function(result){\n                var result = _.object(['day', 'intervals'], result);\n                if(result.intervals.length)\n                    days.push(result.day);\n            });\n            days.sort(function(a, b){\n                return a - b;\n            });\n            if(callback)\n                callback(null, days);\n            response.resolve(days);\n        }.bind(this));\n    }.bind(this));\n    return response;\n};\n\n\nSchema.methods.availableIntervals = function(date, resourceHints, callback) {\n    var response = new when.Deferred();\n    var today = TimeInterval.fakeUTC();\n    today.setUTCHours(0, 0, 0, 0);\n    if(date < today) { //Fechas pasadas\n        if(callback)\n            callback(null, []);\n        return response.resolve([]);\n    }\n    var Resource = require('./Resource.js').model();\n\n    TreatmentBooking.findWithoutBHAccount({ _id : this.idTreatmentBooking }, function(err, treatmentBookings){\n        if(err){\n            if(callback)\n                callback(err);\n            return  logger.error(err);\n        }\n        if(!treatmentBookings.length){\n            if(callback)\n                callback(\"Invalid treatment\");\n            return  logger.error(\"Invalid treatment\");\n        }\n        Resource.getAvailableIntervals(this._idBHAccount, treatmentBookings[0].resourceClass, date, this.avgtime, resourceHints, false, function(err, intervals){\n            if(callback)\n                callback(err, intervals);\n            if(!err)\n                response.resolve(intervals);\n        }.bind(this));\n    }.bind(this));\n\n    return response;\n};\n\n// FIXME\nfunction _fromHour(from){\n    return Math.floor(from / 100);\n}\n\nfunction _fromMinute(from){\n    return from - (Math.floor(from / 100) * 100);\n}\n\nfunction _toHour(to){\n    return Math.floor(to / 100);\n}\n\nfunction _toMinute(to){\n    return to - (Math.floor(to / 100) * 100);\n}\n\n// Custom today comes from a diferent timezone, need to use that if  exists\nvar intervalsToHours = function(date, intervals, increment, idTreatmentBooking, customToday){\n    var promise = new when.Deferred();\n    TreatmentBooking.findWithoutBHAccount({ _id : idTreatmentBooking }, function(err, treatmentBooking){\n        increment = increment || 15; //FIXME\n        var availableHours = {};\n        var today = customToday || new Date();\n        today.setTime(today.getTime() + (treatmentBooking[0].timeBeforeBooking || 0)*60*1000);\n        var now = TimeInterval.fakeUTC(today.getFullYear(), today.getMonth(),today.getDate(), today.getHours(), today.getUTCMinutes());\n        (intervals || []).forEach(function(interval) {\n            var dateStart =  new Date(date.getTime());\n            var dateEnd = new Date(date.getTime());\n            dateStart.setUTCHours(_fromHour(interval.from), Math.ceil(_fromMinute(interval.from) / increment) * increment, 0, 0);\n\n            if(dateStart < now){\n                dateStart = now;\n                dateStart.setUTCMinutes(Math.ceil(dateStart.getUTCMinutes() / increment) * increment, 0, 0);\n            }\n            dateEnd.setUTCHours(_toHour(interval.to), _toMinute(interval.to));\n            while(dateStart <= dateEnd){\n                availableHours[dateStart.getTime()] = new Date(dateStart.getTime());\n                dateStart.setUTCMinutes(dateStart.getUTCMinutes() + increment);\n            }\n        });\n        promise.resolve(_.values(availableHours));\n    });\n    return promise.promise;\n};\n\nvar addMinutes = function(currentTime, minutes){\n    var hours = Math.floor(currentTime /100) + (minutes > 0 ? Math.floor(minutes/60) : Math.ceil(minutes/60));\n    minutes = currentTime - (Math.floor(currentTime /100) * 100) + minutes%60;\n    if(minutes < 0)\n    {\n        minutes = 60 + minutes;\n        hours--;\n    } else if(minutes > 59) {\n        minutes = 60 - minutes;\n        hours++;\n    }\n    return Math.max(Math.min((hours * 100) + minutes, 2359), 0);\n};\n\nvar combinedInterval = function(interval1, duration1, interval2){\n\n    if(interval1.weekDay !== null && interval1.weekDay != interval2.weekDay)\n        return null;\n\n    //Minimo y maximo momento que puede haber transicion T1 -> T2 segun cada intervalo:\n    var minSequenceMoment1 = addMinutes(interval1.from, duration1);\n    var maxSequenceMoment1 = interval1.to;\n\n    var minSequenceMoment2 = interval2.from;\n    var maxSequenceMoment2 = addMinutes(interval2.to, - duration1);\n\n    if(minSequenceMoment2 > maxSequenceMoment1) //Estan separados los interlos  [  T1  ]     [   T2   ]\n        return null;\n    if(maxSequenceMoment2 < minSequenceMoment1) //Imposible hacer primero T1 y luego T2!  [  T2  ] [  T1  ]\n        return null;\n\n    return new TimeInterval({\n        weekDay: interval1.weekDay,\n        from: Math.max(addMinutes(minSequenceMoment1, -duration1), addMinutes(minSequenceMoment2, -duration1)),\n        to: Math.min(maxSequenceMoment1, maxSequenceMoment2) // Teniendo en cuenta [   T1   [ T2 ]   ]\n    });\n\n};\n\n\nvar availableIntervalsCombined = function(treatments, date, hints, callback) {\n    var response = new when.Deferred();\n    var promises = new Array(treatments.length);\n    treatments.forEach(function(treatment, i){\n        promises[i] = new when.Deferred();\n        treatment.availableIntervals(date, hints, function(err, intervals){\n            if(err)\n                return callback(err);\n            //A cada intervalo le restamos el tiempo que dura el propio tratamiento, porque esos ultimos XXX minutos no lo vamos a poder reservar\n            intervals.forEach(function(interval){\n                interval.to = addMinutes(interval.to, -treatments[i].avgtime);\n            });\n            promises[i].resolve(intervals||[]);\n        });\n    });\n    when.all(promises).then(function(results){\n        //Empezamos con los intervalos del primer tratamiento\n        var intervals = results.shift();\n        var duration = treatments[0].avgtime;\n        results.forEach(function(treatmentIntervals, i){\n            var newIntervals = [];\n            intervals.forEach(function(interval1){\n                treatmentIntervals.forEach(function(interval2){\n                    var newInterval = combinedInterval(interval1, duration, interval2);\n                    if(newInterval)\n                        newIntervals.push(newInterval);\n                });\n            });\n            duration += treatments[i+1].avgtime; //Hay que sumarle 1 a i pq le hemos quitado el primer grupo\n            intervals = newIntervals;\n        });\n        if(callback)\n            callback(null, intervals);\n        response.resolve(intervals);\n    });\n    return response;\n};\n\n\nSchema.methods.availableHours = function(date, resourceHints, callback, customToday) {\n    var response = new when.Deferred();\n    var increment = 15; //FIXME !!!\n    this.availableIntervals(date, resourceHints, function(err, intervals){\n        if(err){\n            callback(err);\n            return response.resolve(err);\n        }\n\n        var avgtime = -this.avgtime;\n        intervals = _.map(intervals, function(interval){\n            return {\n                weekDay:interval.weekDay,\n                from: interval.from,\n                to: addMinutes(interval.to, avgtime)\n            };\n        });\n\n        //Quitar los ultimos xxx minutos que no se pueden reservar\n        intervalsToHours(date, intervals, increment, this.idTreatmentBooking,\n                customToday).then(function(ret){\n             if(callback)\n                callback(null, ret);\n            response.resolve(ret);\n        });\n    }.bind(this));\n    return response;\n};\n\nSchema.virtual('isPack').get(function(){\n    return this.idTreatment && this.idTreatment.length > 1;\n});\n\nLogHistorySchemaAbstract.addMiddlewaresToSchema( Name , Schema );\n\nvar Model = function() { this.init.apply(this, arguments); };\n\n_.extend( Model.prototype, LogHistorySchemaAbstract.prototype , {\n\n    modelName : Name,\n\n    foreigns : [ 'BHAccount' , 'TreatmentBooking' ],\n\n    onRemoteDelete : {\n\n        'Employee' : 'deleteReference'\n    },\n\n    availableHoursCombined : function(treatments, date, hints, callback, customToday) {\n        var response = new when.Deferred();\n        //FIXME que hacemos si son tratramientos multiples?\n        //seguramente nos quedamos con el tratamiento que tenga el horario mas restringido.\n        availableIntervalsCombined(treatments, date, hints, function(err, intervals){\n            var ret = intervalsToHours(date, intervals, null, null, customToday);\n            if(callback)\n                callback(null, ret);\n            response.resolve(ret);\n        });\n        return response;\n    },\n\n\n    availableDaysCombined : function(treatments, from, to, hints, callback){\n        var response = new when.Deferred();\n        var promises = [];\n        while(from < to){\n            var currentDate = new Date(from.getTime());\n            promises.push(when.all(currentDate, availableIntervalsCombined(treatments, currentDate, hints)));\n            from.setUTCDate(from.getUTCDate() + 1);\n        }\n        when.all(promises).then(function(results){\n            var days = [];\n            results.forEach(function(result){\n                var result = _.object(['day', 'intervals'], result);\n                if(result.intervals.length)\n                    days.push(result.day);\n            });\n            days.sort(function(a, b){\n                return a - b;\n            });\n            if(callback)\n                callback(null, days);\n            response.resolve(days);\n        });\n        return response;\n    }\n});\n\nPrePostMixin( Schema );\n\nvar purgeTreatmentBooking = function(treatment, idTreatmentBooking){\n    if(!idTreatmentBooking)\n        return;\n\n    var m = new Model(mongoose.model(Name, Schema));\n    m.idBHAccount = treatment._idBHAccount;\n    m.find({ _id : {$ne : treatment._id }, idTreatmentBooking : idTreatmentBooking }, function( err , treats ) {\n        if( treats.length === 0 ) {\n            TreatmentBooking.findOne({ _id: idTreatmentBooking }, function(err , tb ) {\n                if( tb ) tb.remove();\n            });\n        }\n    });\n};\n\nSchema.methods.onChangedAttribute = {\n\n    idTreatmentBooking: function(oldIdTreatmentBooking){\n        purgeTreatmentBooking(this, oldIdTreatmentBooking);\n    },\n\n    discount: function() {\n        this.discountExpiration = new Date( Date.now() + 5184000000 ); // today + 60 days\n    }\n};\n\nSchema.post( 'remove' , function( treatment) {\n    purgeTreatmentBooking(treatment,  treatment.idTreatmentBooking );\n});\n\nvar copyFields = [ //Campos que updateamos\n    'idBHCategory', 'namePublic', 'category', 'name', 'description', 'nameTicket', 'price',\n    'priceDiscount', 'discount', 'discountExpiration', 'gender', 'tax', 'avgtime', 'visibility'\n];\n\nSchema.post( 'save' , function( treatment) {\n    if(treatment.skipPost || !treatment.sharedKey)\n        return;\n    if(treatment.__wasNew){ //Ojo, uso el __wasnew pq esto hereda de prepostmixin\n        BHAccount.findOne({ _id: treatment._idBHAccount }, function(err, bhAccount){\n            if(!bhAccount || !bhAccount.accountGroup)\n                return;\n            BHAccount.find({ accountGroup: bhAccount.accountGroup, _id : { $ne : bhAccount._id } }, function(err, bhAccounts){\n                bhAccounts.forEach(function(bhAccount){\n                    var t = new treatment.constructor({ _idBHAccount : bhAccount.id, sharedKey : treatment.sharedKey });\n                    copyFields.forEach(function(property){\n                        t[property] = treatment[property];\n                    });\n                    t.skipPost = true;\n                    t.save();\n                });\n            });\n        });\n    } else {\n        treatment.constructor.find({ sharedKey : treatment.sharedKey, _id : { $ne: treatment.id }}, function(err, treatments){\n            treatments.forEach(function(t){\n                copyFields.forEach(function(property){\n                    t[property] = treatment[property];\n                });\n                t.skipPost = true;\n                t.save()\n            });\n        });\n    }\n});\n\nSchema.pre( 'save' , function(next) {\n    if(this.discount) this.priceDiscount = (this.price||0) * (1-this.discount/100);\n    else if(!this.discount || this.discount == 0) this.priceDiscount = null;\n    next();\n});\n\n\nmodule.exports = {\n\tschema: function() {  return Schema; },\n\tmodel: function() {  return new Model(mongoose.model(Name, Schema)); }\n};\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":0,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"4":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"8":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"9":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"10":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"11":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"12":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"13":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"14":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"15":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"16":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"17":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"18":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"19":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"50":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"66":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"333":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"340":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"924":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"925":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"926":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"927":{"range":{"start":{"row":450,"column":0},"end":{"row":450,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":281,"column":0},"end":{"row":281,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"5":{"id":"5","maintainHistory":false,"markersById":{},"version":2},"6":{"id":"6","maintainHistory":false,"markersById":{},"version":2},"7":{"id":"7","maintainHistory":false,"markersById":{},"version":2},"9":{"id":"9","maintainHistory":false,"markersById":{},"version":2},"10":{"id":"10","maintainHistory":false,"markersById":{},"version":2},"18":{"id":"18","maintainHistory":false,"markersById":{},"version":2},"19":{"id":"19","maintainHistory":false,"markersById":{},"version":2},"27":{"id":"27","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":28,"history":{"version":3,"nextCheckpointId":144,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/portal/common/model/Treatment.js","digestWhenLastPersisted":"8fadb9dc1b1d1357f52a7f12783848289f837fab","preferredLineEnding":null,"nextMarkerId":961,"deserializer":"TextBuffer","version":5},{"id":"27d39d361a2322e4d865293ace2ce2bb","text":"\"use strict\";\n/*\n\tRepresentation of a resource suitable for doing some types of treatments. A resource can be an employee, an UV cabin or even\n\tan hairdresser hair dryer.\n*/\nvar mongoose = require('mongoose'),\n\tSchema = mongoose.Schema,\n\tObjectId = mongoose.Types.ObjectId,\n\tUtil = require('util'),\n\t_ = require('underscore'),\n\twhen = require('promised-io/promise'),\n\tWork = require('./Work.js').model(),\n\tWorkBusy = require('./WorkBusy.js').model(),\n\tTimeInterval = require('./TimeInterval.js').model(),\n\tTimetable = require('./Timetable.js').model(),\n\tTimeIntervalSchema = require('./TimeInterval.js').schema(),\n\tOnRemoteDeleteAbstract = require('./abstract/OnRemoteDeleteSchemaAbstract.js');\n\nvar Name = 'Resource';\n\nvar ResourceSchema = new mongoose.Schema({\n\t//_bhAccount\t: { type: Schema.Types.ObjectId, ref: 'BHAccount' },\n\t_idBHAccount    : String,\n\tidEmployee\t\t: String, //!!!!! ANTES ERA _idEmployee, cambiar donde toque\n\tname \t\t\t: String,\n\tresourceClass\t: [ String ], /* Ej: Peluquero, Lampara UVA... Puede ser mas de un rol (ej.: Peluquera/Manicura) */\n\tschedule \t\t: [ TimeIntervalSchema ],\n\tblockedDays \t: [{ from: Date, to: Date, _id : false }],\n\n\t//\"agenda\" config\n\ta_casher \t\t: String,\n\ta_idTreatments \t: [String],\n\ta_categories\t: [String],\n\ta_labels \t\t: { type: [ String ] , default: [ 'mid' , 'client' , 'lastname' , 'cat' , 'name' ] }\n});\n\nResourceSchema.virtual('resources').get(function () {\n  this.resources ? this.resources : [];\n});\n\nResourceSchema.virtual('resources').set(function (resources) {\n  this.resources = _.uniq(resources);\n});\n\nResourceSchema.index({\n\t_idBHAccount : 1,\n\tresourceClass : 1\n});\n\n/*\n\tFlags supported when looking for available resources\n*/\nvar resourceFlags = {\n\tIGNORE_RESOURCE_SCHEDULE : 1,\n\tIGNORE_RESOURCE_BLOCKED_DAYS : 2,\n\tIGNORE_MAIN_SCHEDULE : 4,\n\tIGNORE_MAIN_BLOCKED_DAYS :8,\n\tIGNORE_WORKS : 16,\n\tMAX_HAPPINESS : 31, //Ignore everything\n};\n\n/*\n\tUtility method, returns a TimeInterval from the busy time consumed by the work\n*/\nvar workResource2Interval = function(workResource){\n\treturn new TimeInterval({\n\t\tweekDay : workResource.from.getUTCDay(),\n\t\tfrom \t: workResource.from.getUTCHours() * 100 + workResource.from.getUTCMinutes(),\n\t\tto \t\t: workResource.to.getUTCHours() * 100 + workResource.to.getUTCMinutes()\n\t});\n};\n\n/*\n\tReturns the resource's available intervals for the specified date\n*/\nResourceSchema.methods.getAvailableIntervals = function(date, callback, flags) {\n\tvar response = new when.Deferred();\n\tvar promises = [];\n\t//We need the main schedule\n\tif(flags & resourceFlags.IGNORE_MAIN_SCHEDULE){\n\t\tpromises.push(null);\n\t} else {\n\t\tvar conditions = {\n\t\t\t_idBHAccount : this._idBHAccount,\n\t\t\ttype:\"BHAccount\" ,\n\t\t\t'schedule.weekDay' : date.getUTCDay(),\n\t\t};\n\t\tif(!(flags & resourceFlags.IGNORE_MAIN_BLOCKED_DAYS))\n\t\t\tconditions['blockedDays'] = {$not: { $elemMatch : { from: { $lte : day}, to : { $gte : day } } } };\n\t\tpromises.push(Timetable.findWithoutBHAccount(conditions).exec());\n\t}\n\t//Also whe need the works affecting this resource for the specified date\n\tif(flags & resourceFlags.IGNORE_WORKS){\n\t\tpromises.push([]);\n\t} else {\n\t\tvar day = TimeInterval.fakeUTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());\n\t\tvar minDate = new Date(day.getTime());\n\t\tminDate.setUTCHours(minDate.getUTCHours() - 12);\n\t\tvar maxDate = new Date(day.getTime());\n\t\tmaxDate.setUTCHours(maxDate.getUTCHours() + 12);\n\t\tvar conditions = {\n\t\t\t_idBHAccount : this._idBHAccount,\n\t\t\tday : {  $gte : minDate, $lte: maxDate },\n\t\t\t'resources.idResource' : this._id,\n\t\t\tstate : { $nin : [ 'res_rejected', 'res_client_rejected', 'res_missing'] }\n\t\t};\n\t\tpromises.push(Work.findWithoutBHAccount(conditions).exec());\n\t\tvar nextDay = new Date(day.getTime());\n\t\tnextDay.setUTCDate(day.getUTCDate() + 1);\n\t\tvar conditions = {\n\t\t\t_idBHAccount : this._idBHAccount,\n\t\t\tfrom : { $gte : day },\n\t\t\tto : { $lt : nextDay },\n\t\t\tidResource : this._id\n\t\t};\n\t\tpromises.push(WorkBusy.findWithoutBHAccount(conditions).exec())\n\t}\n\n\twhen.all(promises).then(function(data){\n\t\tdata = _.object(['mainTimetable', 'works', 'worksBusy'] , data);\n\t\tvar busyIntervals = data.worksBusy.map(workResource2Interval);\n\t\t//Convert the affecting works to their respective TimeIntervals using workResource2Interval\n\t\tdata.works.forEach(function(work){\n\t\t\twork.resources.forEach(function( workResource){\n\t\t\t\tif(workResource && workResource.idResource == this.id)\n\t\t\t\t\tbusyIntervals.push(workResource2Interval(workResource));\n\t\t\t}.bind(this));\n\t\t});\n\t\t//Using the internal function, compute the resulting free intervals\n\t\tvar intervals = this._getAvailableIntervals(date, busyIntervals, data.mainTimetable, flags);\n\t\tif(callback)\n\t\t\tcallback(null, intervals);\n\t\tresponse.resolve(intervals);\n\t}.bind(this));\n\n\treturn response;\n};\n\n/*\n\tReturn the reosurce's available intervals for the specified date. This method is intended for internal use, it also needs the timeIntervals\n\tderived from works using this interval the specified date, and the timetable of the centre.\n*/\nResourceSchema.methods._getAvailableIntervals = function(date, busyIntervals, mainTimetable, flags) {\n\t//Check if current day is blocked either in the centre timetable or in the own resource timetable.\n\tvar blockedDays = flags & resourceFlags.IGNORE_RESOURCE_BLOCKED_DAYS ? [] : this.blockedDays;\n\tif(!(flags & resourceFlags.IGNORE_MAIN_BLOCKED_DAYS) && mainTimetable)\n\t\tblockedDays.concat(mainTimetable.blockedDays);\n\tfor(var i = 0; i < blockedDays.length; i++){\n\t\tif(date >= blockedDays[i].from && date <= blockedDays[i].to)\n\t\t\treturn [];\n\t}\n\t//Choose the schedule to use from main schedule, resource schedule or a fully opened schedule\n\tvar schedule = flags & resourceFlags.IGNORE_MAIN_SCHEDULE ? [new TimeInterval({ weekDay : null, from: Number.NEGATIVE_INFINITY, to: Number.POSITIVE_INFINITY })] : mainTimetable.schedule;\n\tif((this.schedule || []).length && !(flags & resourceFlags.IGNORE_RESOURCE_SCHEDULE))\n\t\tschedule = this.schedule;\n\tvar intervals = schedule.filter(function(scheduleItem){ return scheduleItem.weekDay === null || scheduleItem.weekDay == date.getUTCDay(); });\n\n\t//Remove from the given intervals, the busy hours from other appointments using timeInterval.exclude\n\tif(flags & resourceFlags.IGNORE_WORKS)\n\t\tbusyIntervals = [];\n\tbusyIntervals.forEach(function(busyInterval){\n\t\tvar newArray = [];\n\t\tintervals.forEach(function(interval){ //Every iteration can produce new intervals, eventually more fragmented, or return the same intervals\n\t\t\tnewArray = newArray.concat(interval.exclude(busyInterval, date));\n\t\t});\n\t\tintervals = newArray;\n\t});\n\treturn intervals;\n};\n\n\n\nvar Model = function() { this.init.apply(this, arguments); };\n\n_.extend( Model.prototype, OnRemoteDeleteAbstract.prototype , {\n\n    modelName : Name,\n\n/*\n\tReturns avalilable intervals from resources of the given resourceClasses and date. It filters intervals shorter than minTime and optionally can\n\trestrict the search to resources specified in the hints parameter.\n*/\n   getAvailableIntervals : function(_idBHAccount, resourceClasses, date, minTime, hints, flags, callback) {\n   \t\tvar response = new when.Deferred();\n   \t\tif(!resourceClasses.length){\n   \t\t\tcallback('No resourceClasses!');\n   \t\t\tresponse.resolve([]);\n   \t\t}\n\t\tvar day = TimeInterval.fakeUTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());\n\t\tvar mainTimetable;\n\t\tvar searchResources = function(){\n\t\t\t//Primero buscar los recursos que son de alguna de las clases que necesitamos y 'trabajan' ese dia\n\t\t\tvar options = {\n\t\t\t\t'_idBHAccount' : _idBHAccount,\n\t\t\t\t'resourceClass' : { $in : resourceClasses }\n\t\t\t};\n\t\t\tif(!(flags & resourceFlags.IGNORE_RESOURCE_SCHEDULE)){\n\t\t\t\toptions['$or'] = [\n\t\t\t\t\t{ 'schedule.weekDay' : day.getUTCDay()\t},\n\t\t\t\t\t//Agarrense que vienen curvas!!\n\t\t\t\t\t{ 'schedule' : null\t},\n\t\t\t\t\t{ 'schedule' : [] },\n\t\t\t\t\t{ 'schedule' : { $type: 6 } },\n\t\t\t\t\t{ 'schedule' : { $type: 10 } }\n\t\t\t\t];\n\t\t\t\tif(!(flags & resourceFlags.IGNORE_RESOURCE_BLOCKED_DAYS))\n\t\t\t\t\toptions['$or'][0]['blockedDays'] = {$not: { $elemMatch : { from: { $lte : day}, to : { $gte : day } } } };\n\t\t\t}\n\t\t\tthis.Model.find(options).exec(function(err, resources){\n\t\t\t\tif(err)\n\t\t\t\t\treturn callback(err);\n\t\t\t\twhen.all([searchWorks(resources), searchWorksBusy(resources)]).then(function(arr){\n\t\t\t\t\tcalcIntervals(resources, arr[0], arr[1]);\n\t\t\t\t});\n\t\t\t});\n\t\t}.bind(this);\n\n\t\tvar searchWorks = function(resources){\n\t\t\tif(flags & resourceFlags.IGNORE_WORKS)\n\t\t\t\treturn [];\n\t\t\t//A veces no tenemos el day justo a las  00:00:00, vamos a buscar en un rango de +-12 horas por los desajustes horarios\n\t\t\tvar minDate = new Date(day.getTime());\n\t\t\tminDate.setUTCHours(minDate.getUTCHours() - 12);\n\t\t\tvar maxDate = new Date(day.getTime());\n\t\t\tmaxDate.setUTCHours(maxDate.getUTCHours() + 12);\n\t\t\treturn Work.findWithoutBHAccount({\n\t\t\t\t_idBHAccount : _idBHAccount,\n\t\t\t\tday : {  $gte : minDate, $lte: maxDate },\n\t\t\t\t'resources.idResource' : { $in : _.pluck(resources, '_id') },\n\t\t\t\tstate : { $nin : [ 'res_rejected', 'res_client_rejected', 'res_missing'] }\n\t\t\t}).exec();\n\t\t};\n\n\n\t\tvar searchWorksBusy = function(resources){\n\t\t\tif(flags & resourceFlags.IGNORE_WORKS)//De momento paso de hacer otro flag mas que me canso\n\t\t\t\treturn [];\n\t\t\tvar nextDay = new Date(day.getTime());\n\t\t\tnextDay.setUTCDate(day.getUTCDate() + 1);\n\t\t\tvar conditions = {\n\t\t\t\t_idBHAccount : _idBHAccount,\n\t\t\t\tfrom : { $gte : day },\n\t\t\t\tto : { $lt : nextDay },\n\t\t\t\tidResource : { $in : _.pluck(resources, '_id') }\n\t\t\t};\n\t\t\treturn WorkBusy.findWithoutBHAccount(conditions).exec();\n\t\t};\n\n\n\t\tvar calcIntervals = function(resources, works, worksBusy){\n\t\t\tvar intervalsByResource = {};\n\t\t\tvar busyIntervalsByResource = {};\n\t\t\tvar resourcesByClass = {};\n\t\t\tresourceClasses.forEach(function(resourceClass){\n\t\t\t\tresourcesByClass[resourceClass] = [];\n\t\t\t});\n\t\t\t//Agrupamos los recursos por su clase (pueden estar en distintas clases)\n\t\t\tresources.forEach(function(resource){\n\t\t\t\tbusyIntervalsByResource[resource._id] = [];\n\t\t\t\tresource.resourceClass.forEach(function(resourceClass){\n\t\t\t\t\tif(resourcesByClass[resourceClass])\n\t\t\t\t\t\tresourcesByClass[resourceClass].push(resource);\n\t\t\t\t});\n\t\t\t});\n\t\t\t//A partir de las reservas, generamos intervalso de tiempo 'ocupados' y los agrupamos por recurso\n\t\t\tworks.forEach(function(work){\n\t\t\t\twork.resources.forEach(function(workResource){\n\t\t\t\t\tif(!workResource || !workResource.idResource) return;\n\t\t\t\t\tworkResource.idResource.forEach(function(idResource){\n\t\t\t\t\t\tif(!idResource) return;\n\t\t\t\t\t\tif(busyIntervalsByResource[idResource])\n\t\t\t\t\t\t\tbusyIntervalsByResource[idResource].push(workResource2Interval(workResource));\n\t\t\t\t\t}.bind(this));\n\t\t\t\t}.bind(this));\n\t\t\t}.bind(this));\n\t\t\t//Tambien añadimos los workBusy como intervalos ocupados que son\n\t\t\tworksBusy.forEach(function(workBusy){\n\t\t\t\tbusyIntervalsByResource[workBusy.idResource].push(workResource2Interval(workBusy));\n\t\t\t}.bind(this));\n\n\t\t\t//Obtenemos los intervalos disponibles, 'descontando' los intervalos ocupados por las reservas\n\t\t\tresources.forEach(function(resource){\n\n\t\t\t\tintervalsByResource[resource._id] = resource._getAvailableIntervals(date, busyIntervalsByResource[resource._id], this.mainTimetable, flags);\n\t\t\t}.bind(this));\n\t\t\t//Ahora tenemos q intervalos disponibles hay para cada uno de los recursos que tenemos, hacemos todas las combinaciones que nos den resources\n\t\t\tvar availableIntervals = [];\n\t\t\tvar combineResources = function(resourceClassIndex, timeInterval){\n\t\t\t\tif(!resourceClassIndex) {\n\t\t\t\t\tresourceClassIndex = 0;\n\t\t\t\t}\n\t\t\t\tvar currentResourceClass = resourceClasses[resourceClassIndex];\n\t\t\t\tif ((resourcesByClass[currentResourceClass] &&\n\t\t\t\t\t\tresourcesByClass[currentResourceClass].length === 0) ||\n\t\t\t\t \t\t!resourcesByClass[currentResourceClass]) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tresourcesByClass[currentResourceClass].forEach(function( resource ){\n\t\t\t\t\tintervalsByResource[resource._id].forEach(function( interval ){\n\t\t\t\t\t\tvar newTimeInterval = timeInterval? timeInterval.restrict(interval) : interval;\n\t\t\t\t\t\tif(!newTimeInterval || newTimeInterval.duration(date) < minTime)\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\tnewTimeInterval.resources = timeInterval? timeInterval.resources.concat([resource]) : [resource];\n\n\t\t\t\t\t\tif(resourceClassIndex == resourceClasses.length - 1) {\n\t\t\t\t\t\t\tif(!hints)\n\t\t\t\t\t\t\t\treturn availableIntervals.push(newTimeInterval);\n\t\t\t\t\t\t\tvar idResources = newTimeInterval.resources.map(function(resource){\n\t\t\t\t\t\t\t\treturn resource._id.toString();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif(hints.every(function(idResource){\n\t\t\t\t\t\t\t\treturn idResources.indexOf(idResource) >= 0;\n\t\t\t\t\t\t\t})) {\n\t\t\t\t\t\t\t\tavailableIntervals.push(newTimeInterval);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcombineResources(resourceClassIndex + 1, newTimeInterval);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t};\n\t\t\tcombineResources();\n\t\t\tavailableIntervals.sort(function(a, b){\n\t\t\t\treturn a.from != b.from ? a.from - b.from : b.duration(date) - a.duration(date);\n\t\t\t});\n\t\t\tif(callback)\n\t\t\t\tcallback(null, availableIntervals);\n\t\t\tresponse.resolve(availableIntervals);\n\n\t\t}.bind(this);\n\t\tif(flags & resourceFlags.IGNORE_MAIN_SCHEDULE){\n\t\t\tthis.mainTimetable = null;\n\t\t\tsearchResources();\n\t\t} else {\n\t\t\tvar conditions = {\n\t\t\t\t_idBHAccount : _idBHAccount,\n\t\t\t\ttype:\"BHAccount\" ,\n\t\t\t\t'schedule.weekDay' : date.getUTCDay(),\n\t\t\t};\n\t\t\tif(!(flags & resourceFlags.IGNORE_MAIN_BLOCKED_DAYS))\n\t\t\t\tconditions.blockedDays = {\n\t\t\t\t\t$not: {\n\t\t\t\t\t\t$elemMatch: {\n\t\t\t\t\t\t\tfrom: {$lte: day},\n\t\t\t\t\t\t\tto  : {$gte: day}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\tTimetable.findWithoutBHAccount(conditions, function(err, res){\n\t\t\t\tif(!res.length){ //No tenemos horario principal, estara chapao el centro\n\t\t\t\t\tif(callback)\n\t\t\t\t\t\tcallback(null, []);\n\t\t\t\t\treturn response.resolve([]);\n\t\t\t\t}\n\t\t\t\tthis.mainTimetable = _.first(res);\n\t\t\t\tsearchResources();\n\t\t\t}.bind(this));\n\t\t}\n\t\treturn response;\n\t}\n\n});\n\nmodule.exports = {\n\tschema: function() {  return ResourceSchema; },\n\tmodel: function() {  return new Model(mongoose.model(Name, ResourceSchema)); },\n\tflags : function() { return resourceFlags; }\n}\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":13}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"4":{"range":{"start":{"row":37,"column":37},"end":{"row":37,"column":39}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"5":{"range":{"start":{"row":88,"column":22},"end":{"row":88,"column":102}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"6":{"range":{"start":{"row":100,"column":12},"end":{"row":100,"column":20}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"7":{"range":{"start":{"row":109,"column":12},"end":{"row":109,"column":20}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"8":{"range":{"start":{"row":115,"column":65},"end":{"row":115,"column":65}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"9":{"range":{"start":{"row":88,"column":79},"end":{"row":88,"column":102}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"10":{"range":{"start":{"row":88,"column":99},"end":{"row":88,"column":102}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"290":{"range":{"start":{"row":190,"column":0},"end":{"row":190,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"298":{"range":{"start":{"row":190,"column":0},"end":{"row":190,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"526":{"range":{"start":{"row":355,"column":0},"end":{"row":355,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"537":{"range":{"start":{"row":355,"column":0},"end":{"row":355,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"747":{"range":{"start":{"row":250,"column":0},"end":{"row":250,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"757":{"range":{"start":{"row":250,"column":0},"end":{"row":250,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"overlap"},"2875":{"range":{"start":{"row":294,"column":5},"end":{"row":294,"column":7}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"2954":{"range":{"start":{"row":292,"column":7},"end":{"row":292,"column":8}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"3305":{"range":{"start":{"row":197,"column":22},"end":{"row":197,"column":22}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3306":{"range":{"start":{"row":206,"column":27},"end":{"row":206,"column":111}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3307":{"range":{"start":{"row":206,"column":37},"end":{"row":206,"column":111}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3480":{"range":{"start":{"row":5,"column":15},"end":{"row":5,"column":35}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3481":{"range":{"start":{"row":8,"column":11},"end":{"row":8,"column":24}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3482":{"range":{"start":{"row":9,"column":8},"end":{"row":9,"column":27}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3483":{"range":{"start":{"row":10,"column":11},"end":{"row":10,"column":39}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3484":{"range":{"start":{"row":11,"column":11},"end":{"row":11,"column":37}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3485":{"range":{"start":{"row":12,"column":15},"end":{"row":12,"column":45}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3486":{"range":{"start":{"row":13,"column":19},"end":{"row":13,"column":53}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3487":{"range":{"start":{"row":14,"column":16},"end":{"row":14,"column":47}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3488":{"range":{"start":{"row":15,"column":25},"end":{"row":15,"column":60}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3489":{"range":{"start":{"row":16,"column":29},"end":{"row":16,"column":80}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3734":{"range":{"start":{"row":367,"column":1},"end":{"row":367,"column":1}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3735":{"range":{"start":{"row":363,"column":0},"end":{"row":363,"column":18}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"3744":{"range":{"start":{"row":347,"column":4},"end":{"row":347,"column":5}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"3745":{"range":{"start":{"row":340,"column":29},"end":{"row":340,"column":30}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":347,"column":1},"end":{"row":347,"column":1}},"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{},"version":2},"5":{"id":"5","maintainHistory":false,"markersById":{},"version":2},"6":{"id":"6","maintainHistory":false,"markersById":{},"version":2},"7":{"id":"7","maintainHistory":false,"markersById":{},"version":2},"9":{"id":"9","maintainHistory":false,"markersById":{},"version":2},"10":{"id":"10","maintainHistory":false,"markersById":{},"version":2},"18":{"id":"18","maintainHistory":false,"markersById":{},"version":2},"19":{"id":"19","maintainHistory":false,"markersById":{},"version":2},"27":{"id":"27","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":28,"history":{"version":3,"nextCheckpointId":839,"undoStack":[{"type":"group-start","snapshot":{"2":{"1":{"range":[[190,0],[190,0]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[190,0],[190,0]],"newRange":[[190,0],[190,2]],"oldText":"","newText":"\t\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[190,2],[190,2]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[190,1],[190,1]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[190,2],[190,2]],"newRange":[[190,2],[190,3]],"oldText":"","newText":"\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[190,3],[190,3]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"checkpoint","id":5,"snapshot":{"2":{"1":{"range":[[190,3],[190,3]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}},"isBoundary":false},{"type":"group-start","snapshot":{"2":{"1":{"range":[[190,3],[190,3]],"properties":{"type":"selection","goalScreenRange":null},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[190,2],[190,3]],"newRange":[[190,2],[190,2]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[190,2],[190,2]],"newRange":[[190,2],[190,3]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[190,3],[190,3]],"newRange":[[190,3],[190,4]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[190,4],[190,4]],"newRange":[[190,4],[190,5]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[190,5],[190,5]],"newRange":[[190,5],[190,6]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[190,6],[190,6]],"newRange":[[190,6],[190,7]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[190,7],[190,7]],"newRange":[[190,7],[190,8]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[190,8],[190,8]],"newRange":[[190,8],[190,9]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[190,9],[190,9]],"newRange":[[190,9],[190,10]],"oldText":"","newText":"."}},{"type":"change","content":{"oldRange":[[190,10],[190,10]],"newRange":[[190,10],[190,11]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[190,11],[190,11]],"newRange":[[190,11],[190,12]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[190,12],[190,12]],"newRange":[[190,12],[190,13]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[190,13],[190,13]],"newRange":[[190,13],[190,15]],"oldText":"","newText":"()"}},{"type":"change","content":{"oldRange":[[190,14],[190,14]],"newRange":[[190,14],[190,16]],"oldText":"","newText":"''"}},{"type":"change","content":{"oldRange":[[190,15],[190,15]],"newRange":[[190,15],[190,16]],"oldText":"","newText":"R"}},{"type":"change","content":{"oldRange":[[190,16],[190,16]],"newRange":[[190,16],[190,17]],"oldText":"","newText":"E"}},{"type":"change","content":{"oldRange":[[190,16],[190,17]],"newRange":[[190,16],[190,16]],"oldText":"E","newText":""}},{"type":"change","content":{"oldRange":[[190,15],[190,16]],"newRange":[[190,15],[190,15]],"oldText":"R","newText":""}},{"type":"change","content":{"oldRange":[[190,15],[190,15]],"newRange":[[190,15],[190,16]],"oldText":"","newText":"\\"}},{"type":"change","content":{"oldRange":[[190,16],[190,16]],"newRange":[[190,16],[190,17]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[190,17],[190,17]],"newRange":[[190,17],[190,18]],"oldText":"","newText":"R"}},{"type":"change","content":{"oldRange":[[190,18],[190,18]],"newRange":[[190,18],[190,19]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[190,19],[190,19]],"newRange":[[190,19],[190,20]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[190,20],[190,20]],"newRange":[[190,20],[190,21]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[190,21],[190,21]],"newRange":[[190,21],[190,22]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[190,22],[190,22]],"newRange":[[190,22],[190,23]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[190,23],[190,23]],"newRange":[[190,23],[190,24]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[190,24],[190,24]],"newRange":[[190,24],[190,25]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[190,25],[190,25]],"newRange":[[190,25],[190,26]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[190,26],[190,26]],"newRange":[[190,26],[190,27]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[190,27],[190,27]],"newRange":[[190,27],[190,28]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[190,28],[190,28]],"newRange":[[190,28],[190,29]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[190,29],[190,29]],"newRange":[[190,29],[190,30]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[190,30],[190,30]],"newRange":[[190,30],[190,31]],"oldText":"","newText":"A"}},{"type":"change","content":{"oldRange":[[190,27],[190,31]],"newRange":[[190,27],[190,48]],"oldText":"getA","newText":"getAvailableIntervals"}},{"type":"change","content":{"oldRange":[[190,48],[190,48]],"newRange":[[190,48],[190,49]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[190,49],[190,49]],"newRange":[[190,49],[190,50]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[190,50],[190,50]],"newRange":[[190,50],[190,51]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[190,51],[190,51]],"newRange":[[190,51],[190,52]],"oldText":"","newText":"<"}},{"type":"change","content":{"oldRange":[[190,52],[190,52]],"newRange":[[190,52],[190,53]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[190,52],[190,53]],"newRange":[[190,52],[190,52]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[190,51],[190,52]],"newRange":[[190,51],[190,51]],"oldText":"<","newText":""}},{"type":"change","content":{"oldRange":[[190,51],[190,51]],"newRange":[[190,51],[190,52]],"oldText":"","newText":">"}},{"type":"change","content":{"oldRange":[[190,52],[190,52]],"newRange":[[190,52],[190,53]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[190,53],[190,53]],"newRange":[[190,53],[190,54]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[190,54],[190,54]],"newRange":[[190,54],[190,55]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[190,55],[190,55]],"newRange":[[190,55],[190,56]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[190,56],[190,56]],"newRange":[[190,56],[190,57]],"oldText":"","newText":"p"}},{"type":"change","content":{"oldRange":[[190,57],[190,57]],"newRange":[[190,57],[190,58]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[190,57],[190,58]],"newRange":[[190,57],[190,57]],"oldText":"o","newText":""}},{"type":"change","content":{"oldRange":[[190,56],[190,57]],"newRange":[[190,56],[190,56]],"oldText":"p","newText":""}},{"type":"change","content":{"oldRange":[[190,56],[190,56]],"newRange":[[190,56],[190,57]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[190,57],[190,57]],"newRange":[[190,57],[190,58]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[190,57],[190,58]],"newRange":[[190,57],[190,57]],"oldText":"o","newText":""}},{"type":"change","content":{"oldRange":[[190,56],[190,57]],"newRange":[[190,56],[190,56]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[190,56],[190,56]],"newRange":[[190,56],[190,57]],"oldText":"","newText":"i"}},{"type":"change","content":{"oldRange":[[190,57],[190,57]],"newRange":[[190,57],[190,58]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[190,57],[190,58]],"newRange":[[190,57],[190,57]],"oldText":"u","newText":""}},{"type":"change","content":{"oldRange":[[190,56],[190,57]],"newRange":[[190,56],[190,56]],"oldText":"i","newText":""}},{"type":"change","content":{"oldRange":[[190,56],[190,56]],"newRange":[[190,56],[190,57]],"oldText":"","newText":"p"}},{"type":"change","content":{"oldRange":[[190,56],[190,57]],"newRange":[[190,56],[190,56]],"oldText":"p","newText":""}},{"type":"change","content":{"oldRange":[[190,56],[190,56]],"newRange":[[190,56],[190,57]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[190,53],[190,57]],"newRange":[[190,53],[190,68]],"oldText":"reso","newText":"resourceClasses"}},{"type":"change","content":{"oldRange":[[190,68],[190,68]],"newRange":[[190,68],[190,69]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[190,68],[190,69]],"newRange":[[190,68],[190,68]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[190,69],[190,69]],"newRange":[[190,69],[190,70]],"oldText":"","newText":","}},{"type":"change","content":{"oldRange":[[190,70],[190,70]],"newRange":[[190,70],[190,71]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[190,71],[190,71]],"newRange":[[190,71],[190,72]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[190,72],[190,72]],"newRange":[[190,72],[190,73]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[190,73],[190,73]],"newRange":[[190,73],[190,74]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[190,71],[190,74]],"newRange":[[190,71],[190,86]],"oldText":"res","newText":"resourceClasses"}},{"type":"change","content":{"oldRange":[[190,87],[190,87]],"newRange":[[190,87],[190,88]],"oldText":"","newText":";"}},{"type":"change","content":{"oldRange":[[349,38],[349,38]],"newRange":[[349,38],[350,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[350,0],[350,0]],"newRange":[[350,0],[350,4]],"oldText":"","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[350,4],[350,4]],"newRange":[[350,4],[350,5]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[350,5],[350,5]],"newRange":[[350,5],[350,6]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[350,6],[350,6]],"newRange":[[350,6],[350,7]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[350,7],[350,7]],"newRange":[[350,7],[350,8]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[350,8],[350,8]],"newRange":[[350,8],[350,9]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[350,9],[350,9]],"newRange":[[350,9],[350,10]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[350,10],[350,10]],"newRange":[[350,10],[350,11]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[350,11],[350,11]],"newRange":[[350,11],[350,12]],"oldText":"","newText":"."}},{"type":"change","content":{"oldRange":[[350,12],[350,12]],"newRange":[[350,12],[350,13]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[350,13],[350,13]],"newRange":[[350,13],[350,14]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[350,14],[350,14]],"newRange":[[350,14],[350,15]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[350,15],[350,15]],"newRange":[[350,15],[350,17]],"oldText":"","newText":"()"}},{"type":"change","content":{"oldRange":[[350,16],[350,16]],"newRange":[[350,16],[350,18]],"oldText":"","newText":"''"}},{"type":"change","content":{"oldRange":[[350,17],[350,17]],"newRange":[[350,17],[350,18]],"oldText":"","newText":"\\"}},{"type":"change","content":{"oldRange":[[350,18],[350,18]],"newRange":[[350,18],[350,19]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[350,19],[350,19]],"newRange":[[350,19],[350,20]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[350,20],[350,20]],"newRange":[[350,20],[350,21]],"oldText":"","newText":"R"}},{"type":"change","content":{"oldRange":[[350,21],[350,21]],"newRange":[[350,21],[350,22]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[350,21],[350,22]],"newRange":[[350,21],[350,21]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[350,20],[350,21]],"newRange":[[350,20],[350,20]],"oldText":"R","newText":""}},{"type":"change","content":{"oldRange":[[350,19],[350,20]],"newRange":[[350,19],[350,19]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[350,19],[350,19]],"newRange":[[350,19],[350,20]],"oldText":"","newText":"R"}},{"type":"change","content":{"oldRange":[[350,20],[350,20]],"newRange":[[350,20],[350,21]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[350,21],[350,21]],"newRange":[[350,21],[350,22]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[350,22],[350,22]],"newRange":[[350,22],[350,23]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[350,23],[350,23]],"newRange":[[350,23],[350,24]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[350,24],[350,24]],"newRange":[[350,24],[350,25]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[350,25],[350,25]],"newRange":[[350,25],[350,26]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[350,26],[350,26]],"newRange":[[350,26],[350,27]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[350,27],[350,27]],"newRange":[[350,27],[350,28]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[350,28],[350,28]],"newRange":[[350,28],[350,29]],"oldText":"","newText":"."}},{"type":"change","content":{"oldRange":[[350,28],[350,29]],"newRange":[[350,28],[350,28]],"oldText":".","newText":""}},{"type":"change","content":{"oldRange":[[350,27],[350,28]],"newRange":[[350,27],[350,27]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[350,27],[350,27]],"newRange":[[350,27],[350,28]],"oldText":"","newText":";"}},{"type":"change","content":{"oldRange":[[350,28],[350,28]],"newRange":[[350,28],[350,29]],"oldText":"","newText":";"}},{"type":"change","content":{"oldRange":[[350,28],[350,29]],"newRange":[[350,28],[350,28]],"oldText":";","newText":""}},{"type":"change","content":{"oldRange":[[350,27],[350,28]],"newRange":[[350,27],[350,27]],"oldText":";","newText":""}},{"type":"change","content":{"oldRange":[[350,27],[350,27]],"newRange":[[350,27],[350,28]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[350,28],[350,28]],"newRange":[[350,28],[350,29]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[350,29],[350,29]],"newRange":[[350,29],[350,30]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[350,29],[350,30]],"newRange":[[350,29],[350,29]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[350,29],[350,29]],"newRange":[[350,29],[350,30]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[350,30],[350,30]],"newRange":[[350,30],[350,31]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[350,31],[350,31]],"newRange":[[350,31],[350,32]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[350,32],[350,32]],"newRange":[[350,32],[350,33]],"oldText":"","newText":"A"}},{"type":"change","content":{"oldRange":[[350,29],[350,33]],"newRange":[[350,29],[350,50]],"oldText":"getA","newText":"getAvailableIntervals"}},{"type":"change","content":{"oldRange":[[350,50],[350,50]],"newRange":[[350,50],[350,51]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[350,51],[350,51]],"newRange":[[350,51],[350,52]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[350,51],[350,52]],"newRange":[[350,51],[350,51]],"oldText":"-","newText":""}},{"type":"change","content":{"oldRange":[[350,50],[350,51]],"newRange":[[350,50],[350,50]],"oldText":"-","newText":""}},{"type":"change","content":{"oldRange":[[350,50],[350,50]],"newRange":[[350,50],[350,51]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[350,51],[350,51]],"newRange":[[350,51],[350,52]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[350,52],[350,52]],"newRange":[[350,52],[350,53]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[350,53],[350,53]],"newRange":[[350,53],[350,54]],"oldText":"","newText":">"}},{"type":"change","content":{"oldRange":[[350,54],[350,54]],"newRange":[[350,54],[350,55]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[350,55],[350,55]],"newRange":[[350,55],[350,56]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[350,56],[350,56]],"newRange":[[350,56],[350,57]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[350,56],[350,57]],"newRange":[[350,56],[350,56]],"oldText":"a","newText":""}},{"type":"change","content":{"oldRange":[[350,55],[350,56]],"newRange":[[350,55],[350,55]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[350,54],[350,55]],"newRange":[[350,54],[350,54]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[350,53],[350,54]],"newRange":[[350,53],[350,53]],"oldText":">","newText":""}},{"type":"change","content":{"oldRange":[[350,52],[350,53]],"newRange":[[350,52],[350,52]],"oldText":"-","newText":""}},{"type":"change","content":{"oldRange":[[350,51],[350,52]],"newRange":[[350,51],[350,51]],"oldText":"-","newText":""}},{"type":"change","content":{"oldRange":[[350,51],[350,51]],"newRange":[[350,51],[350,52]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[350,52],[350,52]],"newRange":[[350,52],[350,53]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[350,53],[350,53]],"newRange":[[350,53],[350,54]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[350,54],[350,54]],"newRange":[[350,54],[350,55]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[350,57],[350,57]],"newRange":[[350,57],[350,58]],"oldText":"","newText":";"}},{"type":"change","content":{"oldRange":[[250,60],[250,60]],"newRange":[[250,60],[251,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[251,0],[251,0]],"newRange":[[251,0],[251,3]],"oldText":"","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[251,3],[251,3]],"newRange":[[251,3],[251,4]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[251,3],[251,4]],"newRange":[[251,3],[251,3]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[251,3],[251,3]],"newRange":[[251,3],[251,4]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[251,4],[251,4]],"newRange":[[251,4],[251,5]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[251,5],[251,5]],"newRange":[[251,5],[251,6]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[251,6],[251,6]],"newRange":[[251,6],[251,7]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[251,7],[251,7]],"newRange":[[251,7],[251,8]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[251,8],[251,8]],"newRange":[[251,8],[251,9]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[251,9],[251,9]],"newRange":[[251,9],[251,10]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[251,10],[251,10]],"newRange":[[251,10],[251,11]],"oldText":"","newText":"."}},{"type":"change","content":{"oldRange":[[251,11],[251,11]],"newRange":[[251,11],[251,12]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[251,12],[251,12]],"newRange":[[251,12],[251,13]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[251,13],[251,13]],"newRange":[[251,13],[251,14]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[251,14],[251,14]],"newRange":[[251,14],[251,16]],"oldText":"","newText":"()"}},{"type":"change","content":{"oldRange":[[251,15],[251,15]],"newRange":[[251,15],[251,17]],"oldText":"","newText":"''"}},{"type":"change","content":{"oldRange":[[251,16],[251,16]],"newRange":[[251,16],[251,17]],"oldText":"","newText":"\\"}},{"type":"change","content":{"oldRange":[[251,17],[251,17]],"newRange":[[251,17],[251,18]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[251,18],[251,18]],"newRange":[[251,18],[251,19]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[251,19],[251,19]],"newRange":[[251,19],[251,20]],"oldText":"","newText":"R"}},{"type":"change","content":{"oldRange":[[251,19],[251,20]],"newRange":[[251,19],[251,19]],"oldText":"R","newText":""}},{"type":"change","content":{"oldRange":[[251,18],[251,19]],"newRange":[[251,18],[251,18]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[251,18],[251,18]],"newRange":[[251,18],[251,19]],"oldText":"","newText":"R"}},{"type":"change","content":{"oldRange":[[251,19],[251,19]],"newRange":[[251,19],[251,20]],"oldText":"","newText":"E"}},{"type":"change","content":{"oldRange":[[251,19],[251,20]],"newRange":[[251,19],[251,19]],"oldText":"E","newText":""}},{"type":"change","content":{"oldRange":[[251,19],[251,19]],"newRange":[[251,19],[251,20]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[251,20],[251,20]],"newRange":[[251,20],[251,21]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[251,21],[251,21]],"newRange":[[251,21],[251,22]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[251,22],[251,22]],"newRange":[[251,22],[251,23]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[251,23],[251,23]],"newRange":[[251,23],[251,24]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[251,24],[251,24]],"newRange":[[251,24],[251,25]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[251,25],[251,25]],"newRange":[[251,25],[251,26]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[251,26],[251,26]],"newRange":[[251,26],[251,27]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[251,27],[251,27]],"newRange":[[251,27],[251,28]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[251,28],[251,28]],"newRange":[[251,28],[251,29]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[251,29],[251,29]],"newRange":[[251,29],[251,30]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[251,30],[251,30]],"newRange":[[251,30],[251,31]],"oldText":"","newText":"v"}},{"type":"change","content":{"oldRange":[[251,31],[251,31]],"newRange":[[251,31],[251,32]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[251,31],[251,32]],"newRange":[[251,31],[251,31]],"oldText":"a","newText":""}},{"type":"change","content":{"oldRange":[[251,30],[251,31]],"newRange":[[251,30],[251,30]],"oldText":"v","newText":""}},{"type":"change","content":{"oldRange":[[251,29],[251,30]],"newRange":[[251,29],[251,29]],"oldText":"a","newText":""}},{"type":"change","content":{"oldRange":[[251,29],[251,29]],"newRange":[[251,29],[251,30]],"oldText":"","newText":"g"}},{"type":"change","content":{"oldRange":[[251,30],[251,30]],"newRange":[[251,30],[251,31]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[251,31],[251,31]],"newRange":[[251,31],[251,32]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[251,32],[251,32]],"newRange":[[251,32],[251,33]],"oldText":"","newText":"A"}},{"type":"change","content":{"oldRange":[[251,29],[251,33]],"newRange":[[251,29],[251,50]],"oldText":"getA","newText":"getAvailableIntervals"}},{"type":"change","content":{"oldRange":[[251,50],[251,50]],"newRange":[[251,50],[251,51]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[251,51],[251,51]],"newRange":[[251,51],[251,52]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[251,52],[251,52]],"newRange":[[251,52],[251,53]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[251,53],[251,53]],"newRange":[[251,53],[251,54]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[251,54],[251,54]],"newRange":[[251,54],[251,55]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[251,55],[251,55]],"newRange":[[251,55],[251,56]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[251,52],[251,56]],"newRange":[[251,52],[251,65]],"oldText":"calc","newText":"calcIntervals"}},{"type":"change","content":{"oldRange":[[251,65],[251,65]],"newRange":[[251,65],[251,66]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[251,66],[251,66]],"newRange":[[251,66],[251,67]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[251,67],[251,67]],"newRange":[[251,67],[251,68]],"oldText":"","newText":"-"}},{"type":"change","content":{"oldRange":[[251,68],[251,68]],"newRange":[[251,68],[251,69]],"oldText":"","newText":">"}},{"type":"change","content":{"oldRange":[[251,69],[251,69]],"newRange":[[251,69],[251,70]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[251,70],[251,70]],"newRange":[[251,70],[251,71]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[251,71],[251,71]],"newRange":[[251,71],[251,72]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[251,72],[251,72]],"newRange":[[251,72],[251,73]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[251,73],[251,73]],"newRange":[[251,73],[251,74]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[251,74],[251,74]],"newRange":[[251,74],[251,75]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[251,75],[251,75]],"newRange":[[251,75],[251,76]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[251,76],[251,76]],"newRange":[[251,76],[251,77]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[251,77],[251,77]],"newRange":[[251,77],[251,78]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[251,78],[251,78]],"newRange":[[251,78],[251,79]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[251,80],[251,80]],"newRange":[[251,80],[251,81]],"oldText":"","newText":"."}},{"type":"change","content":{"oldRange":[[251,80],[251,81]],"newRange":[[251,80],[251,80]],"oldText":".","newText":""}},{"type":"change","content":{"oldRange":[[251,80],[251,80]],"newRange":[[251,80],[251,81]],"oldText":"","newText":","}},{"type":"change","content":{"oldRange":[[251,81],[251,81]],"newRange":[[251,81],[251,82]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[251,82],[251,82]],"newRange":[[251,82],[251,83]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[251,83],[251,83]],"newRange":[[251,83],[251,84]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[251,84],[251,84]],"newRange":[[251,84],[251,85]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[251,85],[251,85]],"newRange":[[251,85],[251,86]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[251,86],[251,86]],"newRange":[[251,86],[251,87]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[251,87],[251,87]],"newRange":[[251,87],[251,88]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[251,88],[251,88]],"newRange":[[251,88],[251,89]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[251,89],[251,89]],"newRange":[[251,89],[251,90]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[251,90],[251,90]],"newRange":[[251,90],[251,91]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[251,92],[251,92]],"newRange":[[251,92],[251,93]],"oldText":"","newText":";"}},{"type":"change","content":{"oldRange":[[252,0],[252,0]],"newRange":[[252,0],[253,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[253,0],[253,0]],"newRange":[[253,0],[254,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[252,70],[252,79]],"newRange":[[252,70],[252,71]],"oldText":"resources","newText":"w"}},{"type":"change","content":{"oldRange":[[252,74],[252,83]],"newRange":[[252,74],[252,75]],"oldText":"resources","newText":"w"}},{"type":"change","content":{"oldRange":[[253,70],[253,79]],"newRange":[[253,70],[253,71]],"oldText":"resources","newText":"w"}},{"type":"change","content":{"oldRange":[[253,74],[253,83]],"newRange":[[253,74],[253,75]],"oldText":"resources","newText":"w"}},{"type":"change","content":{"oldRange":[[252,71],[252,71]],"newRange":[[252,71],[252,72]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[252,76],[252,76]],"newRange":[[252,76],[252,77]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[253,71],[253,71]],"newRange":[[253,71],[253,72]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[253,76],[253,76]],"newRange":[[253,76],[253,77]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[252,72],[252,72]],"newRange":[[252,72],[252,73]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[252,78],[252,78]],"newRange":[[252,78],[252,79]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[253,72],[253,72]],"newRange":[[253,72],[253,73]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[253,78],[253,78]],"newRange":[[253,78],[253,79]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[252,73],[252,73]],"newRange":[[252,73],[252,74]],"oldText":"","newText":"k"}},{"type":"change","content":{"oldRange":[[252,80],[252,80]],"newRange":[[252,80],[252,81]],"oldText":"","newText":"k"}},{"type":"change","content":{"oldRange":[[253,73],[253,73]],"newRange":[[253,73],[253,74]],"oldText":"","newText":"k"}},{"type":"change","content":{"oldRange":[[253,80],[253,80]],"newRange":[[253,80],[253,81]],"oldText":"","newText":"k"}},{"type":"change","content":{"oldRange":[[252,74],[252,74]],"newRange":[[252,74],[252,75]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[252,82],[252,82]],"newRange":[[252,82],[252,83]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[253,74],[253,74]],"newRange":[[253,74],[253,75]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[253,82],[253,82]],"newRange":[[253,82],[253,83]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[253,75],[253,75]],"newRange":[[253,75],[253,76]],"oldText":"","newText":"B"}},{"type":"change","content":{"oldRange":[[253,84],[253,84]],"newRange":[[253,84],[253,85]],"oldText":"","newText":"B"}},{"type":"change","content":{"oldRange":[[253,76],[253,76]],"newRange":[[253,76],[253,77]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[253,86],[253,86]],"newRange":[[253,86],[253,87]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[253,77],[253,77]],"newRange":[[253,77],[253,78]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[253,88],[253,88]],"newRange":[[253,88],[253,89]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[253,78],[253,78]],"newRange":[[253,78],[253,79]],"oldText":"","newText":"y"}},{"type":"change","content":{"oldRange":[[253,90],[253,90]],"newRange":[[253,90],[253,91]],"oldText":"","newText":"y"}},{"type":"change","content":{"oldRange":[[267,6],[267,6]],"newRange":[[267,6],[268,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[268,0],[268,0]],"newRange":[[268,0],[268,3]],"oldText":"","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[268,3],[268,3]],"newRange":[[268,3],[268,4]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[268,3],[268,4]],"newRange":[[268,3],[268,3]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[268,2],[268,3]],"newRange":[[268,2],[268,2]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[268,1],[268,2]],"newRange":[[268,1],[268,1]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[268,0],[268,1]],"newRange":[[268,0],[268,0]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[267,6],[268,0]],"newRange":[[267,6],[267,6]],"oldText":"\n","newText":""}},{"type":"change","content":{"oldRange":[[252,0],[252,0]],"newRange":[[252,0],[253,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[252,0],[253,0]],"newRange":[[252,0],[252,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[253,0],[253,0]],"newRange":[[253,0],[254,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[253,0],[253,3]],"newRange":[[253,0],[253,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[253,0],[254,0]],"newRange":[[253,0],[253,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[254,0],[254,0]],"newRange":[[254,0],[255,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[254,0],[254,3]],"newRange":[[254,0],[254,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[254,0],[255,0]],"newRange":[[254,0],[254,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[255,0],[255,0]],"newRange":[[255,0],[256,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[255,0],[255,3]],"newRange":[[255,0],[255,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[255,0],[256,0]],"newRange":[[255,0],[255,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[256,0],[256,0]],"newRange":[[256,0],[257,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[256,0],[256,3]],"newRange":[[256,0],[256,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[256,0],[257,0]],"newRange":[[256,0],[256,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[257,0],[257,0]],"newRange":[[257,0],[258,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[257,0],[257,3]],"newRange":[[257,0],[257,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[257,0],[258,0]],"newRange":[[257,0],[257,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[258,0],[258,0]],"newRange":[[258,0],[259,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[258,0],[258,3]],"newRange":[[258,0],[258,4]],"oldText":"\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[258,0],[259,0]],"newRange":[[258,0],[258,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[259,0],[259,0]],"newRange":[[259,0],[260,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[259,0],[259,4]],"newRange":[[259,0],[259,4]],"oldText":"\t\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[259,0],[260,0]],"newRange":[[259,0],[259,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[260,0],[260,0]],"newRange":[[260,0],[261,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[260,0],[260,4]],"newRange":[[260,0],[260,3]],"oldText":"\t\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[260,0],[261,0]],"newRange":[[260,0],[260,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[261,0],[261,0]],"newRange":[[261,0],[262,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[261,0],[261,3]],"newRange":[[261,0],[261,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[261,0],[262,0]],"newRange":[[261,0],[261,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[262,0],[262,0]],"newRange":[[262,0],[263,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[262,0],[262,3]],"newRange":[[262,0],[262,4]],"oldText":"\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[262,0],[263,0]],"newRange":[[262,0],[262,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[263,0],[263,0]],"newRange":[[263,0],[264,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[263,0],[263,4]],"newRange":[[263,0],[263,4]],"oldText":"\t\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[263,0],[264,0]],"newRange":[[263,0],[263,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[264,0],[264,0]],"newRange":[[264,0],[265,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[264,0],[264,4]],"newRange":[[264,0],[264,5]],"oldText":"\t\t\t\t","newText":"\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[264,0],[265,0]],"newRange":[[264,0],[264,0]],"oldText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[265,0],[265,0]],"newRange":[[265,0],[266,0]],"oldText":"","newText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[265,0],[265,5]],"newRange":[[265,0],[265,5]],"oldText":"\t\t\t\t\t","newText":"\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[265,0],[266,0]],"newRange":[[265,0],[265,0]],"oldText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[266,0],[266,0]],"newRange":[[266,0],[267,0]],"oldText":"","newText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[266,0],[266,5]],"newRange":[[266,0],[266,6]],"oldText":"\t\t\t\t\t","newText":"\t\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[266,0],[267,0]],"newRange":[[266,0],[266,0]],"oldText":"\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[267,0],[267,0]],"newRange":[[267,0],[268,0]],"oldText":"","newText":"\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[267,0],[267,6]],"newRange":[[267,0],[267,4]],"oldText":"\t\t\t\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[267,0],[268,0]],"newRange":[[267,0],[267,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"change","content":{"oldRange":[[268,0],[268,0]],"newRange":[[268,0],[269,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n"}},{"type":"change","content":{"oldRange":[[268,0],[268,4]],"newRange":[[268,0],[268,3]],"oldText":"\t\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[268,70],[268,79]],"newRange":[[268,70],[268,71]],"oldText":"resources","newText":"r"}},{"type":"change","content":{"oldRange":[[268,71],[268,71]],"newRange":[[268,71],[268,72]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[268,72],[268,72]],"newRange":[[268,72],[268,73]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[268,73],[268,73]],"newRange":[[268,73],[268,74]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[268,74],[268,74]],"newRange":[[268,74],[268,75]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[268,75],[268,75]],"newRange":[[268,75],[268,76]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[268,76],[268,76]],"newRange":[[268,76],[268,77]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[268,77],[268,77]],"newRange":[[268,77],[268,78]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[268,78],[268,78]],"newRange":[[268,78],[268,79]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[268,79],[268,79]],"newRange":[[268,79],[268,80]],"oldText":"","newText":"B"}},{"type":"change","content":{"oldRange":[[268,70],[268,80]],"newRange":[[268,70],[268,86]],"oldText":"resourcesB","newText":"resourcesByClass"}},{"type":"change","content":{"oldRange":[[268,98],[268,98]],"newRange":[[268,98],[268,99]],"oldText":"","newText":"B"}},{"type":"change","content":{"oldRange":[[268,89],[268,99]],"newRange":[[268,89],[268,105]],"oldText":"resourcesB","newText":"resourcesByClass"}},{"type":"change","content":{"oldRange":[[269,0],[269,0]],"newRange":[[269,0],[270,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[269,0],[270,0]],"newRange":[[269,0],[269,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[270,0],[270,0]],"newRange":[[270,0],[271,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[270,0],[270,3]],"newRange":[[270,0],[270,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[270,0],[271,0]],"newRange":[[270,0],[270,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[271,0],[271,0]],"newRange":[[271,0],[272,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[271,0],[271,3]],"newRange":[[271,0],[271,4]],"oldText":"\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[271,0],[272,0]],"newRange":[[271,0],[271,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[272,0],[272,0]],"newRange":[[272,0],[273,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[272,0],[272,4]],"newRange":[[272,0],[272,5]],"oldText":"\t\t\t\t","newText":"\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[272,0],[273,0]],"newRange":[[272,0],[272,0]],"oldText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[273,0],[273,0]],"newRange":[[273,0],[274,0]],"oldText":"","newText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[273,0],[273,5]],"newRange":[[273,0],[273,5]],"oldText":"\t\t\t\t\t","newText":"\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[273,0],[274,0]],"newRange":[[273,0],[273,0]],"oldText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[274,0],[274,0]],"newRange":[[274,0],[275,0]],"oldText":"","newText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[274,0],[274,5]],"newRange":[[274,0],[274,6]],"oldText":"\t\t\t\t\t","newText":"\t\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[274,0],[275,0]],"newRange":[[274,0],[274,0]],"oldText":"\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[275,0],[275,0]],"newRange":[[275,0],[276,0]],"oldText":"","newText":"\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[275,0],[275,6]],"newRange":[[275,0],[275,6]],"oldText":"\t\t\t\t\t\t","newText":"\t\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[275,0],[276,0]],"newRange":[[275,0],[275,0]],"oldText":"\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[276,0],[276,0]],"newRange":[[276,0],[277,0]],"oldText":"","newText":"\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[276,0],[276,6]],"newRange":[[276,0],[276,6]],"oldText":"\t\t\t\t\t\t","newText":"\t\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[276,0],[277,0]],"newRange":[[276,0],[276,0]],"oldText":"\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[277,0],[277,0]],"newRange":[[277,0],[278,0]],"oldText":"","newText":"\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[277,0],[277,6]],"newRange":[[277,0],[277,7]],"oldText":"\t\t\t\t\t\t","newText":"\t\t\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[277,0],[278,0]],"newRange":[[277,0],[277,0]],"oldText":"\t\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[278,0],[278,0]],"newRange":[[278,0],[279,0]],"oldText":"","newText":"\t\t\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[278,0],[278,7]],"newRange":[[278,0],[278,5]],"oldText":"\t\t\t\t\t\t\t","newText":"\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[278,0],[279,0]],"newRange":[[278,0],[278,0]],"oldText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[279,0],[279,0]],"newRange":[[279,0],[280,0]],"oldText":"","newText":"\t\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[279,0],[279,5]],"newRange":[[279,0],[279,4]],"oldText":"\t\t\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[279,0],[280,0]],"newRange":[[279,0],[279,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[280,0],[280,0]],"newRange":[[280,0],[281,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[280,0],[280,4]],"newRange":[[280,0],[280,3]],"oldText":"\t\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[280,0],[281,0]],"newRange":[[280,0],[280,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[281,0],[281,0]],"newRange":[[281,0],[282,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[281,0],[281,3]],"newRange":[[281,0],[281,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[281,0],[282,0]],"newRange":[[281,0],[281,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[282,0],[282,0]],"newRange":[[282,0],[283,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[282,0],[282,3]],"newRange":[[282,0],[282,4]],"oldText":"\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[282,0],[283,0]],"newRange":[[282,0],[282,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[283,0],[283,0]],"newRange":[[283,0],[284,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[283,0],[283,4]],"newRange":[[283,0],[283,4]],"oldText":"\t\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[283,0],[284,0]],"newRange":[[283,0],[283,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[284,0],[284,0]],"newRange":[[284,0],[285,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[284,0],[284,4]],"newRange":[[284,0],[284,3]],"oldText":"\t\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[284,0],[285,0]],"newRange":[[284,0],[284,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[285,0],[285,0]],"newRange":[[285,0],[286,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[285,0],[285,3]],"newRange":[[285,0],[285,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[285,0],[286,0]],"newRange":[[285,0],[285,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[286,0],[286,0]],"newRange":[[286,0],[287,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[286,0],[286,3]],"newRange":[[286,0],[286,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[286,0],[287,0]],"newRange":[[286,0],[286,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[287,0],[287,0]],"newRange":[[287,0],[288,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[287,0],[287,3]],"newRange":[[287,0],[287,4]],"oldText":"\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[287,0],[288,0]],"newRange":[[287,0],[287,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[288,0],[288,0]],"newRange":[[288,0],[289,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[288,0],[288,4]],"newRange":[[288,0],[288,4]],"oldText":"\t\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[288,0],[289,0]],"newRange":[[288,0],[288,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[289,0],[289,0]],"newRange":[[289,0],[290,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[289,0],[289,4]],"newRange":[[289,0],[289,3]],"oldText":"\t\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[289,0],[290,0]],"newRange":[[289,0],[289,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[290,0],[290,0]],"newRange":[[290,0],[291,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[290,0],[290,3]],"newRange":[[290,0],[290,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[290,0],[291,0]],"newRange":[[290,0],[290,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"change","content":{"oldRange":[[289,0],[289,0]],"newRange":[[289,0],[290,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n"}},{"type":"change","content":{"oldRange":[[289,0],[289,3]],"newRange":[[289,0],[289,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[289,70],[289,86]],"newRange":[[289,70],[289,71]],"oldText":"resourcesByClass","newText":"i"}},{"type":"change","content":{"oldRange":[[289,74],[289,90]],"newRange":[[289,74],[289,75]],"oldText":"resourcesByClass","newText":"i"}},{"type":"change","content":{"oldRange":[[289,71],[289,71]],"newRange":[[289,71],[289,72]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[289,76],[289,76]],"newRange":[[289,76],[289,77]],"oldText":"","newText":"n"}},{"type":"change","content":{"oldRange":[[289,72],[289,72]],"newRange":[[289,72],[289,73]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[289,78],[289,78]],"newRange":[[289,78],[289,79]],"oldText":"","newText":"t"}},{"type":"change","content":{"oldRange":[[289,73],[289,73]],"newRange":[[289,73],[289,74]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[289,80],[289,80]],"newRange":[[289,80],[289,81]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[289,74],[289,74]],"newRange":[[289,74],[289,75]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[289,82],[289,82]],"newRange":[[289,82],[289,83]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[289,75],[289,75]],"newRange":[[289,75],[289,76]],"oldText":"","newText":"v"}},{"type":"change","content":{"oldRange":[[289,84],[289,84]],"newRange":[[289,84],[289,85]],"oldText":"","newText":"v"}},{"type":"change","content":{"oldRange":[[289,76],[289,76]],"newRange":[[289,76],[289,77]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[289,86],[289,86]],"newRange":[[289,86],[289,87]],"oldText":"","newText":"a"}},{"type":"change","content":{"oldRange":[[289,77],[289,77]],"newRange":[[289,77],[289,78]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[289,88],[289,88]],"newRange":[[289,88],[289,89]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[289,78],[289,78]],"newRange":[[289,78],[289,79]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[289,90],[289,90]],"newRange":[[289,90],[289,91]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[289,79],[289,79]],"newRange":[[289,79],[289,80]],"oldText":"","newText":"B"}},{"type":"change","content":{"oldRange":[[289,92],[289,92]],"newRange":[[289,92],[289,93]],"oldText":"","newText":"B"}},{"type":"change","content":{"oldRange":[[289,70],[289,80]],"newRange":[[289,70],[289,89]],"oldText":"intervalsB","newText":"intervalsByResource"}},{"type":"change","content":{"oldRange":[[289,92],[289,102]],"newRange":[[289,92],[289,111]],"oldText":"intervalsB","newText":"intervalsByResource"}},{"type":"change","content":{"oldRange":[[289,89],[289,89]],"newRange":[[289,89],[289,90]],"oldText":"","newText":"p"}},{"type":"change","content":{"oldRange":[[289,112],[289,112]],"newRange":[[289,112],[289,113]],"oldText":"","newText":"p"}},{"type":"change","content":{"oldRange":[[289,90],[289,90]],"newRange":[[289,90],[289,91]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[289,114],[289,114]],"newRange":[[289,114],[289,115]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[289,91],[289,91]],"newRange":[[289,91],[289,92]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[289,116],[289,116]],"newRange":[[289,116],[289,117]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[289,91],[289,92]],"newRange":[[289,91],[289,91]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[289,115],[289,116]],"newRange":[[289,115],[289,115]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[289,90],[289,91]],"newRange":[[289,90],[289,90]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[289,113],[289,114]],"newRange":[[289,113],[289,113]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[289,89],[289,90]],"newRange":[[289,89],[289,89]],"oldText":"p","newText":""}},{"type":"change","content":{"oldRange":[[289,111],[289,112]],"newRange":[[289,111],[289,111]],"oldText":"p","newText":""}},{"type":"change","content":{"oldRange":[[286,40],[286,40]],"newRange":[[286,40],[287,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[287,0],[287,0]],"newRange":[[287,0],[287,4]],"oldText":"","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[291,0],[291,0]],"newRange":[[291,0],[292,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n"}},{"type":"change","content":{"oldRange":[[291,0],[292,0]],"newRange":[[291,0],[291,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n","newText":""}},{"type":"change","content":{"oldRange":[[290,0],[290,0]],"newRange":[[290,0],[291,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n"}},{"type":"change","content":{"oldRange":[[290,0],[290,3]],"newRange":[[290,0],[290,3]],"oldText":"\t\t\t","newText":"\t\t\t"}},{"type":"change","content":{"oldRange":[[290,0],[291,0]],"newRange":[[290,0],[290,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n","newText":""}},{"type":"change","content":{"oldRange":[[289,0],[289,0]],"newRange":[[289,0],[290,0]],"oldText":"","newText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n"}},{"type":"change","content":{"oldRange":[[289,0],[289,3]],"newRange":[[289,0],[289,4]],"oldText":"\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[289,0],[290,0]],"newRange":[[289,0],[289,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n","newText":""}},{"type":"change","content":{"oldRange":[[288,0],[288,0]],"newRange":[[288,0],[289,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n"}},{"type":"change","content":{"oldRange":[[288,0],[288,4]],"newRange":[[288,0],[288,4]],"oldText":"\t\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[288,0],[289,0]],"newRange":[[288,0],[288,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n","newText":""}},{"type":"change","content":{"oldRange":[[287,0],[287,0]],"newRange":[[287,0],[288,0]],"oldText":"","newText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n"}},{"type":"change","content":{"oldRange":[[287,0],[287,4]],"newRange":[[287,0],[287,4]],"oldText":"\t\t\t\t","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[287,66],[287,66]],"newRange":[[287,66],[287,67]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[287,67],[287,67]],"newRange":[[287,67],[287,68]],"oldText":"","newText":":"}},{"type":"change","content":{"oldRange":[[287,68],[287,68]],"newRange":[[287,68],[287,69]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[287,69],[287,69]],"newRange":[[287,69],[287,70]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[287,69],[287,70]],"newRange":[[287,69],[287,69]],"oldText":"l","newText":""}},{"type":"change","content":{"oldRange":[[287,68],[287,69]],"newRange":[[287,68],[287,68]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[287,68],[287,68]],"newRange":[[287,68],[287,69]],"oldText":"","newText":"l"}},{"type":"change","content":{"oldRange":[[287,69],[287,69]],"newRange":[[287,69],[287,70]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[287,70],[287,70]],"newRange":[[287,70],[287,71]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[287,71],[287,71]],"newRange":[[287,71],[287,72]],"oldText":"","newText":"p"}},{"type":"change","content":{"oldRange":[[287,99],[287,118]],"newRange":[[287,99],[287,100]],"oldText":"intervalsByResource","newText":"r"}},{"type":"change","content":{"oldRange":[[287,100],[287,100]],"newRange":[[287,100],[287,101]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[287,101],[287,101]],"newRange":[[287,101],[287,102]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[287,102],[287,102]],"newRange":[[287,102],[287,103]],"oldText":"","newText":"p"}},{"type":"change","content":{"oldRange":[[287,103],[287,103]],"newRange":[[287,103],[287,104]],"oldText":"","newText":"i"}},{"type":"change","content":{"oldRange":[[287,103],[287,104]],"newRange":[[287,103],[287,103]],"oldText":"i","newText":""}},{"type":"change","content":{"oldRange":[[287,102],[287,103]],"newRange":[[287,102],[287,102]],"oldText":"p","newText":""}},{"type":"change","content":{"oldRange":[[287,102],[287,102]],"newRange":[[287,102],[287,103]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[287,103],[287,103]],"newRange":[[287,103],[287,104]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[287,99],[287,104]],"newRange":[[287,99],[287,107]],"oldText":"resou","newText":"resource"}},{"type":"change","content":{"oldRange":[[288,0],[288,4]],"newRange":[[288,0],[288,0]],"oldText":"\t\t\t\t","newText":""}},{"type":"change","content":{"oldRange":[[287,77],[287,96]],"newRange":[[287,77],[287,78]],"oldText":"intervalsByResource","newText":"r"}},{"type":"change","content":{"oldRange":[[287,78],[287,78]],"newRange":[[287,78],[287,79]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[287,79],[287,79]],"newRange":[[287,79],[287,80]],"oldText":"","newText":"s"}},{"type":"change","content":{"oldRange":[[287,80],[287,80]],"newRange":[[287,80],[287,81]],"oldText":"","newText":"o"}},{"type":"change","content":{"oldRange":[[287,81],[287,81]],"newRange":[[287,81],[287,82]],"oldText":"","newText":"u"}},{"type":"change","content":{"oldRange":[[287,82],[287,82]],"newRange":[[287,82],[287,83]],"oldText":"","newText":"r"}},{"type":"change","content":{"oldRange":[[287,83],[287,83]],"newRange":[[287,83],[287,84]],"oldText":"","newText":"c"}},{"type":"change","content":{"oldRange":[[287,84],[287,84]],"newRange":[[287,84],[287,85]],"oldText":"","newText":"e"}},{"type":"change","content":{"oldRange":[[299,4],[299,9]],"newRange":[[299,4],[299,5]],"oldText":"while","newText":"o"}},{"type":"change","content":{"oldRange":[[299,5],[299,5]],"newRange":[[299,5],[299,6]],"oldText":"","newText":"f"}},{"type":"change","content":{"oldRange":[[299,6],[299,6]],"newRange":[[299,6],[299,7]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[299,6],[299,7]],"newRange":[[299,6],[299,6]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,5],[299,6]],"newRange":[[299,5],[299,5]],"oldText":"f","newText":""}},{"type":"change","content":{"oldRange":[[299,4],[299,5]],"newRange":[[299,4],[299,4]],"oldText":"o","newText":""}},{"type":"change","content":{"oldRange":[[299,4],[299,4]],"newRange":[[299,4],[299,5]],"oldText":"","newText":"i"}},{"type":"change","content":{"oldRange":[[299,5],[299,5]],"newRange":[[299,5],[299,6]],"oldText":"","newText":"f"}},{"type":"change","content":{"oldRange":[[299,6],[299,6]],"newRange":[[299,6],[299,7]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[299,6],[299,7]],"newRange":[[299,6],[299,6]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,101],[299,101]],"newRange":[[299,101],[299,102]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[299,102],[299,102]],"newRange":[[299,102],[299,103]],"oldText":"","newText":"|"}},{"type":"change","content":{"oldRange":[[299,103],[299,103]],"newRange":[[299,103],[299,104]],"oldText":"","newText":"|"}},{"type":"change","content":{"oldRange":[[299,104],[299,104]],"newRange":[[299,104],[299,105]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":")","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"{","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[300,0]],"newRange":[[299,105],[299,105]],"oldText":"\n","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"o","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"u","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"C","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"l","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"a","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"I","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"n","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"d","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"x","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"+","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"=","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"1","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":";","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[300,0]],"newRange":[[299,105],[299,105]],"oldText":"\n","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"u","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"n","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"R","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"o","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"u","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"C","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"l","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"a","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"=","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"o","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"u","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"C","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"l","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"a","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"[","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"o","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"u","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"r","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"c","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"C","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"l","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"a","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"s","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"I","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"n","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"d","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"e","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"x","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"]","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":";","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[300,0]],"newRange":[[299,105],[299,105]],"oldText":"\n","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"}","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[300,0]],"newRange":[[299,105],[299,105]],"oldText":"\n","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"i","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"f","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"(","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"!","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,105]],"newRange":[[299,105],[299,106]],"oldText":"","newText":"!"}},{"type":"change","content":{"oldRange":[[299,104],[299,105]],"newRange":[[299,104],[299,104]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[299,103],[299,104]],"newRange":[[299,103],[299,103]],"oldText":"|","newText":""}},{"type":"change","content":{"oldRange":[[299,103],[299,103]],"newRange":[[299,103],[299,104]],"oldText":"","newText":"|"}},{"type":"change","content":{"oldRange":[[299,104],[299,104]],"newRange":[[299,104],[299,105]],"oldText":"","newText":" "}},{"type":"change","content":{"oldRange":[[299,105],[299,105]],"newRange":[[299,105],[299,107]],"oldText":"","newText":"()"}},{"type":"change","content":{"oldRange":[[299,106],[299,107]],"newRange":[[299,106],[299,106]],"oldText":")","newText":""}},{"type":"change","content":{"oldRange":[[299,105],[299,106]],"newRange":[[299,105],[299,105]],"oldText":"(","newText":""}},{"type":"change","content":{"oldRange":[[299,7],[299,7]],"newRange":[[299,7],[299,9]],"oldText":"","newText":"()"}},{"type":"change","content":{"oldRange":[[299,8],[299,9]],"newRange":[[299,8],[299,8]],"oldText":")","newText":""}},{"type":"change","content":{"oldRange":[[299,102],[299,102]],"newRange":[[299,102],[299,103]],"oldText":"","newText":")"}},{"type":"change","content":{"oldRange":[[299,106],[299,106]],"newRange":[[299,106],[300,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[300,0],[300,0]],"newRange":[[300,0],[300,4]],"oldText":"","newText":"\t\t\t\t"}},{"type":"change","content":{"oldRange":[[300,5],[300,5]],"newRange":[[300,5],[300,6]],"oldText":"","newText":"\t"}},{"type":"change","content":{"oldRange":[[300,6],[300,6]],"newRange":[[300,6],[300,7]],"oldText":"","newText":"\t"}},{"type":"change","content":{"oldRange":[[299,51],[299,51]],"newRange":[[299,51],[299,52]],"oldText":"","newText":"\t"}},{"type":"change","content":{"oldRange":[[299,51],[299,52]],"newRange":[[299,51],[299,51]],"oldText":"\t","newText":""}},{"type":"change","content":{"oldRange":[[299,51],[299,51]],"newRange":[[299,51],[300,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[300,0],[300,0]],"newRange":[[300,0],[300,5]],"oldText":"","newText":"\t\t\t\t\t"}},{"type":"change","content":{"oldRange":[[300,5],[300,5]],"newRange":[[300,5],[300,6]],"oldText":"","newText":"\t"}},{"type":"change","content":{"oldRange":[[299,50],[299,51]],"newRange":[[299,50],[299,50]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[291,9],[291,9]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[291,0],[292,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[291,0],[292,0]],"newRange":[[291,0],[291,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> intervalsByResource', intervalsByResource);\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[291,0],[291,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[287,0],[288,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[287,0],[288,0]],"newRange":[[287,0],[287,0]],"oldText":"\t\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals::loop --> resource', resource);\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[287,0],[287,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[268,0],[269,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[268,0],[269,0]],"newRange":[[268,0],[268,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resourcesByClass', resourcesByClass);\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[268,0],[268,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[251,0],[252,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[251,0],[252,0]],"newRange":[[251,0],[251,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> resources', resources);\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[251,0],[251,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[251,0],[252,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[251,0],[252,0]],"newRange":[[251,0],[251,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> works', works);\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[251,0],[251,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[251,0],[252,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[251,0],[252,0]],"newRange":[[251,0],[251,0]],"oldText":"\t\t\tconsole.log('\\nResources::getAvailableIntervals::calcIntervals --> worksBusy', worksBusy);\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[251,0],[251,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[190,0],[191,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[190,0],[191,0]],"newRange":[[190,0],[190,0]],"oldText":"\t\tconsole.log('\\nResource::getAvailableIntervals --> resourceClasses', resourceClasses);\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[190,0],[190,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[348,0],[349,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":true,"tailed":true,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[348,0],[349,0]],"newRange":[[348,0],[348,0]],"oldText":"\t\t\t\tconsole.log('\\nResource::getAvailableIntervals else');\n","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[348,0],[348,0]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"checkpoint","id":799,"snapshot":{"2":{"1":{"range":[[340,15],[340,15]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}},"isBoundary":false},{"type":"group-start","snapshot":{"2":{"1":{"range":[[340,14],[340,14]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[340,14],[340,14]],"newRange":[[340,14],[340,15]],"oldText":"","newText":"."}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[340,15],[340,15]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[340,15],[340,15]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[340,15],[340,16]],"newRange":[[340,15],[340,15]],"oldText":"[","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[340,15],[340,15]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[340,16],[340,16]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[340,15],[340,16]],"newRange":[[340,15],[340,15]],"oldText":"'","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[340,15],[340,15]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[340,26],[340,26]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[340,26],[340,27]],"newRange":[[340,26],[340,26]],"oldText":"'","newText":""}},{"type":"change","content":{"oldRange":[[340,26],[340,27]],"newRange":[[340,26],[340,26]],"oldText":"]","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[340,26],[340,26]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[340,30],[340,30]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[340,30],[340,30]],"newRange":[[340,30],[341,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[341,0],[341,0]],"newRange":[[341,0],[341,5]],"oldText":"","newText":"\t\t\t\t\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[341,5],[341,5]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[341,13],[341,13]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[341,12],[341,13]],"newRange":[[341,12],[341,12]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[341,12],[341,12]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[341,12],[341,12]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[341,12],[341,12]],"newRange":[[341,12],[342,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[342,0],[342,0]],"newRange":[[342,0],[342,6]],"oldText":"","newText":"\t\t\t\t\t\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[342,6],[342,6]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[342,17],[342,17]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[342,16],[342,17]],"newRange":[[342,16],[342,16]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[342,16],[342,16]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[342,20],[342,20]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[342,20],[342,20]],"newRange":[[342,20],[343,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[343,0],[343,0]],"newRange":[[343,0],[343,7]],"oldText":"","newText":"\t\t\t\t\t\t\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[343,7],[343,7]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[343,15],[343,15]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[343,14],[343,15]],"newRange":[[343,14],[343,14]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[343,14],[343,14]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[343,19],[343,19]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[343,18],[343,19]],"newRange":[[343,18],[343,18]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[343,18],[343,18]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[343,26],[343,26]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[343,26],[343,26]],"newRange":[[343,26],[344,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[344,0],[344,0]],"newRange":[[344,0],[344,7]],"oldText":"","newText":"\t\t\t\t\t\t\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[344,7],[344,7]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[344,10],[344,10]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[344,10],[344,10]],"newRange":[[344,10],[344,11]],"oldText":"","newText":" "}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[344,11],[344,11]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[344,15],[344,15]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[344,14],[344,15]],"newRange":[[344,14],[344,14]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[344,14],[344,14]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[344,19],[344,19]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[344,18],[344,19]],"newRange":[[344,18],[344,18]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[344,18],[344,18]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[344,24],[344,24]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[344,23],[344,24]],"newRange":[[344,23],[344,23]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[344,23],[344,23]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[344,25],[344,25]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[344,25],[344,25]],"newRange":[[344,25],[345,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[345,0],[345,0]],"newRange":[[345,0],[345,6]],"oldText":"","newText":"\t\t\t\t\t\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[345,6],[345,6]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[345,8],[345,8]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[345,8],[345,8]],"newRange":[[345,8],[346,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[346,0],[346,0]],"newRange":[[346,0],[346,5]],"oldText":"","newText":"\t\t\t\t\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[346,5],[346,5]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[346,7],[346,7]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[346,7],[346,7]],"newRange":[[346,7],[347,0]],"oldText":"","newText":"\n"}},{"type":"change","content":{"oldRange":[[347,0],[347,0]],"newRange":[[347,0],[347,4]],"oldText":"","newText":"\t\t\t\t"}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[347,4],[347,4]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"group-start","snapshot":{"2":{"1":{"range":[[347,4],[347,4]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}},{"type":"change","content":{"oldRange":[[346,6],[346,7]],"newRange":[[346,6],[346,6]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[345,7],[345,8]],"newRange":[[345,7],[345,7]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[344,24],[344,25]],"newRange":[[344,24],[344,24]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[343,25],[343,26]],"newRange":[[343,25],[343,25]],"oldText":" ","newText":""}},{"type":"change","content":{"oldRange":[[342,19],[342,20]],"newRange":[[342,19],[342,19]],"oldText":" ","newText":""}},{"type":"group-end","snapshot":{"2":{"1":{"range":[[347,4],[347,4]],"properties":{"type":"selection","goalScreenRange":null,"clip":"forward","autoscroll":false,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}}}}],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/portal/common/model/Resource.js","digestWhenLastPersisted":"1100f46a4c047e13de5d9ea11955a35f63b71c53","preferredLineEnding":null,"nextMarkerId":3750,"deserializer":"TextBuffer","version":5},{"id":"edeeb1f64a82672c39b753df469f4bf8","text":"\"use strict\";\n\nvar mongoose = require('mongoose'),\n    when = require('promised-io/promise'),\n    events = require('../utils/shade'),\n    logger = require('../utils/logentries')(),\n\t_ = require('underscore');\n\nvar Name = 'BHAccount';\n\nvar WorkColorItem = new mongoose.Schema({\n    _id  : false,\n    type : {\n        type: String,\n        enum : [\n            'state',        // value is from work.state\n            'tag',          // value is in bhaccount.tags\n            'idResource',   // value = idResource\n            'category'      // value = category treatment\n        ],\n        default: 'tag'\n    },\n    value: String,\n    color: { type: String , default: \"#ff5357\" }\n});\n\nvar Schema = new mongoose.Schema({\n    path\t\t: String,\n    domainURL   : String,\n    domainEmail : String,\n    dateCreated : { type: Date },\n\n    lock        : Boolean,\n\n    /* modules */\n    modules     : [String], //[\"pet\", \"only-booking\"]\n\n    /* type */\n    trialDate: Date,\n    accountType : { type: String , default: \"free\" }, // free , premium ( 10 € ) , gold ( 30 € ) , free-booking\n    apiProvider : String, // BHApiProvider.identifier    -- Used in public API\n    leadby      : String, // BHApiProvider._id\n    portal      : String, // 1 , 0 , pending\n    demo        : { type: Boolean, default: false }, //Cuando hay datos de demostracion => true.\n\n    /* Behavioral */\n    initAction  : String, // Action that will be triggered in Bellahora init. Could be: 'offerum-assistant'\n\n    /* Data center */\n    name \t\t: String,\n    country     : { type: String, default: \"es\" },\n    postcode    : String,\n    province \t: Number, //DEPRECATED: Soon it will be deleted\n    town \t\t: Number, //DEPRECATED: Soon it will be deleted\n    address \t: String, //DEPRECATED: Soon it will be deleted\n    location    : {\n        stName   : String,\n        stNumber : String,\n        city     : String,\n        postcode : String,\n        geo      : { type: { type: String, default: 'Point' }, coordinates: { type: [ Number ], default: [0, 0] } },//lng, lat\n        transports : {\n            bus : [String],\n            railstation : [String],\n            metrostation : [String],\n            tramstop : [String]\n        }\n    },\n\n    phone \t\t: String,\n    email \t\t: String, //DEPRECATED: Soon it will be deleted\n    facebook    : String,\n    fbBooking   : [String], // URL of facebook page where is activated the booking system\n    web         : String,\n\n    /* Info */\n    title       : String,\n    description : String,\n    gallery     : Number, //Number of images in gallery\n\n    /* Polls configuration */\n    pcIdTreatments : [String],\n    pcCategories : [String],\n    pcEnabled  \t: { type: String, default: \"false\" }, /* DEPRECATED */\n    pcMessage \t: String, //DEPRECATED\n\n    /* Book configuration */\n    worktags: [String],\n    workcolors: [ WorkColorItem ],\n\n    /* SMS */\n    sms : { type: Number , default: 0 },\n    smsToPay: Number, // SMS that should be paid on the next subscription bill\n    smsToPayEnabled: Boolean,\n    smsFrom : String,\n    smsPriority : Number, // 0: Email , 1: SMS , 2: Email then SMS\n    bookSmsNumber: String,\n\n\n\n    /* Bill configuration */\n    personalTax     : { type: Number, default: 0}, // IRPF Things\n\n    taxtype         : { type: String, default: \"IVA\" }, //Updated automatically depending on province. (others: IGIC ( Las palmas, SCTenerife ) )\n    taxpercentages  : [ Number ],\n    taxcurrency     : { type: String, default: \"€\"},\n\n    taxname         : String,\n    taxcode         : String,\n\n    lastbill        : { type: Number , default: 0 },\n    serie           : String,\n\n    showBillReceipt : { type: String, default: \"billandreceipt\" }, //{ billandreceipt , bill, receipt, none }\n    boolAutoBill    : { type: String, default: \"false\" },\n\n    /* Cash select */\n    defaultCash     : { type: String, default: \"false\" }, // It could be \"false\" : no default cash, needs to be chosen. \"true\" : main selected. <id> : <id> cash selected.\n    cashertype      : { type: [String] },\n\n\n    wtp: { type: [String] , default: [\"creditcard\",\"cash\"] },\n\n    /*\n        Booking configuration\n        bc -> Booking cancel link Enabled\n     */\n    bc : { type: Number , default : 1 },\n\n    /*\n        Valorations\n        ve -> Valoration Stars Enabled\n    */\n    ve : { type: Number , default : 1 },\n\n    /*\n        Employee Log\n        le -> Employee Log Enabled\n    */\n    le : { type: Number , default : 0 },\n\n    /*\n        Notifications config\n        nw -> Notification Welcome\n        nr -> Notification Reminder\n    */\n    nw : { type: Number , default : 1 },\n    nr : { type: Number , default : 1 },\n    remHoursAgo: {type: Number, default: 6}, // Horas de antelación para recordar cita\n    notifyIfFromAgenda: {type:Boolean, default:false},\n\n    /*\n        Data client attributes\n        ci -> Client ID\n        cd -> Client DNI        <--------- DEPRECATED\n        ca -> Client address    <--------- DEPRECATED\n        cc -> Client CCPP       <--------- DEPRECATED\n        cp -> Client Phone      <--------- DEPRECATED\n    */\n    ci : { type: Number , default : 0 },\n    cd : { type: Number , default : 1 },\n    ca : { type: Number , default : 1 },\n    cc : { type: Number , default : 1 },\n    cp : { type: Number , default : 1 },\n\n    /*\n        Ticket config\n        tt: Ticket Text\n        tw: Ticket width\n        tf: Ticket Font Size\n        tm: Ticket Margin Left\n        tn: Show/Hide NIF\n        td: Show/Hide Address\n        tc: Show/Hide Center Name\n        tp: Show/Hide Client Information\n     */\n    tt : String, //Text at the end of the ticket\n    tw : { type: Number, default: 54 },\n    tf : { type: Number, default: 5 },\n    tm : { type: Number, default: 0 }, //Margin left applied\n    tn : { type: Number, default: 1 }, //Show NIF or not\n    td : { type: Number, default: 1 }, //Show address or not\n    tc : { type: Number, default: 1 }, //Show name center or not\n    tp : { type: Number, default: 0 },\n    ta : { type: Number, default: 0 }, //Atendido por\n\n    loyalityPrograms : [ String ],                  //En que programas de fidelizacion participa. De momento tendremos el 'bookingReward', un % de pasta\n    accountGroup : {type : String, index: true },   //Los que comparten este identificador, comparten Clients y ya veremos si Treatments y Works\n    bookingEngineVersion : { type: Number, default: 2 },        //De momento nada o < 2 es antiguo, 2 es el nuevo\n\n    LS_clients: {type: Boolean,  default: true},     //LocalStorage Clients\n\n    podio_item_id : String,\n    affiliationCost   : {\n        tracking : String,\n        idAffiliate : String,\n        cost: Number\n    },\n\n    /** THEME PREMIUM GOLD */\n    pg_c: { type: String, default: 'ff5357' }, //CSS Color\n    pg_l: { type: String }, //Logo app\n    pg_b: { type: String , default: 'fff' }, //Background header\n    pg_f: { type: String , default: '404040' }, //Font color in header\n\n    /** COMERCIAL ASIGNADO **/\n    idUserLead: String,\n    dateAssigned: Date,\n\n    // Materialized attributes\n    score: { type: Number, default: 0 },\n    scoreCount: { type: Number, default: 0 },\n    active: Boolean,\n\n    /* Formas de pago de portal\n        creditcard: permite pagos con tarjeta\n        direct: permite que se pague en el centro\n    */\n    waysToPay: {type: [String], default: ['direct']},\n    certified: {type:Boolean, default:false},\n\n    // Online Payment agreement\n    onPayAgreement: {type:Boolean, default:false},\n\n    bankAccount: {\n        holder: String, //titular\n        swift: String, // swift code\n        bank: String, // banco\n        office: String,\n        dc: String,\n        number: String, // cuenta\n        iban: String\n    },\n\n    cifnif: String,\n    bic: String,\n    iban: String,\n    commission: Number\n});\n\nSchema.index({ 'location.geo' : '2dsphere'} );\nSchema.index({ path: 1 });\nSchema.index({ 'locaiton.postcode': 1 });\n\n\nSchema.methods.getIBAN = function (cc) {\n  if (this.bankAccount){\n    if (this.bankAccount.iban) {\n        return this.bankAccount.iban;\n    } else {\n        return this.bankAccount.bank + this.bankAccount.office + this.bankAccount.dc + this.bankAccount.number;\n    }\n  }\n  return this.iban || '';\n};\n\n\nSchema.post( 'init' , function( doc ) {\n    if(this['toObject'])\n        this._original = this.toObject();\n});\n\n//Los centros que hemos importado, si activan el portal los desmarcamos como importados\nSchema.pre( 'save' , function( next ) {\n    // Save date when its assignated to a commercial if not exist\n    if( this.idUserLead && (!this._original || !this._original.idUserLead) ) {\n        this.dateAssigned = new Date();\n    }\n\n\n    // Save date when its assignated to a commercial if change\n    if(this.idUserLead && this._original && this._original.idUserLead && this.idUserLead != this._original.idUserLead) {\n        this.dateAssigned = new Date();\n    }\n\n    var modules = this.modules||[];\n    //Comprobando tanto leadby como forced no interifere en el script de importacion, por si hacemos algo paracido con groupalia\n    if(this.portal == \"1\" && this.leadby == \"55656795f3a2e948ac23cf67\" && modules.indexOf('forced') >= 0) {\n        this.leadby = \"\";\n        this.modules = _.without(modules, \"forced\");\n    }\n    next();\n});\n\n\nSchema.post('save', function(){\n    var portalActivation = this.portal == \"1\" && (!this._original || this._original.portal != \"1\");\n    var portalDeactivation = this.portal != \"1\" && this._original && this._original.portal == \"1\";\n    var accountTypeChange = (this.accountType && (!this._original || !this._original.accountType)) ||\n                            (this.accountType != this._original.accountType);\n\n    if(portalActivation || portalDeactivation) {\n        this.getPortalLocation(function(err, location){\n            events.insert({\n                name:\"change-portal-flag\",\n                id: this.id,\n                data:{\n                    portal:this.portal,\n                    manual:true\n                }\n            });\n\n            require('./StatsEvent.js').model().create({\n                _idBHAccount : this.id,\n                idLocation : location ?  location.id : null,\n                type : portalActivation ? 'centrePortalActivation' : 'centrePortalDeactivation'\n            });\n        }.bind(this));\n    }\n\n    if(accountTypeChange) {\n        events.insert({\n            name:\"accountType-change\",\n            id: this.id,\n            data:{\n                accountType:this.accountType\n            }\n        });\n    }\n});\n\nSchema.post('remove', function(account){\n    if(account.portal == \"1\") {\n        account.getPortalLocation(function(location){\n            require('./StatsEvent.js').model().create({\n                _idBHAccount : account.id,\n                idLocation : location.id,\n                type : 'centrePortalDeactivation'\n            });\n        });\n    }\n});\n\nSchema.methods.getPortalLocation = function getPortalLocation(callback){\n    if(!this.location || !this.location.geo){\n        var p = when.Deferred();\n        p.resolve(p);\n        if(callback)\n            callback(null, null);\n        return p;\n    }\n    return require('./Location.js').model().getLocation(this.location.geo.coordinates[1], this.location.geo.coordinates[0], true, callback);\n};\n\nmodule.exports = {\n\tschema: function() {  return Schema; },\n\tmodel: \tfunction() {  return mongoose.model(Name, Schema); }\n}\n","defaultMarkerLayerId":"0","markerLayers":{"0":{"id":"0","maintainHistory":false,"markersById":{"2":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"5":{"range":{"start":{"row":0,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"6":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"7":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"8":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"9":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"10":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"11":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"12":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"13":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"14":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"15":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"16":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"26":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"27":{"range":{"start":{"row":0,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"28":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"29":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"30":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"31":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"32":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"33":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"34":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"35":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"36":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"37":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"38":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":false,"invalidate":"inside"},"49":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"50":{"range":{"start":{"row":0,"column":12},"end":{"row":0,"column":13}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"51":{"range":{"start":{"row":23,"column":46},"end":{"row":23,"column":48}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"52":{"range":{"start":{"row":39,"column":110},"end":{"row":39,"column":111}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"53":{"range":{"start":{"row":46,"column":106},"end":{"row":46,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"54":{"range":{"start":{"row":60,"column":125},"end":{"row":60,"column":126}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"55":{"range":{"start":{"row":103,"column":144},"end":{"row":103,"column":145}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"56":{"range":{"start":{"row":113,"column":108},"end":{"row":113,"column":109}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"57":{"range":{"start":{"row":117,"column":169},"end":{"row":117,"column":170}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"58":{"range":{"start":{"row":186,"column":151},"end":{"row":186,"column":152}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"59":{"range":{"start":{"row":187,"column":143},"end":{"row":187,"column":144}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"60":{"range":{"start":{"row":188,"column":112},"end":{"row":188,"column":113}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"61":{"range":{"start":{"row":39,"column":50},"end":{"row":39,"column":111}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"62":{"range":{"start":{"row":50,"column":47},"end":{"row":50,"column":50}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"63":{"range":{"start":{"row":83,"column":53},"end":{"row":83,"column":70}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"64":{"range":{"start":{"row":103,"column":52},"end":{"row":103,"column":145}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"65":{"range":{"start":{"row":105,"column":50},"end":{"row":105,"column":52}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"66":{"range":{"start":{"row":113,"column":63},"end":{"row":113,"column":109}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"67":{"range":{"start":{"row":114,"column":54},"end":{"row":114,"column":57}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"68":{"range":{"start":{"row":117,"column":54},"end":{"row":117,"column":170}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"69":{"range":{"start":{"row":121,"column":50},"end":{"row":121,"column":61}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"70":{"range":{"start":{"row":121,"column":57},"end":{"row":121,"column":61}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"71":{"range":{"start":{"row":190,"column":0},"end":{"row":190,"column":75}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"72":{"range":{"start":{"row":192,"column":0},"end":{"row":192,"column":27}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"73":{"range":{"start":{"row":200,"column":0},"end":{"row":200,"column":58}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"74":{"range":{"start":{"row":201,"column":0},"end":{"row":201,"column":38}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"75":{"range":{"start":{"row":202,"column":0},"end":{"row":202,"column":64}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"76":{"range":{"start":{"row":203,"column":0},"end":{"row":203,"column":70}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"77":{"range":{"start":{"row":250,"column":110},"end":{"row":250,"column":111}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"78":{"range":{"start":{"row":245,"column":35},"end":{"row":245,"column":40}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"79":{"range":{"start":{"row":258,"column":11},"end":{"row":258,"column":24}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"80":{"range":{"start":{"row":259,"column":8},"end":{"row":259,"column":41}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"81":{"range":{"start":{"row":257,"column":32},"end":{"row":257,"column":39}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"82":{"range":{"start":{"row":271,"column":119},"end":{"row":271,"column":120}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"83":{"range":{"start":{"row":271,"column":91},"end":{"row":271,"column":120}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"84":{"range":{"start":{"row":276,"column":127},"end":{"row":276,"column":128}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"85":{"range":{"start":{"row":277,"column":106},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"86":{"range":{"start":{"row":277,"column":25},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"87":{"range":{"start":{"row":277,"column":21},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"88":{"range":{"start":{"row":277,"column":70},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"89":{"range":{"start":{"row":277,"column":43},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"90":{"range":{"start":{"row":278,"column":24},"end":{"row":278,"column":25}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"91":{"range":{"start":{"row":279,"column":50},"end":{"row":279,"column":52}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"92":{"range":{"start":{"row":286,"column":45},"end":{"row":286,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"93":{"range":{"start":{"row":286,"column":41},"end":{"row":286,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"94":{"range":{"start":{"row":286,"column":97},"end":{"row":286,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"95":{"range":{"start":{"row":286,"column":93},"end":{"row":286,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"96":{"range":{"start":{"row":287,"column":47},"end":{"row":287,"column":98}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"97":{"range":{"start":{"row":287,"column":43},"end":{"row":287,"column":98}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"98":{"range":{"start":{"row":287,"column":97},"end":{"row":287,"column":98}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"99":{"range":{"start":{"row":287,"column":93},"end":{"row":287,"column":98}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"102":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"overlap"},"104":{"range":{"start":{"row":0,"column":12},"end":{"row":0,"column":13}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"105":{"range":{"start":{"row":23,"column":46},"end":{"row":23,"column":48}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"106":{"range":{"start":{"row":39,"column":110},"end":{"row":39,"column":111}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"107":{"range":{"start":{"row":46,"column":106},"end":{"row":46,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"108":{"range":{"start":{"row":60,"column":125},"end":{"row":60,"column":126}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"109":{"range":{"start":{"row":103,"column":144},"end":{"row":103,"column":145}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"110":{"range":{"start":{"row":113,"column":108},"end":{"row":113,"column":109}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"111":{"range":{"start":{"row":117,"column":169},"end":{"row":117,"column":170}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"112":{"range":{"start":{"row":186,"column":151},"end":{"row":186,"column":152}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"113":{"range":{"start":{"row":187,"column":143},"end":{"row":187,"column":144}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"114":{"range":{"start":{"row":188,"column":112},"end":{"row":188,"column":113}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"115":{"range":{"start":{"row":39,"column":50},"end":{"row":39,"column":111}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"116":{"range":{"start":{"row":50,"column":47},"end":{"row":50,"column":50}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"117":{"range":{"start":{"row":83,"column":53},"end":{"row":83,"column":70}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"118":{"range":{"start":{"row":103,"column":52},"end":{"row":103,"column":145}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"119":{"range":{"start":{"row":105,"column":50},"end":{"row":105,"column":52}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"120":{"range":{"start":{"row":113,"column":63},"end":{"row":113,"column":109}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"121":{"range":{"start":{"row":114,"column":54},"end":{"row":114,"column":57}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"122":{"range":{"start":{"row":117,"column":54},"end":{"row":117,"column":170}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"123":{"range":{"start":{"row":121,"column":50},"end":{"row":121,"column":61}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"124":{"range":{"start":{"row":121,"column":57},"end":{"row":121,"column":61}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"125":{"range":{"start":{"row":190,"column":0},"end":{"row":190,"column":75}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"126":{"range":{"start":{"row":192,"column":0},"end":{"row":192,"column":27}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"127":{"range":{"start":{"row":200,"column":0},"end":{"row":200,"column":58}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"128":{"range":{"start":{"row":201,"column":0},"end":{"row":201,"column":38}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"129":{"range":{"start":{"row":202,"column":0},"end":{"row":202,"column":64}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"130":{"range":{"start":{"row":203,"column":0},"end":{"row":203,"column":70}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"131":{"range":{"start":{"row":250,"column":110},"end":{"row":250,"column":111}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"132":{"range":{"start":{"row":245,"column":35},"end":{"row":245,"column":40}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"133":{"range":{"start":{"row":258,"column":11},"end":{"row":258,"column":24}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"134":{"range":{"start":{"row":259,"column":8},"end":{"row":259,"column":41}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"135":{"range":{"start":{"row":257,"column":32},"end":{"row":257,"column":39}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"136":{"range":{"start":{"row":271,"column":119},"end":{"row":271,"column":120}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"137":{"range":{"start":{"row":271,"column":91},"end":{"row":271,"column":120}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"138":{"range":{"start":{"row":276,"column":127},"end":{"row":276,"column":128}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"139":{"range":{"start":{"row":277,"column":106},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"140":{"range":{"start":{"row":277,"column":25},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"141":{"range":{"start":{"row":277,"column":21},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"142":{"range":{"start":{"row":277,"column":70},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"143":{"range":{"start":{"row":277,"column":43},"end":{"row":277,"column":107}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"144":{"range":{"start":{"row":278,"column":24},"end":{"row":278,"column":25}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"145":{"range":{"start":{"row":279,"column":50},"end":{"row":279,"column":52}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"146":{"range":{"start":{"row":286,"column":45},"end":{"row":286,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"147":{"range":{"start":{"row":286,"column":41},"end":{"row":286,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"148":{"range":{"start":{"row":286,"column":97},"end":{"row":286,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"149":{"range":{"start":{"row":286,"column":93},"end":{"row":286,"column":99}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"150":{"range":{"start":{"row":287,"column":47},"end":{"row":287,"column":98}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"151":{"range":{"start":{"row":287,"column":43},"end":{"row":287,"column":98}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"152":{"range":{"start":{"row":287,"column":97},"end":{"row":287,"column":98}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"},"153":{"range":{"start":{"row":287,"column":93},"end":{"row":287,"column":98}},"properties":{},"reversed":false,"tailed":true,"valid":true,"invalidate":"inside"}},"version":2},"1":{"id":"1","maintainHistory":false,"markersById":{},"version":2},"2":{"id":"2","maintainHistory":true,"markersById":{"1":{"range":{"start":{"row":0,"column":0},"end":{"row":0,"column":0}},"properties":{"type":"selection","goalScreenRange":null,"preserveFolds":true},"reversed":false,"tailed":false,"valid":true,"invalidate":"never"}},"version":2},"3":{"id":"3","maintainHistory":false,"markersById":{"3":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":false,"invalidate":"touch"},"4":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":false,"invalidate":"touch"}},"version":2},"5":{"id":"5","maintainHistory":false,"markersById":{},"version":2},"6":{"id":"6","maintainHistory":false,"markersById":{},"version":2},"7":{"id":"7","maintainHistory":false,"markersById":{"18":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":false,"invalidate":"touch"},"19":{"range":{"start":{"row":348,"column":0},"end":{"row":348,"column":0}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":false,"invalidate":"touch"}},"version":2},"9":{"id":"9","maintainHistory":false,"markersById":{},"version":2},"10":{"id":"10","maintainHistory":false,"markersById":{},"version":2},"18":{"id":"18","maintainHistory":false,"markersById":{},"version":2},"19":{"id":"19","maintainHistory":false,"markersById":{"103":{"range":{"start":{"row":23,"column":38},"end":{"row":23,"column":45}},"properties":{"type":"pigments-color"},"reversed":false,"tailed":true,"valid":true,"invalidate":"touch"}},"version":2},"27":{"id":"27","maintainHistory":false,"markersById":{},"version":2}},"nextMarkerLayerId":28,"history":{"version":3,"nextCheckpointId":2,"undoStack":[],"redoStack":[]},"encoding":"utf8","filePath":"/home/bellahora-04/Bellahora/portal/common/model/BHAccount.js","digestWhenLastPersisted":"3003a664e496048fbf5cd6ba170679f37ffd3517","preferredLineEnding":null,"nextMarkerId":154,"deserializer":"TextBuffer","version":5}]},"workspace":{"deserializer":"Workspace","paneContainer":{"deserializer":"PaneContainer","version":1,"root":{"deserializer":"Pane","id":3,"items":[{"deserializer":"TextEditor","id":136,"softTabs":false,"firstVisibleScreenRow":53,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":137,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/portal/controller/WorkController.js","bufferId":"7936cbac2503fb9b2c58343de44271d3","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":144,"softTabs":true,"firstVisibleScreenRow":238,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":145,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/portal/common/model/Treatment.js","bufferId":"5b5b6e90a835c3b7ce43d245343f592f","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":148,"softTabs":false,"firstVisibleScreenRow":188,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":149,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/portal/common/model/Resource.js","bufferId":"27d39d361a2322e4d865293ace2ce2bb","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"},{"deserializer":"TextEditor","id":166,"softTabs":true,"firstVisibleScreenRow":0,"firstVisibleScreenColumn":0,"displayBuffer":{"deserializer":"DisplayBuffer","id":167,"softWrapped":true,"tokenizedBuffer":{"deserializer":"TokenizedBuffer","bufferPath":"/home/bellahora-04/Bellahora/portal/common/model/BHAccount.js","bufferId":"edeeb1f64a82672c39b753df469f4bf8","largeFileMode":false},"largeFileMode":false,"foldsMarkerLayerId":"1"},"selectionsMarkerLayerId":"2"}],"activeItemURI":"/home/bellahora-04/Bellahora/portal/common/model/BHAccount.js","focused":true,"flexScale":1},"activePaneId":3},"packagesWithActiveGrammars":["language-javascript-better","language-hyperlink","language-todo"],"destroyedItemURIs":["atom://config/updates","/home/bellahora-04/Bellahora/portal/resources/views/user.html","/home/bellahora-04/Bellahora/portal/resources/views/userBookings.html","/home/bellahora-04/Bellahora/portal/painter/UserPainter.js","/home/bellahora-04/Bellahora/portal/resources/views/userSidebar.html","/home/bellahora-04/Bellahora/portal/resources/views/userFavCenters.html","/home/bellahora-04/Bellahora/portal/static/css/user.css","/home/bellahora-04/Bellahora/portal/common/model/TreatmentAvailability.js","/home/bellahora-04/Bellahora/portal/routings/api/booking.js","/home/bellahora-04/Bellahora/portal/common/model/BHAccountExtended.js"]},"packageStates":{"pigments":{"project":{"deserializer":"ColorProject","timestamp":"2016-04-12T08:10:43.142Z","version":"1.0.1","markersVersion":"1.0.6","globalSourceNames":["**/*.styl","**/*.stylus","**/*.less","**/*.sass","**/*.scss"],"globalIgnoredNames":["vendor/*","node_modules/*","spec/*","test/*"],"buffers":{"136":{"id":136,"path":"/home/bellahora-04/Bellahora/portal/controller/WorkController.js","colorMarkers":[]},"144":{"id":144,"path":"/home/bellahora-04/Bellahora/portal/common/model/Treatment.js","colorMarkers":[]},"148":{"id":148,"path":"/home/bellahora-04/Bellahora/portal/common/model/Resource.js","colorMarkers":[]},"166":{"id":166,"path":"/home/bellahora-04/Bellahora/portal/common/model/BHAccount.js","colorMarkers":[{"markerId":"103","bufferRange":[[23,38],[23,45]],"color":[255,83,87,1],"text":"#ff5357","variables":[]}]}},"paths":["/home/bellahora-04/Bellahora/portal/static/css/basics.less","/home/bellahora-04/Bellahora/portal/static/css/basics_ui.less","/home/bellahora-04/Bellahora/portal/static/css/variables.less","/home/bellahora-04/Bellahora/portal/static/css/mobile-filters.less"],"variables":{"deserializer":"VariablesCollection","content":[{"name":"@params","value":"all ease 0.3s","path":"/home/bellahora-04/Bellahora/portal/static/css/basics.less","range":[4818,4840],"line":199},{"name":"@host","value":"\"s3\"","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[21,33],"line":1},{"name":"@color-strong","value":"#8062A4","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[45,67],"line":4,"isColor":true,"color":[128,98,164,1],"variables":[]},{"name":"@color-light","value":"mix( @color-strong , #fff , 20% )","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[69,116],"line":5,"isColor":true,"color":[229,223,236,1],"variables":[]},{"name":"@font-primary","value":"'Open Sans'","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[127,153],"line":8},{"name":"@font-title","value":"'Open Sans'","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[155,179],"line":9},{"name":"@color-primary","value":"#ff0b6d","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[202,225],"line":13,"isColor":true,"color":[255,11,109,1],"variables":[]},{"name":"@text-color","value":"#757575","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[228,248],"line":15,"isColor":true,"color":[117,117,117,1],"variables":[]},{"name":"@soft-text-color","value":"#747474","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[251,275],"line":17,"isColor":true,"color":[116,116,116,1],"variables":[]},{"name":"@hover-gray","value":"#A9A9A9","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[278,298],"line":19,"isColor":true,"color":[169,169,169,1],"variables":[]},{"name":"@gray-light","value":"#ccc","path":"/home/bellahora-04/Bellahora/portal/static/css/variables.less","range":[301,317],"line":21,"isColor":true,"color":[204,204,204,1],"variables":[]}]}}},"fuzzy-finder":{"/home/bellahora-04/Bellahora/portal/controller/WorkController.js":1456317414025,"/home/bellahora-04/Bellahora/portal/common/model/Treatment.js":1456317421111,"/home/bellahora-04/Bellahora/portal/common/model/Resource.js":1456317434032,"/home/bellahora-04/Bellahora/portal/common/model/BHAccount.js":1460440890810},"metrics":{"sessionLength":7752022},"tabs":[{"previewTabURI":"/home/bellahora-04/Bellahora/portal/common/model/BHAccount.js"}],"tree-view":{"directoryExpansionStates":{"/home/bellahora-04/Bellahora/portal":{"isExpanded":true,"entries":{".git":{"isExpanded":false,"entries":{}},"certificates":{"isExpanded":false,"entries":{}},"cmd":{"isExpanded":false,"entries":{}},"common":{"isExpanded":true,"entries":{"controller":{"isExpanded":false,"entries":{}},"model":{"isExpanded":true,"entries":{"abstract":{"isExpanded":false,"entries":{}},"mapping":{"isExpanded":false,"entries":{}}}},"utils":{"isExpanded":false,"entries":{}}}},"controller":{"isExpanded":true,"entries":{"abstract":{"isExpanded":false,"entries":{}}}},"helpers":{"isExpanded":false,"entries":{}},"middlewares":{"isExpanded":false,"entries":{}},"node_modules":{"isExpanded":false,"entries":{}},"painter":{"isExpanded":false,"entries":{}},"resources":{"isExpanded":false,"entries":{}},"routings":{"isExpanded":true,"entries":{"api":{"isExpanded":true,"entries":{}},"helpers":{"isExpanded":false,"entries":{}}}},"static":{"isExpanded":false,"entries":{}},"tmp":{"isExpanded":false,"entries":{}}}}},"selectedPath":"/home/bellahora-04/Bellahora/portal/common/model/BHAccount.js","hasFocus":false,"attached":true,"scrollLeft":0,"scrollTop":0,"width":162},"find-and-replace":{"findOptions":{"findPattern":"","replacePattern":"","pathsPattern":"","useRegex":false,"wholeWord":false,"caseSensitive":false,"inCurrentSelection":false},"findHistory":["res.send","when","User","this","UserAgent","preUserModel","LogUser","req.uuser","req.user","add","login"],"replaceHistory":["that"],"pathsHistory":["that"]},"linter":{"scope":"File"},"keybinding-resolver":{}},"fullScreen":false}